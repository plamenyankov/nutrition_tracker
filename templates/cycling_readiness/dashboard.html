{% extends 'layout.html' %}

{% block title %}Zyra Cycle - Cycling & Readiness{% endblock %}

{% block head %}
<style>
    /* ============== CSS Variables & Color Roles ============== */
    :root {
        --color-teal: #00FFC6;      /* Primary UI */
        --color-blue: #0077FF;       /* Sleep/Recovery */
        --color-green: #00E676;      /* Power/Performance */
        --color-red: #FF5252;        /* Warnings/Low */
        --color-yellow: #FFC107;     /* Moderate */
        --color-muted: rgba(255, 255, 255, 0.4);
        --color-muted-light: rgba(255, 255, 255, 0.6);
    }

    /* ============== Layout & Container ============== */
    .cycle-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 0.75rem;
    }

    @media (min-width: 768px) {
        .cycle-container {
            padding: 0 1.5rem;
        }
    }

    /* ============== Hero Section (Compact) ============== */
    .cycle-hero {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.12) 0%, rgba(0, 255, 198, 0.08) 100%);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(0, 255, 198, 0.15);
    }

    .cycle-hero h1 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 800;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0;
    }

    .cycle-hero .subtitle {
        font-size: 0.8rem;
        color: var(--color-muted-light);
        margin: 0;
    }

    .date-badge {
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-teal);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* ============== Stats Grid (Compact) ============== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    @media (min-width: 640px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .stat-card {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 0.75rem 0.5rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: var(--color-teal);
        transform: translateY(-1px);
    }

    .stat-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-green);
    }

    .stat-value.tss { color: var(--color-yellow); }
    .stat-value.time { color: var(--color-blue); }

    .stat-label {
        color: var(--color-muted);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.125rem;
    }

    /* ============== Tabs ============== */
    .cycle-tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .cycle-tab {
        position: relative;
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        color: var(--color-muted);
        font-weight: 600;
        font-size: 0.85rem;
        font-family: 'Montserrat', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .cycle-tab::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        width: 0;
        height: 2px;
        background: var(--color-teal);
        transition: all 0.3s ease;
        transform: translateX(-50%);
        border-radius: 2px;
    }

    .cycle-tab:hover {
        color: rgba(255, 255, 255, 0.8);
    }

    .cycle-tab:hover::after {
        width: 30%;
    }

    .cycle-tab.active {
        color: var(--color-teal);
        text-shadow: 0 0 20px rgba(0, 255, 198, 0.3);
    }

    .cycle-tab.active::after {
        width: 60%;
        box-shadow: 0 0 8px rgba(0, 255, 198, 0.5);
    }

    .cycle-tab i {
        margin-right: 0.5rem;
        transition: color 0.3s ease;
    }

    .cycle-tab.active i {
        color: var(--color-teal);
    }

    .cycle-tab[data-tab="readiness"] i {
        color: var(--color-blue);
    }

    .cycle-tab[data-tab="readiness"].active i {
        color: var(--color-blue);
        text-shadow: 0 0 10px rgba(0, 119, 255, 0.5);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ============== Section Cards (Compact) ============== */
    .section-card {
        background: rgba(26, 26, 26, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .section-title {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--color-teal);
        font-size: 0.85rem;
    }

    .section-title.power i { color: var(--color-green); }
    .section-title.sleep i { color: var(--color-blue); }

    /* ============== Grid Layouts ============== */
    .flex-layout {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (min-width: 992px) {
        .flex-layout {
            flex-direction: row;
        }

        .flex-layout > .flex-col-main {
            flex: 1;
            min-width: 0;
        }

        .flex-layout > .flex-col-side {
            width: 380px;
            flex-shrink: 0;
        }
    }

    /* ============== Upload Zone (Compact) ============== */
    .upload-zone {
        border: 2px dashed rgba(0, 255, 198, 0.25);
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 255, 198, 0.02);
    }

    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.06);
    }

    .upload-zone i {
        font-size: 2rem;
        color: var(--color-teal);
        margin-bottom: 0.5rem;
    }

    .upload-zone .title {
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.25rem;
    }

    .upload-zone .hint {
        color: var(--color-muted);
        font-size: 0.75rem;
    }

    /* File list */
    .file-list {
        margin-top: 0.75rem;
        max-height: 120px;
        overflow-y: auto;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.5rem;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        margin-bottom: 0.375rem;
        font-size: 0.8rem;
    }

    .file-item i { color: var(--color-teal); font-size: 0.75rem; }
    .file-item .filename {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--color-muted-light);
    }

    .file-item .remove-file {
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.125rem;
        font-size: 0.7rem;
    }

    .file-item .remove-file:hover { color: var(--color-red); }

    /* ============== Status Messages ============== */
    .status-msg {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        margin-top: 0.75rem;
    }

    .status-msg.loading {
        background: rgba(0, 255, 198, 0.1);
        color: var(--color-teal);
        border: 1px solid rgba(0, 255, 198, 0.2);
    }

    .status-msg.success {
        background: rgba(0, 230, 118, 0.1);
        color: var(--color-green);
        border: 1px solid rgba(0, 230, 118, 0.2);
    }

    .status-msg.error {
        background: rgba(255, 82, 82, 0.1);
        color: var(--color-red);
        border: 1px solid rgba(255, 82, 82, 0.2);
    }

    .status-msg i { font-size: 0.9rem; }

    /* ============== Empty States ============== */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--color-muted);
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin: 0;
    }

    .empty-state.power i { color: var(--color-green); }
    .empty-state.sleep i { color: var(--color-blue); }

    /* ============== Data Table (Compact) ============== */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -0.5rem;
        padding: 0 0.5rem;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .data-table th {
        color: var(--color-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
        white-space: nowrap;
    }

    .data-table td {
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        font-family: 'Roboto Mono', monospace;
        white-space: nowrap;
    }

    .data-table tr:hover {
        background: rgba(0, 255, 198, 0.03);
    }

    /* Placeholder values */
    .val-empty {
        color: var(--color-muted);
        font-size: 0.7rem;
    }

    .val-power { color: var(--color-green); }
    .val-hr { color: var(--color-red); }
    .val-tss { color: var(--color-yellow); }
    .val-time { color: var(--color-blue); }

    /* ============== Score Badge ============== */
    .score-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
    }

    .score-high { background: rgba(0, 230, 118, 0.2); color: var(--color-green); }
    .score-medium { background: rgba(255, 193, 7, 0.2); color: var(--color-yellow); }
    .score-low { background: rgba(255, 82, 82, 0.2); color: var(--color-red); }

    /* ============== Form Controls (Compact) ============== */
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.06);
        border-color: var(--color-teal);
        box-shadow: 0 0 0 2px rgba(0, 255, 198, 0.1);
        color: white;
    }

    .form-label {
        color: var(--color-muted-light);
        font-weight: 500;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    /* ============== Rating & Status Selectors ============== */
    .rating-selector, .status-selector {
        display: flex;
        gap: 0.25rem;
    }

    .rating-option, .status-option {
        flex: 1;
        padding: 0.4rem 0.25rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        color: var(--color-muted);
        font-size: 0.8rem;
    }

    .rating-option:hover, .status-option:hover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.08);
    }

    .rating-option.selected {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.15);
        color: var(--color-teal);
    }

    .rating-option input, .status-option input { display: none; }

    .status-option.negative { color: var(--color-red); }
    .status-option.neutral { color: var(--color-yellow); }
    .status-option.positive { color: var(--color-teal); }

    .status-option.selected.negative { background: rgba(255, 82, 82, 0.15); border-color: var(--color-red); }
    .status-option.selected.neutral { background: rgba(255, 193, 7, 0.15); border-color: var(--color-yellow); }
    .status-option.selected.positive { background: rgba(0, 255, 198, 0.15); border-color: var(--color-teal); }

    /* ============== Buttons ============== */
    .btn-zyra {
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    .btn-zyra:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 119, 255, 0.3);
        color: white;
    }

    .btn-zyra:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Delete button */
    .btn-delete {
        background: transparent;
        border: none;
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }

    .btn-delete:hover {
        color: var(--color-red);
        background: rgba(255, 82, 82, 0.1);
    }

    /* ============== Chart Container ============== */
    .chart-container {
        position: relative;
        height: 220px;
    }

    @media (min-width: 768px) {
        .chart-container { height: 250px; }
    }

    .chart-container.compact {
        height: 180px;
    }

    /* ============== Loading Overlay ============== */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active { display: flex; }

    .spinner-zyra {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 255, 198, 0.2);
        border-top-color: var(--color-teal);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
        color: white;
        margin-top: 0.75rem;
        font-size: 0.85rem;
    }

    /* ============== Toast ============== */
    .toast-container {
        position: fixed;
        top: 70px;
        right: 0.75rem;
        z-index: 9999;
        max-width: 320px;
    }

    .toast-zyra {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid var(--color-teal);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        color: white;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        animation: slideIn 0.3s ease;
    }

    .toast-zyra.error { border-color: var(--color-red); }
    .toast-zyra.success { border-color: var(--color-green); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ============== Confirm Modal ============== */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .confirm-modal.active { display: flex; }

    .confirm-dialog {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 1.25rem;
        max-width: 320px;
        width: 90%;
        text-align: center;
    }

    .confirm-dialog h4 {
        color: white;
        font-size: 1rem;
        margin-bottom: 0.375rem;
    }

    .confirm-dialog p {
        color: var(--color-muted);
        font-size: 0.8rem;
        margin-bottom: 1.25rem;
    }

    .confirm-actions {
        display: flex;
        gap: 0.5rem;
    }

    .confirm-actions button {
        flex: 1;
    }

    /* ============== Large Modal Base (Review, Edit, Day View) ============== */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem 1rem;
        overflow-y: auto;
    }

    .modal-overlay.active { display: flex; }

    .modal-content {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: white;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--color-muted);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.25rem;
    }

    .modal-close:hover { color: white; }

    .modal-body { margin-bottom: 1.25rem; }

    .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    /* ============== Form Fields in Modals ============== */
    .modal-form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1rem;
    }

    @media (max-width: 500px) {
        .modal-form-grid { grid-template-columns: 1fr; }
    }

    .modal-field {
        display: flex;
        flex-direction: column;
    }

    .modal-field label {
        font-size: 0.75rem;
        color: var(--color-muted-light);
        margin-bottom: 0.25rem;
    }

    .modal-field input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        color: white;
        font-size: 0.85rem;
    }

    .modal-field input:focus {
        outline: none;
        border-color: var(--color-teal);
    }

    .modal-field input.missing {
        border-color: var(--color-yellow);
        background: rgba(255, 193, 7, 0.1);
    }

    .modal-field input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .modal-field-full { grid-column: span 2; }

    @media (max-width: 500px) {
        .modal-field-full { grid-column: span 1; }
    }

    /* ============== Section Headers in Modals ============== */
    .modal-section {
        margin-bottom: 1.25rem;
    }

    .modal-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-teal);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-section-title.power { color: var(--color-green); }
    .modal-section-title.sleep { color: var(--color-blue); }
    .modal-section-title.warning { color: var(--color-yellow); }

    /* ============== Review Modal Cards ============== */
    .review-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .review-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .review-card-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .review-card-type.cycling { color: var(--color-green); }
    .review-card-type.sleep { color: var(--color-blue); }

    .review-missing-badge {
        background: rgba(255, 193, 7, 0.2);
        color: var(--color-yellow);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    /* ============== Day View Panels ============== */
    .day-panel {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .day-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .day-panel-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .day-panel-title.cycling { color: var(--color-green); }
    .day-panel-title.readiness { color: var(--color-teal); }
    .day-panel-title.sleep { color: var(--color-blue); }

    .day-panel .empty-note {
        color: var(--color-muted);
        font-size: 0.8rem;
        font-style: italic;
    }

    .day-data-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 500px) {
        .day-data-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .day-data-item {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 0.5rem;
        text-align: center;
    }

    .day-data-item .label {
        font-size: 0.65rem;
        color: var(--color-muted);
        text-transform: uppercase;
    }

    .day-data-item .value {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
    }

    .day-data-item .value.missing {
        color: var(--color-yellow);
        font-style: italic;
    }

    .day-data-item .value.good { color: var(--color-green); }
    .day-data-item .value.hr { color: var(--color-red); }
    .day-data-item .value.sleep { color: var(--color-blue); }

    /* ============== Modal Buttons ============== */
    .btn-modal {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modal-primary {
        background: linear-gradient(135deg, var(--color-teal), var(--color-green));
        border: none;
        color: #0a0a0a;
    }

    .btn-modal-primary:hover { opacity: 0.9; }

    .btn-modal-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .btn-modal-secondary:hover { background: rgba(255, 255, 255, 0.15); }

    .btn-modal-warning {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid var(--color-yellow);
        color: var(--color-yellow);
    }

    .btn-modal-warning:hover { background: rgba(255, 193, 7, 0.3); }

    /* ============== Action buttons in tables ============== */
    .btn-edit {
        background: none;
        border: none;
        color: var(--color-teal);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
    }

    .btn-edit:hover { opacity: 1; }

    .btn-view-day {
        background: none;
        border: none;
        color: var(--color-blue);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .btn-view-day:hover { opacity: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
    }

    .btn-cancel:hover { background: rgba(255, 255, 255, 0.12); }

    .btn-confirm-delete {
        background: var(--color-red);
        border: none;
        color: white;
    }

    .btn-confirm-delete:hover { background: #FF3333; }

    /* ============== Extraction Results ============== */
    .extraction-results { margin-top: 0.75rem; }

    .extraction-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        padding: 0.5rem 0.625rem;
        margin-bottom: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
    }

    .extraction-item.cycling { border-left: 3px solid var(--color-green); }
    .extraction-item.sleep { border-left: 3px solid var(--color-blue); }
    .extraction-item.unknown { border-left: 3px solid var(--color-yellow); }
    .extraction-item.error { border-left: 3px solid var(--color-red); }

    .extraction-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .extraction-item.cycling .extraction-icon { background: rgba(0, 230, 118, 0.15); color: var(--color-green); }
    .extraction-item.sleep .extraction-icon { background: rgba(0, 119, 255, 0.15); color: var(--color-blue); }
    .extraction-item.unknown .extraction-icon { background: rgba(255, 193, 7, 0.15); color: var(--color-yellow); }
    .extraction-item.error .extraction-icon { background: rgba(255, 82, 82, 0.15); color: var(--color-red); }

    .extraction-details { flex: 1; min-width: 0; }

    .extraction-filename {
        font-size: 0.7rem;
        color: var(--color-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .extraction-type { font-weight: 600; font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="cycle-container py-3">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-zyra"></div>
        <p class="loading-text">Processing screenshots...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <h4><i class="fas fa-exclamation-triangle text-warning me-2"></i><span id="confirmModalTitle">Delete?</span></h4>
            <p>This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Review Missing Data Modal -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit me-2"></i>Review Extracted Data</h3>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-muted-light); font-size: 0.85rem; margin-bottom: 1rem;">
                    Some fields could not be extracted. Review and fill in missing values below (yellow highlight).
                </p>
                <div id="reviewContent">
                    <!-- Filled dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="skipReviewAndSave()">Skip & Save As-Is</button>
                <button class="btn-modal btn-modal-primary" onclick="saveReviewedData()">
                    <i class="fas fa-save me-1"></i>Save Corrected Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="editWorkoutModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bicycle me-2" style="color: var(--color-green)"></i>Edit Workout</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWorkoutId">
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Date</label>
                        <input type="date" id="editDate" name="date">
                    </div>
                    <div class="modal-field">
                        <label>Duration (mm:ss)</label>
                        <input type="text" id="editDuration" placeholder="30:00" pattern="\d+:\d{2}">
                    </div>
                    <div class="modal-field">
                        <label>Avg Power (W)</label>
                        <input type="number" id="editAvgPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Max Power (W)</label>
                        <input type="number" id="editMaxPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Normalized Power (W)</label>
                        <input type="number" id="editNormalizedPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Intensity Factor</label>
                        <input type="number" id="editIF" step="0.01" min="0" max="2">
                    </div>
                    <div class="modal-field">
                        <label>TSS</label>
                        <input type="number" id="editTSS" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Avg Heart Rate (bpm)</label>
                        <input type="number" id="editAvgHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Max Heart Rate (bpm)</label>
                        <input type="number" id="editMaxHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Avg Cadence (rpm)</label>
                        <input type="number" id="editCadence" min="0" max="200">
                    </div>
                    <div class="modal-field">
                        <label>Distance (km)</label>
                        <input type="number" id="editDistance" step="0.01">
                    </div>
                    <div class="modal-field">
                        <label>Active Calories</label>
                        <input type="number" id="editKcalActive">
                    </div>
                    <div class="modal-field">
                        <label>Total Calories</label>
                        <input type="number" id="editKcalTotal">
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedWorkout()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Daily Expanded View Modal -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day me-2"></i>Day Summary: <span id="dayViewDate"></span></h3>
                <button class="modal-close" onclick="closeDayViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dayViewContent">
                    <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeDayViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="cycle-hero">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-bicycle me-2"></i>Zyra Cycle</h1>
                <p class="subtitle">Cycling performance & morning readiness</p>
            </div>
            <span class="date-badge">
                <i class="fas fa-calendar-day me-1"></i>{{ today }}
            </span>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ cycling_stats.total_workouts or 0 }}</div>
            <div class="stat-label">Workouts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value tss">{{ "%.0f"|format(cycling_stats.total_tss or 0) }}</div>
            <div class="stat-label">Total TSS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.0f"|format(cycling_stats.avg_power or 0) }}W</div>
            <div class="stat-label">Avg Power</div>
        </div>
        <div class="stat-card">
            <div class="stat-value time">{{ "%.0f"|format((cycling_stats.total_duration_sec or 0) / 3600) }}h</div>
            <div class="stat-label">Total Time</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="cycle-tabs">
        <button class="cycle-tab active" data-tab="workouts">
            <i class="fas fa-bicycle"></i>Workouts
        </button>
        <button class="cycle-tab" data-tab="readiness">
            <i class="fas fa-moon"></i>Readiness & Sleep
        </button>
    </div>

    <!-- Tab: Workouts -->
    <div id="workoutsTab" class="tab-content active">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Import Section -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-cloud-upload-alt"></i>Import Screenshots
                    </h3>
                    <form id="bundleUploadForm" enctype="multipart/form-data">
                        <div class="upload-zone" id="bundleUploadZone">
                            <i class="fas fa-images"></i>
                            <p class="title">Drop screenshots here</p>
                            <p class="hint">Cycling app, Apple Watch, Sleep data</p>
                            <input type="file" id="bundleImageInput" name="images" accept="image/*" multiple class="d-none">
                        </div>
                        <div id="fileListContainer" class="file-list d-none"></div>
                        <div id="statusMessage" class="d-none"></div>
                        <div id="uploadActions" class="d-none mt-2">
                            <button type="submit" class="btn btn-zyra w-100" id="uploadBtn">
                                <i class="fas fa-magic me-1"></i>Extract & Merge
                            </button>
                        </div>
                        <div id="extractionResults" class="extraction-results d-none"></div>
                    </form>
                </div>

                <!-- Recent Workouts Table -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-list"></i>Recent Workouts
                    </h3>
                    {% if cycling_workouts %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Power</th>
                                    <th>Avg HR</th>
                                    <th>Max HR</th>
                                    <th>TSS</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cyclingTableBody">
                                {% for workout in cycling_workouts %}
                                <tr data-workout-id="{{ workout.id }}" data-workout-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                                    <td>
                                        <button class="btn-view-day" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="View Day Details">
                                            {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                                        </button>
                                    </td>
                                    <td class="val-time">{{ "%d:%02d"|format((workout.duration_sec or 0) // 60, (workout.duration_sec or 0) % 60) if workout.duration_sec else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td class="val-power">{{ "%.0f"|format(workout.avg_power_w) if workout.avg_power_w else '<span class="val-empty">--</span>' | safe }}{{ 'W' if workout.avg_power_w else '' }}</td>
                                    <td class="val-hr">{{ workout.avg_heart_rate if workout.avg_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.avg_heart_rate else '' }}</td>
                                    <td class="val-hr">{{ workout.max_heart_rate if workout.max_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.max_heart_rate else '' }}</td>
                                    <td class="val-tss">{{ "%.0f"|format(workout.tss) if workout.tss else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td>
                                        <button class="btn-edit btn-edit-workout" data-id="{{ workout.id }}" title="Edit Workout">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn-delete btn-delete-workout" data-id="{{ workout.id }}" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-bicycle"></i>
                        <p>No workouts imported yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Performance Trends Chart -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-chart-line"></i>Performance Trends
                    </h3>
                    {% if cycling_chart.dates and cycling_chart.dates|length > 0 %}
                    <div class="chart-container">
                        <canvas id="cyclingChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-chart-area"></i>
                        <p>No data yet. Upload screenshots to see your performance trend.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Readiness & Sleep -->
    <div id="readinessTab" class="tab-content">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Morning Readiness Form -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-sun"></i>Morning Readiness
                    </h3>
                    <form id="readinessForm">
                        <input type="hidden" id="readinessDate" name="date" value="{{ today }}">

                        <!-- Energy -->
                        <div class="mb-2">
                            <label class="form-label">Energy Level</label>
                            <div class="rating-selector" data-field="energy">
                                {% for i in range(1, 6) %}
                                <label class="rating-option"><input type="radio" name="energy" value="{{ i }}">{{ i }}</label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Mood -->
                        <div class="mb-2">
                            <label class="form-label">Mood</label>
                            <div class="rating-selector" data-field="mood">
                                <label class="rating-option"><input type="radio" name="mood" value="1">üòî</label>
                                <label class="rating-option"><input type="radio" name="mood" value="2">üòê</label>
                                <label class="rating-option"><input type="radio" name="mood" value="3">üòä</label>
                            </div>
                        </div>

                        <!-- Muscle Fatigue -->
                        <div class="mb-2">
                            <label class="form-label">Muscle Fatigue</label>
                            <div class="rating-selector" data-field="muscle_fatigue">
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="1">Low</label>
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="2">Med</label>
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="3">High</label>
                            </div>
                        </div>

                        <!-- HRV & RHR -->
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">HRV Status</label>
                                <div class="status-selector" data-field="hrv_status">
                                    <label class="status-option negative"><input type="radio" name="hrv_status" value="-1">‚Üì</label>
                                    <label class="status-option neutral"><input type="radio" name="hrv_status" value="0">‚Üí</label>
                                    <label class="status-option positive"><input type="radio" name="hrv_status" value="1">‚Üë</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">RHR Status</label>
                                <div class="status-selector" data-field="rhr_status">
                                    <label class="status-option positive"><input type="radio" name="rhr_status" value="-1">‚Üì</label>
                                    <label class="status-option neutral"><input type="radio" name="rhr_status" value="0">‚Üí</label>
                                    <label class="status-option negative"><input type="radio" name="rhr_status" value="1">‚Üë</label>
                                </div>
                            </div>
                        </div>

                        <!-- Sleep -->
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">Sleep (hours)</label>
                                <input type="number" class="form-control" id="sleepHours" step="0.5" min="0" max="12" placeholder="7.5">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Deep Sleep (min)</label>
                                <input type="number" class="form-control" name="deep_sleep_minutes" min="0" max="300" placeholder="60">
                            </div>
                        </div>

                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">Wakeups</label>
                                <input type="number" class="form-control" name="wakeups_count" min="0" max="10" placeholder="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Stress</label>
                                <select class="form-select" name="stress_level">
                                    <option value="1">Low</option>
                                    <option value="2" selected>Normal</option>
                                    <option value="3">High</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="symptomsFlag" name="symptoms_flag">
                                <label class="form-check-label" style="font-size: 0.8rem; color: var(--color-muted-light);" for="symptomsFlag">
                                    Experiencing symptoms
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-zyra w-100">
                            <i class="fas fa-save me-1"></i>Save Readiness
                        </button>
                    </form>
                </div>

                <!-- Readiness History -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-history"></i>Readiness History
                    </h3>
                    {% if readiness_entries %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Energy</th>
                                    <th>Sleep</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in readiness_entries %}
                                <tr data-readiness-id="{{ entry.id }}">
                                    <td>{{ entry.date if entry.date is string else entry.date.strftime('%m/%d') if entry.date else '--' }}</td>
                                    <td>
                                        {% if entry.morning_score %}
                                        <span class="score-badge {% if entry.morning_score >= 70 %}score-high{% elif entry.morning_score >= 40 %}score-medium{% else %}score-low{% endif %}">
                                            {{ entry.morning_score }}
                                        </span>
                                        {% else %}
                                        <span class="val-empty">--</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ entry.energy if entry.energy else '<span class="val-empty">--</span>' | safe }}/5</td>
                                    <td class="val-time">{{ "%.1f"|format((entry.sleep_minutes or 0) / 60) if entry.sleep_minutes else '<span class="val-empty">--</span>' | safe }}{{ 'h' if entry.sleep_minutes else '' }}</td>
                                    <td>
                                        <button class="btn-delete btn-delete-readiness" data-id="{{ entry.id }}" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state sleep">
                        <i class="fas fa-bed"></i>
                        <p>No readiness entries yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Readiness Trend Chart -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-chart-area"></i>Readiness Trend
                    </h3>
                    {% if readiness_chart.dates and readiness_chart.dates|length > 0 %}
                    <div class="chart-container compact">
                        <canvas id="readinessChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state sleep">
                        <i class="fas fa-chart-line"></i>
                        <p>No readiness data yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============== Toast Helper ==============
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-zyra ${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // ============== Status Message Helper ==============
    function showStatus(type, message) {
        const el = document.getElementById('statusMessage');
        el.className = `status-msg ${type}`;
        const icon = type === 'loading' ? 'fa-spinner fa-spin' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        el.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        el.classList.remove('d-none');
    }

    function hideStatus() {
        document.getElementById('statusMessage').classList.add('d-none');
    }

    // ============== Loading Overlay ==============
    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading(text = 'Processing screenshots...') {
        loadingOverlay.querySelector('.loading-text').textContent = text;
        loadingOverlay.classList.add('active');
    }
    function hideLoading() { loadingOverlay.classList.remove('active'); }

    // ============== Tab Switching ==============
    document.querySelectorAll('.cycle-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.cycle-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
    });

    // ============== Rating Selectors ==============
    document.querySelectorAll('.rating-selector, .status-selector').forEach(selector => {
        selector.querySelectorAll('.rating-option, .status-option').forEach(option => {
            option.addEventListener('click', function() {
                selector.querySelectorAll('.rating-option, .status-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });
    });

    // ============== Multi-file Upload ==============
    const bundleZone = document.getElementById('bundleUploadZone');
    const bundleInput = document.getElementById('bundleImageInput');
    const fileListContainer = document.getElementById('fileListContainer');
    const uploadActions = document.getElementById('uploadActions');
    const extractionResults = document.getElementById('extractionResults');
    let selectedFiles = [];

    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileListContainer.classList.add('d-none');
            uploadActions.classList.add('d-none');
            hideStatus();
            return;
        }

        fileListContainer.classList.remove('d-none');
        uploadActions.classList.remove('d-none');
        fileListContainer.innerHTML = selectedFiles.map((file, idx) => `
            <div class="file-item">
                <i class="fas fa-image"></i>
                <span class="filename">${file.name}</span>
                <span class="remove-file" data-idx="${idx}"><i class="fas fa-times"></i></span>
            </div>
        `).join('');

        fileListContainer.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedFiles.splice(parseInt(this.dataset.idx), 1);
                updateFileList();
            });
        });
    }

    bundleZone.addEventListener('click', () => bundleInput.click());
    bundleZone.addEventListener('dragover', (e) => { e.preventDefault(); bundleZone.classList.add('dragover'); });
    bundleZone.addEventListener('dragleave', () => bundleZone.classList.remove('dragover'));
    bundleZone.addEventListener('drop', (e) => {
        e.preventDefault();
        bundleZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(e.dataTransfer.files)];
            updateFileList();
        }
    });

    bundleInput.addEventListener('change', function() {
        if (this.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(this.files)];
            updateFileList();
        }
    });

    // ============== Bundle Upload Form ==============
    document.getElementById('bundleUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (selectedFiles.length === 0) {
            showToast('Please select at least one image', 'error');
            return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('images', file));

        showLoading(`Processing ${selectedFiles.length} image(s)...`);
        showStatus('loading', 'Analyzing screenshots...');
        extractionResults.classList.add('d-none');
        document.getElementById('uploadBtn').disabled = true;

        try {
            const response = await fetch('/cycling-readiness/api/cycle/import-bundle', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;

            if (data.success) {
                const results = data.extraction_results || [];
                const errors = results.filter(r => r.type === 'error').length;

                if (errors > 0 && errors === results.length) {
                    showStatus('error', 'Could not parse screenshots');
                } else if (errors > 0) {
                    showStatus('success', `Merged successfully! (${errors} failed)`);
                } else {
                    showStatus('success', 'Merged successfully!');
                }

                if (results.length > 0) {
                    extractionResults.classList.remove('d-none');
                    extractionResults.innerHTML = results.map(r => {
                        // Handle both old (cycling_workout) and new (cycling_power, watch_workout) types
                        const isCycling = r.type === 'cycling_workout' || r.type === 'cycling_power' || r.type === 'watch_workout';
                        const isSleep = r.type === 'sleep_summary';
                        const isError = r.type === 'error';
                        
                        const typeClass = isCycling ? 'cycling' : isSleep ? 'sleep' : isError ? 'error' : 'unknown';
                        const icon = isCycling ? 'fa-bicycle' : isSleep ? 'fa-moon' : isError ? 'fa-exclamation-triangle' : 'fa-question';
                        const typeName = isCycling ? 'Cycling' : isSleep ? 'Sleep' : isError ? 'Error' : 'Unknown';
                        const confidence = r.confidence ? ` (${Math.round(r.confidence * 100)}%)` : '';
                        
                        return `
                            <div class="extraction-item ${typeClass}">
                                <div class="extraction-icon"><i class="fas ${icon}"></i></div>
                                <div class="extraction-details">
                                    <div class="extraction-type">${typeName}${confidence}</div>
                                    <div class="extraction-filename">${r.filename}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                selectedFiles = [];
                updateFileList();
                
                // Check if there's missing data that needs review
                if (data.has_missing_data && 
                    (data.missing_fields?.workout?.length > 0 || data.missing_fields?.sleep?.length > 0)) {
                    // Store the data for review modal
                    window.lastImportData = data;
                    showReviewModal(data);
                } else {
                    // No missing data, reload after showing results
                    setTimeout(() => location.reload(), 2500);
                }
            } else {
                showStatus('error', data.error || 'Import failed');
                showToast(data.error || 'Import failed', 'error');
            }
        } catch (err) {
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;
            showStatus('error', 'Error processing images');
            showToast('Error processing images', 'error');
        }
    });

    // ============== Readiness Form ==============
    document.getElementById('readinessForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const sleepHours = parseFloat(document.getElementById('sleepHours').value) || 0;
        const data = {
            date: document.getElementById('readinessDate').value,
            energy: document.querySelector('[name="energy"]:checked')?.value,
            mood: document.querySelector('[name="mood"]:checked')?.value,
            muscle_fatigue: document.querySelector('[name="muscle_fatigue"]:checked')?.value,
            hrv_status: document.querySelector('[name="hrv_status"]:checked')?.value || 0,
            rhr_status: document.querySelector('[name="rhr_status"]:checked')?.value || 0,
            min_hr_status: 0,
            sleep_minutes: Math.round(sleepHours * 60),
            deep_sleep_minutes: parseInt(document.querySelector('[name="deep_sleep_minutes"]').value) || 0,
            wakeups_count: parseInt(document.querySelector('[name="wakeups_count"]').value) || 0,
            stress_level: parseInt(document.querySelector('[name="stress_level"]').value) || 2,
            symptoms_flag: document.getElementById('symptomsFlag').checked
        };

        if (!data.energy || !data.mood || !data.muscle_fatigue) {
            showToast('Please fill Energy, Mood, and Fatigue', 'error');
            return;
        }

        try {
            const response = await fetch('/cycling-readiness/api/readiness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast(`Saved! Score: ${result.morning_score}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Error saving readiness', 'error');
        }
    });

    // ============== Delete Records ==============
    let deleteType = null; // 'workout', 'readiness', or 'sleep'
    let deleteId = null;

    window.closeConfirmModal = function() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteType = null;
        deleteId = null;
    };

    function showConfirmModal(type, id) {
        deleteType = type;
        deleteId = id;
        
        // Set modal title based on type
        const titles = {
            'workout': 'Delete Workout?',
            'readiness': 'Delete Readiness Entry?',
            'sleep': 'Delete Sleep Summary?'
        };
        document.getElementById('confirmModalTitle').textContent = titles[type] || 'Delete?';
        document.getElementById('confirmModal').classList.add('active');
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (!deleteId || !deleteType) return;

        let endpoint = '';
        let successMessage = '';
        
        switch(deleteType) {
            case 'workout':
                endpoint = `/cycling-readiness/api/cycling/${deleteId}`;
                successMessage = 'Workout deleted';
                break;
            case 'readiness':
                endpoint = `/cycling-readiness/api/readiness/${deleteId}`;
                successMessage = 'Readiness entry deleted';
                break;
            case 'sleep':
                endpoint = `/cycling-readiness/api/sleep/${deleteId}`;
                successMessage = 'Sleep summary deleted';
                break;
            default:
                closeConfirmModal();
                return;
        }

        try {
            const response = await fetch(endpoint, { method: 'DELETE' });
            const data = await response.json();
            closeConfirmModal();

            if (data.success) {
                showToast(successMessage, 'success');
                // Reload page after short delay to update stats and charts
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(data.error || 'Failed to delete', 'error');
            }
        } catch (err) {
            closeConfirmModal();
            showToast('Error deleting record', 'error');
        }
    });

    // Workout delete buttons
    document.querySelectorAll('.btn-delete-workout').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showConfirmModal('workout', this.dataset.id);
        });
    });

    // Readiness delete buttons
    document.querySelectorAll('.btn-delete-readiness').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showConfirmModal('readiness', this.dataset.id);
        });
    });

    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmModal();
    });

    // ============== Edit Workout Functions ==============
    
    // Edit workout buttons
    document.querySelectorAll('.btn-edit-workout').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const workoutId = this.dataset.id;
            await openEditModal(workoutId);
        });
    });

    async function openEditModal(workoutId) {
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`);
            const data = await response.json();
            
            if (data.success && data.workout) {
                const w = data.workout;
                document.getElementById('editWorkoutId').value = w.id;
                document.getElementById('editDate').value = w.date || '';
                
                // Convert duration_sec to mm:ss
                if (w.duration_sec) {
                    const mins = Math.floor(w.duration_sec / 60);
                    const secs = w.duration_sec % 60;
                    document.getElementById('editDuration').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('editDuration').value = '';
                }
                
                document.getElementById('editAvgPower').value = w.avg_power_w || '';
                document.getElementById('editMaxPower').value = w.max_power_w || '';
                document.getElementById('editNormalizedPower').value = w.normalized_power_w || '';
                document.getElementById('editIF').value = w.intensity_factor || '';
                document.getElementById('editTSS').value = w.tss || '';
                document.getElementById('editAvgHR').value = w.avg_heart_rate || '';
                document.getElementById('editMaxHR').value = w.max_heart_rate || '';
                document.getElementById('editCadence').value = w.avg_cadence || '';
                document.getElementById('editDistance').value = w.distance_km || '';
                document.getElementById('editKcalActive').value = w.kcal_active || '';
                document.getElementById('editKcalTotal').value = w.kcal_total || '';
                document.getElementById('editNotes').value = w.notes || '';
                
                document.getElementById('editWorkoutModal').classList.add('active');
            } else {
                showToast('Failed to load workout', 'error');
            }
        } catch (err) {
            showToast('Error loading workout', 'error');
        }
    }

    window.closeEditModal = function() {
        document.getElementById('editWorkoutModal').classList.remove('active');
    };

    window.saveEditedWorkout = async function() {
        const workoutId = document.getElementById('editWorkoutId').value;
        
        // Parse duration mm:ss to seconds
        let durationSec = null;
        const durationVal = document.getElementById('editDuration').value;
        if (durationVal) {
            const parts = durationVal.split(':');
            if (parts.length === 2) {
                durationSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
        }
        
        const data = {
            date: document.getElementById('editDate').value || null,
            duration_sec: durationSec,
            avg_power_w: parseFloat(document.getElementById('editAvgPower').value) || null,
            max_power_w: parseFloat(document.getElementById('editMaxPower').value) || null,
            normalized_power_w: parseFloat(document.getElementById('editNormalizedPower').value) || null,
            intensity_factor: parseFloat(document.getElementById('editIF').value) || null,
            tss: parseFloat(document.getElementById('editTSS').value) || null,
            avg_heart_rate: parseInt(document.getElementById('editAvgHR').value) || null,
            max_heart_rate: parseInt(document.getElementById('editMaxHR').value) || null,
            avg_cadence: parseInt(document.getElementById('editCadence').value) || null,
            distance_km: parseFloat(document.getElementById('editDistance').value) || null,
            kcal_active: parseInt(document.getElementById('editKcalActive').value) || null,
            kcal_total: parseInt(document.getElementById('editKcalTotal').value) || null,
            notes: document.getElementById('editNotes').value || null
        };
        
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                closeEditModal();
                showToast('Workout updated!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error saving workout', 'error');
        }
    };

    document.getElementById('editWorkoutModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    // ============== Day View Functions ==============
    
    // View day buttons
    document.querySelectorAll('.btn-view-day').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const date = this.dataset.date;
            if (date) {
                await openDayViewModal(date);
            }
        });
    });

    async function openDayViewModal(date) {
        document.getElementById('dayViewDate').textContent = date;
        document.getElementById('dayViewModal').classList.add('active');
        document.getElementById('dayViewContent').innerHTML = `
            <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        `;
        
        try {
            const response = await fetch(`/cycling-readiness/api/day-summary?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                renderDayView(data);
            } else {
                document.getElementById('dayViewContent').innerHTML = `
                    <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load data
                    </div>
                `;
            }
        } catch (err) {
            document.getElementById('dayViewContent').innerHTML = `
                <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </div>
            `;
        }
    }

    function renderDayView(data) {
        const container = document.getElementById('dayViewContent');
        let html = '';
        
        // Cycling Workout Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title cycling"><i class="fas fa-bicycle me-2"></i>Cycling Workout</div>
                ${data.cycling_workout ? `<button class="btn-edit" onclick="openEditModal(${data.cycling_workout.id})" title="Edit"><i class="fas fa-pencil-alt"></i></button>` : ''}
            </div>`;
        
        if (data.cycling_workout) {
            const w = data.cycling_workout;
            const missingCycling = data.missing?.cycling || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Duration', formatDuration(w.duration_sec), missingCycling.includes('duration_sec'))}
                ${renderDayDataItem('Avg Power', w.avg_power_w ? w.avg_power_w + 'W' : null, missingCycling.includes('avg_power_w'), 'good')}
                ${renderDayDataItem('Max Power', w.max_power_w ? w.max_power_w + 'W' : null, missingCycling.includes('max_power_w'), 'good')}
                ${renderDayDataItem('NP', w.normalized_power_w ? w.normalized_power_w + 'W' : null, missingCycling.includes('normalized_power_w'), 'good')}
                ${renderDayDataItem('Avg HR', w.avg_heart_rate ? w.avg_heart_rate + ' bpm' : null, missingCycling.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', w.max_heart_rate ? w.max_heart_rate + ' bpm' : null, missingCycling.includes('max_heart_rate'), 'hr')}
                ${renderDayDataItem('TSS', w.tss, missingCycling.includes('tss'))}
                ${renderDayDataItem('IF', w.intensity_factor, missingCycling.includes('intensity_factor'))}
                ${renderDayDataItem('Cadence', w.avg_cadence ? w.avg_cadence + ' rpm' : null, missingCycling.includes('avg_cadence'))}
                ${renderDayDataItem('Distance', w.distance_km ? w.distance_km + ' km' : null, missingCycling.includes('distance_km'))}
                ${renderDayDataItem('Active kcal', w.kcal_active, missingCycling.includes('kcal_active'))}
                ${renderDayDataItem('Total kcal', w.kcal_total, missingCycling.includes('kcal_total'))}
            </div>`;
        } else {
            html += `<p class="empty-note">No cycling workout recorded for this date.</p>`;
        }
        html += `</div>`;
        
        // Readiness Entry Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title readiness"><i class="fas fa-sun me-2"></i>Readiness Entry</div>
            </div>`;
        
        if (data.readiness_entry) {
            const r = data.readiness_entry;
            const missingReadiness = data.missing?.readiness || [];
            const score = r.morning_score;
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? '' : 'missing';
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Score', score, false, scoreClass)}
                ${renderDayDataItem('Energy', r.energy ? r.energy + '/5' : null, missingReadiness.includes('energy'))}
                ${renderDayDataItem('Mood', r.mood ? r.mood + '/3' : null, missingReadiness.includes('mood'))}
                ${renderDayDataItem('Fatigue', r.muscle_fatigue ? r.muscle_fatigue + '/3' : null, missingReadiness.includes('muscle_fatigue'))}
                ${renderDayDataItem('Sleep', r.sleep_minutes ? (r.sleep_minutes / 60).toFixed(1) + 'h' : null, missingReadiness.includes('sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', r.deep_sleep_minutes ? r.deep_sleep_minutes + 'min' : null, missingReadiness.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Wakeups', r.wakeups_count !== null ? r.wakeups_count : null, false)}
                ${renderDayDataItem('Stress', r.stress_level ? r.stress_level + '/3' : null, false)}
                ${renderDayDataItem('Symptoms', r.symptoms_flag ? 'Yes' : 'No', false)}
            </div>`;
        } else {
            html += `<p class="empty-note">No readiness entry for this date.</p>`;
        }
        html += `</div>`;
        
        // Sleep Summary Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title sleep"><i class="fas fa-moon me-2"></i>Sleep Summary</div>
            </div>`;
        
        if (data.sleep_summary) {
            const s = data.sleep_summary;
            const missingSleep = data.missing?.sleep || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Total Sleep', s.total_sleep_minutes ? (s.total_sleep_minutes / 60).toFixed(1) + 'h' : null, missingSleep.includes('total_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', s.deep_sleep_minutes ? s.deep_sleep_minutes + 'min' : null, missingSleep.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Wakeups', s.wakeups_count, missingSleep.includes('wakeups_count'))}
                ${renderDayDataItem('Start', formatTime(s.sleep_start_time), false)}
                ${renderDayDataItem('End', formatTime(s.sleep_end_time), false)}
                ${renderDayDataItem('Min HR', s.min_heart_rate ? s.min_heart_rate + ' bpm' : null, missingSleep.includes('min_heart_rate'), 'hr')}
                ${renderDayDataItem('Avg HR', s.avg_heart_rate ? s.avg_heart_rate + ' bpm' : null, missingSleep.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', s.max_heart_rate ? s.max_heart_rate + ' bpm' : null, missingSleep.includes('max_heart_rate'), 'hr')}
            </div>`;
        } else {
            html += `<p class="empty-note">No sleep data for this date.</p>`;
        }
        html += `</div>`;
        
        container.innerHTML = html;
    }

    function renderDayDataItem(label, value, isMissing, valueClass = '') {
        const displayValue = value !== null && value !== undefined ? value : '--';
        const missingClass = isMissing ? 'missing' : valueClass;
        return `
            <div class="day-data-item">
                <div class="label">${label}</div>
                <div class="value ${missingClass}">${displayValue}</div>
            </div>
        `;
    }

    function formatDuration(seconds) {
        if (!seconds) return null;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function formatTime(timeValue) {
        if (!timeValue) return null;
        // Handle time strings like "22:00:00" or seconds
        if (typeof timeValue === 'string' && timeValue.includes(':')) {
            return timeValue.substring(0, 5); // Return HH:MM
        }
        // Handle seconds (e.g., 79200 = 22:00)
        if (typeof timeValue === 'number') {
            const hours = Math.floor(timeValue / 3600) % 24;
            const mins = Math.floor((timeValue % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }
        return timeValue;
    }

    window.closeDayViewModal = function() {
        document.getElementById('dayViewModal').classList.remove('active');
    };

    document.getElementById('dayViewModal').addEventListener('click', function(e) {
        if (e.target === this) closeDayViewModal();
    });

    // ============== Review Modal Functions ==============
    
    let reviewData = null;

    function showReviewModal(data) {
        reviewData = data;
        const container = document.getElementById('reviewContent');
        let html = '';
        
        // Workout review card
        if (data.canonical_workout && data.canonical_workout.date) {
            const cw = data.canonical_workout;
            const missingWorkout = data.missing_fields?.workout || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type cycling"><i class="fas fa-bicycle me-1"></i>Cycling Workout</span>
                    ${missingWorkout.length > 0 ? `<span class="review-missing-badge">${missingWorkout.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('duration_sec', 'Duration (sec)', cw.duration_minutes ? Math.round(cw.duration_minutes * 60) : null, missingWorkout)}
                    ${renderReviewField('avg_power_w', 'Avg Power (W)', cw.avg_power, missingWorkout)}
                    ${renderReviewField('max_power_w', 'Max Power (W)', cw.max_power, missingWorkout)}
                    ${renderReviewField('normalized_power_w', 'NP (W)', cw.normalized_power, missingWorkout)}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cw.avg_hr, missingWorkout)}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cw.max_hr, missingWorkout)}
                    ${renderReviewField('tss', 'TSS', cw.tss, missingWorkout)}
                    ${renderReviewField('intensity_factor', 'IF', cw.intensity_factor, missingWorkout)}
                    ${renderReviewField('avg_cadence', 'Cadence (rpm)', cw.cadence_avg, missingWorkout)}
                    ${renderReviewField('distance_km', 'Distance (km)', cw.distance_km, missingWorkout)}
                    ${renderReviewField('kcal_active', 'Active kcal', cw.calories_active, missingWorkout)}
                    ${renderReviewField('kcal_total', 'Total kcal', cw.calories_total, missingWorkout)}
                </div>
            </div>`;
        }
        
        // Sleep review card
        if (data.canonical_sleep && data.canonical_sleep.date) {
            const cs = data.canonical_sleep;
            const missingSleep = data.missing_fields?.sleep || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type sleep"><i class="fas fa-moon me-1"></i>Sleep Summary</span>
                    ${missingSleep.length > 0 ? `<span class="review-missing-badge">${missingSleep.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('total_sleep_minutes', 'Total Sleep (min)', cs.total_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('deep_sleep_minutes', 'Deep Sleep (min)', cs.deep_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('wakeups_count', 'Wakeups', cs.wakeups, missingSleep, 'sleep_')}
                    ${renderReviewField('min_heart_rate', 'Min HR (bpm)', cs.min_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cs.avg_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cs.max_hr, missingSleep, 'sleep_')}
                </div>
            </div>`;
        }
        
        if (!html) {
            html = '<p style="color: var(--color-muted);">No data to review.</p>';
        }
        
        container.innerHTML = html;
        document.getElementById('reviewModal').classList.add('active');
    }

    function renderReviewField(fieldName, label, value, missingFields, prefix = '') {
        const isMissing = missingFields.includes(fieldName);
        const inputId = prefix + fieldName;
        return `
            <div class="modal-field">
                <label>${label}</label>
                <input type="number" id="review_${inputId}" class="${isMissing ? 'missing' : ''}" 
                       value="${value !== null && value !== undefined ? value : ''}" 
                       step="any" placeholder="${isMissing ? 'Missing - enter value' : ''}">
            </div>
        `;
    }

    window.closeReviewModal = function() {
        document.getElementById('reviewModal').classList.remove('active');
        reviewData = null;
        // Reload to show saved data
        setTimeout(() => location.reload(), 500);
    };

    window.skipReviewAndSave = function() {
        // Data was already saved during import, just close modal
        closeReviewModal();
    };

    window.saveReviewedData = async function() {
        if (!reviewData) return;
        
        const workoutId = reviewData.workout_id;
        
        // Collect workout corrections if we have a workout
        if (workoutId) {
            const workoutUpdates = {
                duration_sec: parseInt(document.getElementById('review_duration_sec')?.value) || null,
                avg_power_w: parseFloat(document.getElementById('review_avg_power_w')?.value) || null,
                max_power_w: parseFloat(document.getElementById('review_max_power_w')?.value) || null,
                normalized_power_w: parseFloat(document.getElementById('review_normalized_power_w')?.value) || null,
                avg_heart_rate: parseInt(document.getElementById('review_avg_heart_rate')?.value) || null,
                max_heart_rate: parseInt(document.getElementById('review_max_heart_rate')?.value) || null,
                tss: parseFloat(document.getElementById('review_tss')?.value) || null,
                intensity_factor: parseFloat(document.getElementById('review_intensity_factor')?.value) || null,
                avg_cadence: parseInt(document.getElementById('review_avg_cadence')?.value) || null,
                distance_km: parseFloat(document.getElementById('review_distance_km')?.value) || null,
                kcal_active: parseInt(document.getElementById('review_kcal_active')?.value) || null,
                kcal_total: parseInt(document.getElementById('review_kcal_total')?.value) || null
            };
            
            try {
                const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workoutUpdates)
                });
                
                const result = await response.json();
                if (!result.success) {
                    showToast('Failed to update workout', 'error');
                    return;
                }
            } catch (err) {
                showToast('Error updating workout', 'error');
                return;
            }
        }
        
        // Note: Sleep data is already saved and linked to readiness
        // Future enhancement: add sleep update endpoint if needed
        
        showToast('Data updated successfully!', 'success');
        closeReviewModal();
    };

    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) closeReviewModal();
    });

    // ============== Charts ==============
    const cyclingChartData = {{ cycling_chart | tojson | safe }};
    const readinessChartData = {{ readiness_chart | tojson | safe }};

    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                labels: { color: 'rgba(255,255,255,0.6)', boxWidth: 10, font: { size: 10 } }
            }
        },
        scales: {
            x: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 }, maxRotation: 0 },
                grid: { color: 'rgba(255,255,255,0.04)' }
            },
            y: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                grid: { color: 'rgba(255,255,255,0.04)' }
            }
        }
    };

    // Cycling Chart
    if (cyclingChartData.dates && cyclingChartData.dates.length > 0) {
        new Chart(document.getElementById('cyclingChart'), {
            type: 'line',
            data: {
                labels: cyclingChartData.dates,
                datasets: [
                    {
                        label: 'Power (W)',
                        data: cyclingChartData.avg_power,
                        borderColor: '#00E676',
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2
                    },
                    {
                        label: 'Avg HR',
                        data: cyclingChartData.avg_heart_rate,
                        borderColor: '#FF5252',
                        backgroundColor: 'rgba(255, 82, 82, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 2,
                        yAxisID: 'y2'
                    },
                    {
                        label: 'TSS',
                        data: cyclingChartData.tss,
                        borderColor: '#FFC107',
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 2
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    ...chartDefaults.scales,
                    y1: {
                        position: 'right',
                        ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                        grid: { display: false }
                    },
                    y2: {
                        position: 'right',
                        ticks: { 
                            color: 'rgba(255, 82, 82, 0.6)', 
                            font: { size: 9 },
                            callback: function(value) { return value + ' bpm'; }
                        },
                        grid: { display: false },
                        min: 60,
                        suggestedMax: 200
                    }
                }
            }
        });
    }

    // Readiness Chart
    if (readinessChartData.dates && readinessChartData.dates.length > 0) {
        new Chart(document.getElementById('readinessChart'), {
            type: 'line',
            data: {
                labels: readinessChartData.dates,
                datasets: [{
                    label: 'Score',
                    data: readinessChartData.morning_score,
                    borderColor: '#0077FF',
                    backgroundColor: 'rgba(0, 119, 255, 0.15)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                ...chartDefaults,
                plugins: { legend: { display: false } },
                scales: {
                    ...chartDefaults.scales,
                    y: { ...chartDefaults.scales.y, min: 0, max: 100 }
                }
            }
        });
    }

    console.log('üö¥ Zyra Cycle v3 initialized');
});
</script>
{% endblock %}
