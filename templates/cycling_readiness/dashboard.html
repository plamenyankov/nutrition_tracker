{% extends 'layout.html' %}

{% block title %}Zyra Cycle - Cycling & Readiness{% endblock %}

{% block head %}
<style>
    /* ============== CSS Variables & Color Roles ============== */
    :root {
        --color-teal: #00FFC6;      /* Primary UI */
        --color-blue: #0077FF;       /* Sleep/Recovery */
        --color-green: #00E676;      /* Power/Performance */
        --color-red: #FF5252;        /* Warnings/Low */
        --color-yellow: #FFC107;     /* Moderate */
        --color-muted: rgba(255, 255, 255, 0.4);
        --color-muted-light: rgba(255, 255, 255, 0.6);
    }

    /* ============== Layout & Container ============== */
    .cycle-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 0.75rem;
    }

    @media (min-width: 768px) {
        .cycle-container {
            padding: 0 1.5rem;
        }
    }

    /* ============== Hero Section (Compact) ============== */
    .cycle-hero {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.12) 0%, rgba(0, 255, 198, 0.08) 100%);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(0, 255, 198, 0.15);
    }

    .cycle-hero h1 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 800;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0;
    }

    .cycle-hero .subtitle {
        font-size: 0.8rem;
        color: var(--color-muted-light);
        margin: 0;
    }

    .date-badge {
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-teal);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .btn-expanded-link {
        background: rgba(0, 119, 255, 0.15);
        color: var(--color-blue);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid rgba(0, 119, 255, 0.3);
    }

    .btn-expanded-link:hover {
        background: rgba(0, 119, 255, 0.25);
        color: white;
    }

    /* Score formula tooltip */
    .score-info {
        position: relative;
        display: inline-block;
        margin-left: 0.5rem;
    }

    .score-info-icon {
        background: none;
        border: none;
        color: var(--color-muted);
        cursor: help;
        font-size: 0.85rem;
        padding: 0;
    }

    .score-info-icon:hover {
        color: var(--color-teal);
    }

    .score-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 20, 20, 0.98);
        border: 1px solid rgba(0, 255, 198, 0.3);
        border-radius: 8px;
        padding: 1rem;
        width: 300px;
        z-index: 100;
        font-size: 0.75rem;
        line-height: 1.5;
        color: var(--color-muted-light);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .score-tooltip.active {
        display: block;
    }

    .score-tooltip h4 {
        color: var(--color-teal);
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .score-tooltip ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .score-tooltip li {
        padding: 0.15rem 0;
    }

    .score-tooltip .category {
        color: white;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    /* ============== Stats Grid (Compact) ============== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    @media (min-width: 640px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .stat-card {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 0.75rem 0.5rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: var(--color-teal);
        transform: translateY(-1px);
    }

    .stat-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-green);
    }

    .stat-value.tss { color: var(--color-yellow); }
    .stat-value.time { color: var(--color-blue); }

    .stat-label {
        color: var(--color-muted);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.125rem;
    }

    /* ============== Tabs ============== */
    .cycle-tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .cycle-tab {
        position: relative;
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        color: var(--color-muted);
        font-weight: 600;
        font-size: 0.85rem;
        font-family: 'Montserrat', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .cycle-tab::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        width: 0;
        height: 2px;
        background: var(--color-teal);
        transition: all 0.3s ease;
        transform: translateX(-50%);
        border-radius: 2px;
    }

    .cycle-tab:hover {
        color: rgba(255, 255, 255, 0.8);
    }

    .cycle-tab:hover::after {
        width: 30%;
    }

    .cycle-tab.active {
        color: var(--color-teal);
        text-shadow: 0 0 20px rgba(0, 255, 198, 0.3);
    }

    .cycle-tab.active::after {
        width: 60%;
        box-shadow: 0 0 8px rgba(0, 255, 198, 0.5);
    }

    .cycle-tab i {
        margin-right: 0.5rem;
        transition: color 0.3s ease;
    }

    .cycle-tab.active i {
        color: var(--color-teal);
    }

    .cycle-tab[data-tab="readiness"] i {
        color: var(--color-blue);
    }

    .cycle-tab[data-tab="readiness"].active i {
        color: var(--color-blue);
        text-shadow: 0 0 10px rgba(0, 119, 255, 0.5);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ============== Section Cards (Compact) ============== */
    .section-card {
        background: rgba(26, 26, 26, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .section-title {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--color-teal);
        font-size: 0.85rem;
    }

    .section-title.power i { color: var(--color-green); }
    .section-title.sleep i { color: var(--color-blue); }
    .section-title.training i { color: var(--color-yellow); }

    /* ============== Training Recommendation Card ============== */
    .training-rec-card {
        border: 1px solid rgba(255, 193, 7, 0.2);
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(0, 0, 0, 0.3) 100%);
    }

    .section-title .btn-suggest {
        float: right;
        font-size: 0.7rem;
        padding: 0.25rem 0.6rem;
        background: linear-gradient(135deg, var(--color-yellow) 0%, #FF9800 100%);
        border: none;
        border-radius: 4px;
        color: #1a1a2e;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .section-title .btn-suggest:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
    }

    .section-title .btn-suggest:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .training-rec-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.5rem;
        color: var(--color-yellow);
        font-size: 0.8rem;
    }

    .training-rec-empty {
        text-align: center;
        padding: 1rem;
        color: var(--color-muted);
    }

    .training-rec-empty i {
        font-size: 1.5rem;
        color: var(--color-yellow);
        opacity: 0.5;
        margin-bottom: 0.5rem;
        display: block;
    }

    .training-rec-empty p {
        font-size: 0.75rem;
        line-height: 1.4;
        margin: 0;
    }

    .training-rec-content {
        padding: 0.5rem 0;
    }

    .training-rec-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .day-type-badge {
        background: var(--color-yellow);
        color: #1a1a2e;
        padding: 0.3rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .day-type-badge.rest {
        background: var(--color-blue);
        color: white;
    }

    .day-type-badge.z1 {
        background: #4CAF50;
        color: white;
    }

    .day-type-badge.z2 {
        background: var(--color-green);
        color: #1a1a2e;
    }

    .day-type-badge.hard {
        background: var(--color-red);
        color: white;
    }

    .intensity-tag {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-muted-light);
        text-transform: capitalize;
    }

    .intensity-tag.very_easy { color: #81C784; }
    .intensity-tag.easy { color: #4CAF50; }
    .intensity-tag.moderate { color: var(--color-yellow); }
    .intensity-tag.hard { color: var(--color-red); }

    .training-rec-details {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .rec-detail {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: var(--color-muted-light);
    }

    .rec-detail i {
        color: var(--color-teal);
        font-size: 0.7rem;
    }

    .training-rec-reason {
        font-size: 0.75rem;
        line-height: 1.5;
        color: var(--color-muted-light);
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 4px;
        margin-bottom: 0.75rem;
        border-left: 2px solid var(--color-yellow);
    }

    .training-rec-intervals {
        margin-bottom: 0.75rem;
    }

    .intervals-header {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--color-teal);
        margin-bottom: 0.5rem;
    }

    .intervals-list {
        font-size: 0.7rem;
        color: var(--color-muted-light);
    }

    .interval-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .interval-item:last-child {
        border-bottom: none;
    }

    .interval-kind {
        color: var(--color-yellow);
        font-weight: 500;
        min-width: 70px;
    }

    .interval-zone {
        font-weight: 600;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        background: rgba(0, 255, 198, 0.2);
        color: var(--color-teal);
    }

    .interval-targets {
        font-size: 0.6rem;
        color: var(--color-muted);
        margin-left: auto;
    }

    /* ============== Performance Targets Card ============== */
    .performance-targets-card {
        background: linear-gradient(135deg, rgba(0, 255, 198, 0.08) 0%, rgba(0, 119, 255, 0.05) 100%);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .targets-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.6rem;
    }

    .targets-icon {
        font-size: 1rem;
    }

    .targets-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--color-teal);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .targets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.5rem;
    }

    .target-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
    }

    .target-label {
        color: var(--color-muted-light);
    }

    .target-value {
        font-weight: 700;
    }

    .target-value.hr {
        color: #ff6b6b;
    }

    .target-value.power {
        color: #0ad3c7;
    }

    .target-value.zone {
        background: rgba(0, 255, 198, 0.2);
        color: var(--color-teal);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    /* ============== Enhanced Interval Rows ============== */
    .intervals-list-enhanced {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .interval-row {
        display: grid;
        grid-template-columns: 100px 1fr auto;
        gap: 0.75rem;
        align-items: center;
        padding: 0.6rem 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        border-left: 3px solid var(--color-muted);
    }

    .interval-row.warmup { border-left-color: #4CAF50; }
    .interval-row.steady { border-left-color: var(--color-teal); }
    .interval-row.interval { border-left-color: var(--color-red); }
    .interval-row.recovery { border-left-color: var(--color-blue); }
    .interval-row.cooldown { border-left-color: #4CAF50; }

    .interval-left {
        display: flex;
        flex-direction: column;
    }

    .interval-type {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .interval-type.warmup { color: #4CAF50; }
    .interval-type.steady { color: var(--color-teal); }
    .interval-type.interval { color: var(--color-red); }
    .interval-type.recovery { color: var(--color-blue); }
    .interval-type.cooldown { color: #4CAF50; }

    .interval-center {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .interval-duration {
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
    }

    .interval-zone-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        text-transform: uppercase;
    }

    .interval-zone-badge.Z1 {
        background: rgba(76, 175, 80, 0.25);
        color: #4CAF50;
    }

    .interval-zone-badge.Z2 {
        background: rgba(0, 255, 198, 0.2);
        color: var(--color-teal);
    }

    .interval-zone-badge.Z3 {
        background: rgba(255, 152, 0, 0.25);
        color: #FF9800;
    }

    .interval-zone-badge.Z4 {
        background: rgba(255, 82, 82, 0.25);
        color: var(--color-red);
    }

    .interval-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.2rem;
    }

    .interval-metric {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.75rem;
    }

    .interval-metric-label {
        color: var(--color-muted);
        font-size: 0.65rem;
        text-transform: uppercase;
    }

    .interval-metric-value {
        font-weight: 700;
    }

    .interval-metric-value.hr {
        color: #ff6b6b;
    }

    .interval-metric-value.power {
        color: #0ad3c7;
    }

    .interval-notes {
        grid-column: 1 / -1;
        font-size: 0.7rem;
        color: var(--color-muted);
        padding-top: 0.4rem;
        border-top: 1px dashed rgba(255, 255, 255, 0.1);
        margin-top: 0.3rem;
    }

    .interval-notes i {
        margin-right: 0.3rem;
        opacity: 0.7;
    }

    /* Responsive: Stack on mobile */
    @media (max-width: 576px) {
        .interval-row {
            grid-template-columns: 1fr;
            gap: 0.4rem;
        }

        .interval-left {
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
        }

        .interval-right {
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
        }

        .targets-grid {
            grid-template-columns: 1fr;
        }
    }

    .training-rec-flags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .rec-flag {
        font-size: 0.6rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
    }

    .rec-flag.positive {
        background: rgba(0, 230, 118, 0.2);
        color: var(--color-green);
    }

    .rec-flag.warning {
        background: rgba(255, 82, 82, 0.2);
        color: var(--color-red);
    }

    .training-rec-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .rec-cached-label {
        font-size: 0.6rem;
        color: var(--color-muted);
    }

    .btn-refresh-rec {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        background: transparent;
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 3px;
        color: var(--color-yellow);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-refresh-rec:hover {
        background: rgba(255, 193, 7, 0.1);
        border-color: var(--color-yellow);
    }

    /* AI Coach Button */
    .btn-coach {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.1) 100%);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: var(--color-yellow);
        padding: 0.25rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-coach:hover {
        background: rgba(255, 193, 7, 0.25);
        border-color: var(--color-yellow);
        transform: translateY(-1px);
    }

    .btn-outline-zyra {
        background: transparent;
        border: 1px solid rgba(0, 255, 198, 0.3);
        color: var(--color-teal);
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-outline-zyra:hover {
        background: rgba(0, 255, 198, 0.1);
        border-color: var(--color-teal);
    }

    .coach-date-selector {
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border: 1px solid rgba(255, 193, 7, 0.1);
    }

    /* Training Recommendation Mini (Day View) */
    .training-rec-mini {
        padding: 0.5rem;
    }

    .rec-mini-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .rec-mini-details {
        font-size: 0.75rem;
        color: var(--color-muted-light);
    }

    .rec-mini-details i {
        color: var(--color-teal);
    }

    .rec-mini-reason {
        font-size: 0.75rem;
        color: var(--color-muted-light);
        line-height: 1.4;
        margin: 0 0 0.5rem 0;
        padding: 0.4rem;
        background: rgba(255, 193, 7, 0.05);
        border-left: 2px solid var(--color-yellow);
        border-radius: 2px;
    }

    .rec-mini-intervals {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
    }

    .interval-chip {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        background: rgba(0, 255, 198, 0.1);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 3px;
        color: var(--color-teal);
    }

    /* ============== Grid Layouts ============== */
    .flex-layout {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (min-width: 992px) {
        .flex-layout {
            flex-direction: row;
        }

        .flex-layout > .flex-col-main {
            flex: 1;
            min-width: 0;
        }

        .flex-layout > .flex-col-side {
            width: 380px;
            flex-shrink: 0;
        }
    }

    /* ============== Upload Zone (Compact) ============== */
    .upload-zone {
        border: 2px dashed rgba(0, 255, 198, 0.25);
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 255, 198, 0.02);
    }

    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.06);
    }

    .upload-zone i {
        font-size: 2rem;
        color: var(--color-teal);
        margin-bottom: 0.5rem;
    }

    .upload-zone .title {
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.25rem;
    }

    .upload-zone .hint {
        color: var(--color-muted);
        font-size: 0.75rem;
    }

    /* File list */
    .file-list {
        margin-top: 0.75rem;
        max-height: 120px;
        overflow-y: auto;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.5rem;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        margin-bottom: 0.375rem;
        font-size: 0.8rem;
    }

    .file-item i { color: var(--color-teal); font-size: 0.75rem; }
    .file-item .filename {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--color-muted-light);
    }

    .file-item .remove-file {
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.125rem;
        font-size: 0.7rem;
    }

    .file-item .remove-file:hover { color: var(--color-red); }

    /* ============== Status Messages ============== */
    .status-msg {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        margin-top: 0.75rem;
    }

    .status-msg.loading {
        background: rgba(0, 255, 198, 0.1);
        color: var(--color-teal);
        border: 1px solid rgba(0, 255, 198, 0.2);
    }

    .status-msg.success {
        background: rgba(0, 230, 118, 0.1);
        color: var(--color-green);
        border: 1px solid rgba(0, 230, 118, 0.2);
    }

    .status-msg.error {
        background: rgba(255, 82, 82, 0.1);
        color: var(--color-red);
        border: 1px solid rgba(255, 82, 82, 0.2);
    }

    .status-msg i { font-size: 0.9rem; }

    /* ============== Empty States ============== */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--color-muted);
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin: 0;
    }

    .empty-state.power i { color: var(--color-green); }
    .empty-state.sleep i { color: var(--color-blue); }

    /* ============== Data Table (Compact) ============== */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -0.5rem;
        padding: 0 0.5rem;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .data-table th {
        color: var(--color-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
        white-space: nowrap;
    }

    .data-table td {
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        font-family: 'Roboto Mono', monospace;
        white-space: nowrap;
    }

    .data-table tr:hover {
        background: rgba(0, 255, 198, 0.03);
    }

    /* Placeholder values */
    .val-empty {
        color: var(--color-muted);
        font-size: 0.7rem;
    }

    .val-power { color: var(--color-green); }
    .val-hr { color: var(--color-red); }
    .val-tss { color: var(--color-yellow); }
    .val-time { color: var(--color-blue); }

    /* ============== Score Badge ============== */
    .score-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
    }

    .score-high { background: rgba(0, 230, 118, 0.2); color: var(--color-green); }
    .score-medium { background: rgba(255, 193, 7, 0.2); color: var(--color-yellow); }
    .score-low { background: rgba(255, 82, 82, 0.2); color: var(--color-red); }

    /* ============== Form Controls (Compact) ============== */
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.06);
        border-color: var(--color-teal);
        box-shadow: 0 0 0 2px rgba(0, 255, 198, 0.1);
        color: white;
    }

    .form-label {
        color: var(--color-muted-light);
        font-weight: 500;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    /* ============== Rating & Status Selectors ============== */
    .rating-selector, .status-selector {
        display: flex;
        gap: 0.25rem;
    }

    .rating-option, .status-option {
        flex: 1;
        padding: 0.4rem 0.25rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.02);
    }

    /* ============== Cardio Display ============== */
    .cardio-metric-display {
        background: rgba(255, 82, 82, 0.1);
        border: 1px solid rgba(255, 82, 82, 0.2);
        border-radius: 6px;
        padding: 0.4rem 0.5rem;
        text-align: center;
    }

    .cardio-metric-display .metric-label {
        display: block;
        font-size: 0.65rem;
        color: var(--color-muted-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cardio-metric-display .metric-value {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-red);
    }

    .auto-badge {
        font-size: 0.55rem;
        background: var(--color-teal);
        color: white;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        margin-left: 0.3rem;
        text-transform: uppercase;
        vertical-align: middle;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        color: var(--color-muted);
        font-size: 0.8rem;
    }

    /* ============== Collapsible Readiness Card ============== */
    .readiness-card {
        transition: all 0.3s ease;
    }
    
    .readiness-header {
        cursor: pointer;
    }
    
    .readiness-header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .readiness-date-label {
        font-size: 0.7rem;
        color: var(--color-muted-light);
        margin-left: 0.5rem;
        font-weight: 400;
    }
    
    .collapse-indicator {
        color: var(--color-muted);
        transition: transform 0.3s ease;
    }
    
    .readiness-card.collapsed .collapse-indicator {
        transform: rotate(-90deg);
    }
    
    .readiness-form-body {
        padding-top: 1rem;
        transition: all 0.3s ease;
        max-height: 1000px;
        overflow: hidden;
    }
    
    .readiness-card.collapsed .readiness-form-body {
        max-height: 0;
        padding-top: 0;
        opacity: 0;
        pointer-events: none;
    }
    
    /* Summary Pills */
    .readiness-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 0 0.25rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        margin-top: 0.5rem;
    }
    
    .summary-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }
    
    .summary-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.05);
        color: var(--color-muted-light);
    }
    
    .summary-pill.score {
        background: linear-gradient(135deg, var(--color-blue), var(--color-teal));
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
    }
    
    .summary-pill.score.score-high { background: linear-gradient(135deg, #00c853, #00ffc6); }
    .summary-pill.score.score-medium { background: linear-gradient(135deg, #ffc107, #ff9800); }
    .summary-pill.score.score-low { background: linear-gradient(135deg, #ff5252, #ff1744); }
    
    .summary-pill.hrv, .summary-pill.rhr {
        font-family: monospace;
    }
    
    .summary-pill.symptoms {
        background: rgba(255, 82, 82, 0.2);
        color: var(--color-red);
    }
    
    .edit-summary-btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        white-space: nowrap;
    }
    
    /* Override Controls */
    .cardio-metric-display .metric-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .auto-chip {
        font-size: 0.5rem;
        background: var(--color-teal);
        color: white;
        padding: 0.05rem 0.25rem;
        border-radius: 3px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .auto-chip.manual {
        background: var(--color-yellow);
        color: var(--color-dark);
    }
    
    .btn-override {
        background: none;
        border: none;
        color: var(--color-muted);
        padding: 0.1rem;
        font-size: 0.6rem;
        cursor: pointer;
        opacity: 0.6;
        transition: all 0.2s ease;
    }
    
    .btn-override:hover {
        color: var(--color-teal);
        opacity: 1;
    }
    
    .override-input {
        margin-top: 0.5rem;
    }
    
    .override-input input {
        font-size: 0.75rem;
        text-align: center;
    }
    
    .override-actions {
        text-align: center;
        margin-top: 0.25rem;
    }
    
    .override-actions .btn-link {
        font-size: 0.65rem;
        color: var(--color-muted);
        padding: 0;
        text-decoration: none;
    }
    
    .override-actions .btn-link:hover {
        color: var(--color-red);
    }
    
    /* Readiness History Expanded Table */
    .readiness-history-table {
        font-size: 0.75rem;
    }
    
    .readiness-history-table th {
        font-size: 0.65rem;
        text-align: center;
        padding: 0.3rem 0.25rem;
        white-space: nowrap;
    }
    
    .readiness-history-table td {
        text-align: center;
        padding: 0.35rem 0.25rem;
        vertical-align: middle;
    }
    
    .readiness-history-table .status-arrow {
        font-size: 0.85rem;
    }
    
    .readiness-history-table .status-arrow.positive { color: var(--color-teal); }
    .readiness-history-table .status-arrow.neutral { color: var(--color-yellow); }
    .readiness-history-table .status-arrow.negative { color: var(--color-red); }
    
    .readiness-history-table .edit-row-btn {
        color: var(--color-teal);
        cursor: pointer;
        padding: 0.2rem;
        background: none;
        border: none;
        font-size: 0.75rem;
    }
    
    .readiness-history-table .edit-row-btn:hover {
        color: var(--color-blue);
    }
    
    /* Mood emoji display */
    .mood-emoji { font-size: 0.9rem; }
    
    /* Compact cardio values */
    .cardio-value { 
        font-family: monospace; 
        font-size: 0.7rem; 
        color: var(--color-red);
    }
    
    .cardio-value.has-override {
        border-bottom: 1px dashed var(--color-yellow);
    }

    .rating-option:hover, .status-option:hover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.08);
    }

    .rating-option.selected {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.15);
        color: var(--color-teal);
    }

    .rating-option input, .status-option input { display: none; }

    .status-option.negative { color: var(--color-red); }
    .status-option.neutral { color: var(--color-yellow); }
    .status-option.positive { color: var(--color-teal); }

    .status-option.selected.negative { background: rgba(255, 82, 82, 0.15); border-color: var(--color-red); }
    .status-option.selected.neutral { background: rgba(255, 193, 7, 0.15); border-color: var(--color-yellow); }
    .status-option.selected.positive { background: rgba(0, 255, 198, 0.15); border-color: var(--color-teal); }

    /* ============== Buttons ============== */
    .btn-zyra {
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    .btn-zyra:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 119, 255, 0.3);
        color: white;
    }

    .btn-zyra:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Delete button */
    .btn-delete {
        background: transparent;
        border: none;
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }

    .btn-delete:hover {
        color: var(--color-red);
        background: rgba(255, 82, 82, 0.1);
    }

    /* ============== Chart Container ============== */
    .chart-container {
        position: relative;
        height: 220px;
    }

    @media (min-width: 768px) {
        .chart-container { height: 250px; }
    }

    .chart-container.compact {
        height: 180px;
    }

    /* ============== Loading Overlay ============== */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active { display: flex; }

    .spinner-zyra {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 255, 198, 0.2);
        border-top-color: var(--color-teal);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
        color: white;
        margin-top: 0.75rem;
        font-size: 0.85rem;
    }

    /* ============== Toast ============== */
    .toast-container {
        position: fixed;
        top: 70px;
        right: 0.75rem;
        z-index: 9999;
        max-width: 320px;
    }

    .toast-zyra {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid var(--color-teal);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        color: white;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        animation: slideIn 0.3s ease;
    }

    .toast-zyra.error { border-color: var(--color-red); }
    .toast-zyra.success { border-color: var(--color-green); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ============== Confirm Modal ============== */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .confirm-modal.active { display: flex; }

    .confirm-dialog {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 1.25rem;
        max-width: 320px;
        width: 90%;
        text-align: center;
    }

    .confirm-dialog h4 {
        color: white;
        font-size: 1rem;
        margin-bottom: 0.375rem;
    }

    .confirm-dialog p {
        color: var(--color-muted);
        font-size: 0.8rem;
        margin-bottom: 1.25rem;
    }

    .confirm-actions {
        display: flex;
        gap: 0.5rem;
    }

    .confirm-actions button {
        flex: 1;
    }

    /* ============== Large Modal Base (Review, Edit, Day View) ============== */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem 1rem;
        overflow-y: auto;
    }

    .modal-overlay.active { display: flex; }

    .modal-content {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: white;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--color-muted);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.25rem;
    }

    .modal-close:hover { color: white; }

    .modal-body { margin-bottom: 1.25rem; }

    .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    /* ============== Form Fields in Modals ============== */
    .modal-form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1rem;
    }

    @media (max-width: 500px) {
        .modal-form-grid { grid-template-columns: 1fr; }
    }

    .modal-field {
        display: flex;
        flex-direction: column;
    }

    .modal-field label {
        font-size: 0.75rem;
        color: var(--color-muted-light);
        margin-bottom: 0.25rem;
    }

    .modal-field input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        color: white;
        font-size: 0.85rem;
    }

    .modal-field input:focus {
        outline: none;
        border-color: var(--color-teal);
    }

    .modal-field input.missing {
        border-color: var(--color-yellow);
        background: rgba(255, 193, 7, 0.1);
    }

    .modal-field input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .modal-field-full { grid-column: span 2; }

    @media (max-width: 500px) {
        .modal-field-full { grid-column: span 1; }
    }

    /* ============== Section Headers in Modals ============== */
    .modal-section {
        margin-bottom: 1.25rem;
    }

    .modal-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-teal);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-section-title.power { color: var(--color-green); }
    .modal-section-title.sleep { color: var(--color-blue); }
    .modal-section-title.warning { color: var(--color-yellow); }

    /* ============== Review Modal Cards ============== */
    .review-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .review-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .review-card-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .review-card-type.cycling { color: var(--color-green); }
    .review-card-type.sleep { color: var(--color-blue); }

    .review-missing-badge {
        background: rgba(255, 193, 7, 0.2);
        color: var(--color-yellow);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    /* ============== Day View Panels ============== */
    .day-panel {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .day-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .day-panel-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .day-panel-title.cycling { color: var(--color-green); }
    .day-panel-title.readiness { color: var(--color-teal); }
    .day-panel-title.sleep { color: var(--color-blue); }

    .day-panel .empty-note {
        color: var(--color-muted);
        font-size: 0.8rem;
        font-style: italic;
    }

    .day-data-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 500px) {
        .day-data-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .day-data-item {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 0.5rem;
        text-align: center;
    }

    .day-data-item .label {
        font-size: 0.65rem;
        color: var(--color-muted);
        text-transform: uppercase;
    }

    .day-data-item .value {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
    }

    .day-data-item .value.missing {
        color: var(--color-yellow);
        font-style: italic;
    }

    .day-data-item .value.good { color: var(--color-green); }
    .day-data-item .value.hr { color: var(--color-red); }
    .day-data-item .value.sleep { color: var(--color-blue); }

    /* ============== Modal Buttons ============== */
    .btn-modal {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modal-primary {
        background: linear-gradient(135deg, var(--color-teal), var(--color-green));
        border: none;
        color: #0a0a0a;
    }

    .btn-modal-primary:hover { opacity: 0.9; }

    .btn-modal-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .btn-modal-secondary:hover { background: rgba(255, 255, 255, 0.15); }

    .btn-modal-warning {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid var(--color-yellow);
        color: var(--color-yellow);
    }

    .btn-modal-warning:hover { background: rgba(255, 193, 7, 0.3); }

    /* ============== Action buttons in tables ============== */
    .btn-edit {
        background: none;
        border: none;
        color: var(--color-teal);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
    }

    .btn-edit:hover { opacity: 1; }

    .btn-view-day {
        background: none;
        border: none;
        color: var(--color-blue);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .btn-view-day:hover { opacity: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
    }

    .btn-cancel:hover { background: rgba(255, 255, 255, 0.12); }

    .btn-confirm-delete {
        background: var(--color-red);
        border: none;
        color: white;
    }

    .btn-confirm-delete:hover { background: #FF3333; }

    /* ============== Extraction Results ============== */
    .extraction-results { margin-top: 0.75rem; }

    .extraction-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        padding: 0.5rem 0.625rem;
        margin-bottom: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
    }

    .extraction-item.cycling { border-left: 3px solid var(--color-green); }
    .extraction-item.sleep { border-left: 3px solid var(--color-blue); }
    .extraction-item.unknown { border-left: 3px solid var(--color-yellow); }
    .extraction-item.error { border-left: 3px solid var(--color-red); }

    .extraction-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .extraction-item.cycling .extraction-icon { background: rgba(0, 230, 118, 0.15); color: var(--color-green); }
    .extraction-item.sleep .extraction-icon { background: rgba(0, 119, 255, 0.15); color: var(--color-blue); }
    .extraction-item.unknown .extraction-icon { background: rgba(255, 193, 7, 0.15); color: var(--color-yellow); }
    .extraction-item.error .extraction-icon { background: rgba(255, 82, 82, 0.15); color: var(--color-red); }

    .extraction-details { flex: 1; min-width: 0; }

    .extraction-filename {
        font-size: 0.7rem;
        color: var(--color-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .extraction-type { font-weight: 600; font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="cycle-container py-3">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-zyra"></div>
        <p class="loading-text">Processing screenshots...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <h4><i class="fas fa-exclamation-triangle text-warning me-2"></i><span id="confirmModalTitle">Delete?</span></h4>
            <p>This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Review Missing Data Modal -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit me-2"></i>Review Extracted Data</h3>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-muted-light); font-size: 0.85rem; margin-bottom: 1rem;">
                    Some fields could not be extracted. Review and fill in missing values below (yellow highlight).
                </p>
                <div id="reviewContent">
                    <!-- Filled dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="skipReviewAndSave()">Skip & Save As-Is</button>
                <button class="btn-modal btn-modal-primary" onclick="saveReviewedData()">
                    <i class="fas fa-save me-1"></i>Save Corrected Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="editWorkoutModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bicycle me-2" style="color: var(--color-green)"></i>Edit Workout</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWorkoutId">
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Date</label>
                        <input type="date" id="editDate" name="date">
                    </div>
                    <div class="modal-field">
                        <label>Duration (mm:ss)</label>
                        <input type="text" id="editDuration" placeholder="30:00" pattern="\d+:\d{2}">
                    </div>
                    <div class="modal-field">
                        <label>Avg Power (W)</label>
                        <input type="number" id="editAvgPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Max Power (W)</label>
                        <input type="number" id="editMaxPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Normalized Power (W)</label>
                        <input type="number" id="editNormalizedPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Intensity Factor</label>
                        <input type="number" id="editIF" step="0.01" min="0" max="2">
                    </div>
                    <div class="modal-field">
                        <label>TSS</label>
                        <input type="number" id="editTSS" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Avg Heart Rate (bpm)</label>
                        <input type="number" id="editAvgHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Max Heart Rate (bpm)</label>
                        <input type="number" id="editMaxHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Avg Cadence (rpm)</label>
                        <input type="number" id="editCadence" min="0" max="200">
                    </div>
                    <div class="modal-field">
                        <label>Distance (km)</label>
                        <input type="number" id="editDistance" step="0.01">
                    </div>
                    <div class="modal-field">
                        <label>Active Calories</label>
                        <input type="number" id="editKcalActive">
                    </div>
                    <div class="modal-field">
                        <label>Total Calories</label>
                        <input type="number" id="editKcalTotal">
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedWorkout()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Readiness Modal -->
    <div id="editReadinessModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-sun me-2" style="color: var(--color-teal)"></i>Edit Readiness Entry</h3>
                <button class="modal-close" onclick="closeEditReadinessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editReadinessId">
                <input type="hidden" id="editReadinessDate">
                <p style="color: var(--color-muted); font-size: 0.75rem; margin-bottom: 1rem;">
                    Edit subjective readiness inputs. Sleep/cardio data is managed via screenshot imports.
                </p>
                
                <!-- Cardio Data Display in Edit Modal -->
                <div id="editCardioDisplay" style="display: none; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">Resting HR</span>
                            <span class="metric-value" id="editDisplayRhr">--</span>
                        </div>
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">HRV</span>
                            <span class="metric-value" id="editDisplayHrv">--</span>
                        </div>
                    </div>
                    <p style="color: var(--color-muted); font-size: 0.65rem; text-align: center;">
                        <i class="fas fa-magic me-1"></i>Status auto-calculated from 14-day baseline
                    </p>
                </div>
                
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Energy (1-5)</label>
                        <select id="editReadinessEnergy" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3">3 - Normal</option>
                            <option value="4">4 - Good</option>
                            <option value="5">5 - Great</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Mood (1-3)</label>
                        <select id="editReadinessMood" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - </option>
                            <option value="2">2 - </option>
                            <option value="3">3 - </option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Muscle Fatigue (1-3)</label>
                        <select id="editReadinessFatigue" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>HRV Status <span id="editHrvAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessHRV" class="form-select">
                            <option value="">--</option>
                            <option value="-1"> Below Baseline</option>
                            <option value="0"> Normal</option>
                            <option value="1"> Above Baseline</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>RHR Status <span id="editRhrAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessRHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1"> Below Normal (good)</option>
                            <option value="0"> Normal</option>
                            <option value="1"> Above Normal</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Min HR Status</label>
                        <select id="editReadinessMinHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1"> Lower than usual</option>
                            <option value="0"> Normal</option>
                            <option value="1"> Higher than usual</option>
                        </select>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>
                            <input type="checkbox" id="editReadinessSymptoms" style="margin-right: 0.5rem;">
                            Experiencing symptoms (illness, injury, etc.)
                        </label>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editReadinessNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditReadinessModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedReadiness()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Daily Expanded View Modal -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day me-2"></i>Day Summary: <span id="dayViewDate"></span></h3>
                <button class="modal-close" onclick="closeDayViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dayViewContent">
                    <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeDayViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="cycle-hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1><i class="fas fa-bicycle me-2"></i>Zyra Cycle</h1>
                <p class="subtitle">Cycling performance & morning readiness</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <a href="{{ url_for('cycling_readiness.expanded_table') }}" class="btn-expanded-link" title="View all data in expanded table">
                    <i class="fas fa-table me-1"></i>Expanded View
                </a>
                <span class="date-badge">
                    <i class="fas fa-calendar-day me-1"></i>{{ today }}
                </span>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ cycling_stats.total_workouts or 0 }}</div>
            <div class="stat-label">Workouts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value tss">{{ "%.0f"|format(cycling_stats.total_tss or 0) }}</div>
            <div class="stat-label">Total TSS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.0f"|format(cycling_stats.avg_power or 0) }}W</div>
            <div class="stat-label">Avg Power</div>
        </div>
        <div class="stat-card">
            <div class="stat-value time">{{ "%.0f"|format((cycling_stats.total_duration_sec or 0) / 3600) }}h</div>
            <div class="stat-label">Total Time</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="cycle-tabs">
        <button class="cycle-tab active" data-tab="workouts">
            <i class="fas fa-bicycle"></i>Workouts
        </button>
        <button class="cycle-tab" data-tab="readiness">
            <i class="fas fa-moon"></i>Readiness & Sleep
        </button>
        <button class="cycle-tab" data-tab="coach">
            <i class="fas fa-brain"></i>AI Coach
        </button>
    </div>

    <!-- Tab: Workouts -->
    <div id="workoutsTab" class="tab-content active">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Import Section -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-cloud-upload-alt"></i>Import Screenshots
                    </h3>
                    <form id="bundleUploadForm" enctype="multipart/form-data">
                        <div class="upload-zone" id="bundleUploadZone">
                            <i class="fas fa-images"></i>
                            <p class="title">Drop screenshots here</p>
                            <p class="hint">Cycling app, Apple Watch, Sleep data</p>
                            <input type="file" id="bundleImageInput" name="images" accept="image/*" multiple class="d-none">
                        </div>
                        <div id="fileListContainer" class="file-list d-none"></div>
                        <div id="statusMessage" class="d-none"></div>
                        <div id="uploadActions" class="d-none mt-2">
                            <button type="submit" class="btn btn-zyra w-100" id="uploadBtn">
                                <i class="fas fa-magic me-1"></i>Extract & Merge
                            </button>
                        </div>
                        <div id="extractionResults" class="extraction-results d-none"></div>
                    </form>
                </div>

                <!-- Recent Workouts Table -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-list"></i>Recent Workouts
                    </h3>
                    {% if cycling_workouts %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Power</th>
                                    <th>Avg HR</th>
                                    <th>Max HR</th>
                                    <th>TSS</th>
                                    <th>Coach</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cyclingTableBody">
                                {% for workout in cycling_workouts %}
                                <tr data-workout-id="{{ workout.id }}" data-workout-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                                    <td>
                                        <button class="btn-view-day" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="View Day Details">
                                            {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                                        </button>
                                    </td>
                                    <td class="val-time">{{ "%d:%02d"|format((workout.duration_sec or 0) // 60, (workout.duration_sec or 0) % 60) if workout.duration_sec else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td class="val-power">{{ "%.0f"|format(workout.avg_power_w) if workout.avg_power_w else '<span class="val-empty">--</span>' | safe }}{{ 'W' if workout.avg_power_w else '' }}</td>
                                    <td class="val-hr">{{ workout.avg_heart_rate if workout.avg_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.avg_heart_rate else '' }}</td>
                                    <td class="val-hr">{{ workout.max_heart_rate if workout.max_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.max_heart_rate else '' }}</td>
                                    <td class="val-tss">{{ "%.0f"|format(workout.tss) if workout.tss else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td>
                                        <button class="btn-coach" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="Get AI Coach recommendation">
                                            <i class="fas fa-brain"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn-edit btn-edit-workout" data-id="{{ workout.id }}" title="Edit Workout">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn-delete btn-delete-workout" data-id="{{ workout.id }}" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-bicycle"></i>
                        <p>No workouts imported yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Performance Trends Chart -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-chart-line"></i>Performance Trends
                    </h3>
                    {% if cycling_chart.dates and cycling_chart.dates|length > 0 %}
                    <div class="chart-container">
                        <canvas id="cyclingChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-chart-area"></i>
                        <p>No data yet. Upload screenshots to see your performance trend.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Readiness & Sleep -->
    <div id="readinessTab" class="tab-content">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Morning Readiness - Collapsible Card -->
                <div class="section-card readiness-card" id="morningReadinessCard">
                    <!-- Card Header - Always visible -->
                    <div class="readiness-header" id="readinessHeader">
                        <div class="readiness-header-content" onclick="toggleReadinessForm()">
                            <h3 class="section-title sleep mb-0">
                                <i class="fas fa-sun"></i>Morning Readiness
                                <span class="readiness-date-label" id="readinessDateLabel"></span>
                            </h3>
                            <span class="collapse-indicator" id="collapseIndicator">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </div>
                        
                        <!-- Summary View (shown when collapsed) -->
                        <div class="readiness-summary" id="readinessSummary" style="display: none;">
                            <div class="summary-pills">
                                <span class="summary-pill score" id="summaryScore" title="Readiness Score">--</span>
                                <span class="summary-pill energy" id="summaryEnergy" title="Energy"> --</span>
                                <span class="summary-pill mood" id="summaryMood" title="Mood"></span>
                                <span class="summary-pill fatigue" id="summaryFatigue" title="Muscle Fatigue"> --</span>
                                <span class="summary-pill hrv" id="summaryHrv" title="HRV Status">HRV </span>
                                <span class="summary-pill rhr" id="summaryRhr" title="RHR Status">RHR </span>
                                <span class="summary-pill symptoms" id="summarySymptoms" title="Symptoms" style="display: none;"></span>
                            </div>
                            <button class="btn btn-sm btn-outline-zyra edit-summary-btn" onclick="event.stopPropagation(); editReadinessForDate()" title="Edit">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                        </div>
                    </div>
                    
                    <!-- Form Body (collapsible) -->
                    <div class="readiness-form-body" id="readinessFormBody">
                        <form id="readinessForm">
                            <input type="hidden" id="readinessDate" name="date" value="{{ today }}">
                            <input type="hidden" id="readinessEntryId" value="">

                            <!-- Energy -->
                            <div class="mb-2">
                                <label class="form-label">Energy Level</label>
                                <div class="rating-selector" data-field="energy">
                                    {% for i in range(1, 6) %}
                                    <label class="rating-option"><input type="radio" name="energy" value="{{ i }}">{{ i }}</label>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Mood -->
                            <div class="mb-2">
                                <label class="form-label">Mood</label>
                                <div class="rating-selector" data-field="mood">
                                    <label class="rating-option"><input type="radio" name="mood" value="1"></label>
                                    <label class="rating-option"><input type="radio" name="mood" value="2"></label>
                                    <label class="rating-option"><input type="radio" name="mood" value="3"></label>
                                </div>
                            </div>

                            <!-- Muscle Fatigue -->
                            <div class="mb-2">
                                <label class="form-label">Muscle Fatigue</label>
                                <div class="rating-selector" data-field="muscle_fatigue">
                                    <label class="rating-option"><input type="radio" name="muscle_fatigue" value="1">Low</label>
                                    <label class="rating-option"><input type="radio" name="muscle_fatigue" value="2">Med</label>
                                    <label class="rating-option"><input type="radio" name="muscle_fatigue" value="3">High</label>
                                </div>
                            </div>

                            <!-- HRV & RHR Section -->
                            <div class="cardio-status-section mb-3" id="cardioStatusSection">
                                <!-- Cardio Data Display (shown when data exists) -->
                                <div id="cardioDataDisplay" style="display: none;">
                                    <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                        <i class="fas fa-heartbeat me-1" style="color: var(--color-red);"></i>Cardio metrics
                                    </p>
                                    <div class="row mb-2">
                                        <div class="col-6">
                                            <div class="cardio-metric-display" id="rhrCardioCard">
                                                <div class="metric-header">
                                                    <span class="metric-label">Resting HR</span>
                                                    <span class="auto-chip" id="rhrAutoChip">AUTO</span>
                                                    <button type="button" class="btn-override" id="rhrOverrideBtn" onclick="toggleCardioOverride('rhr')" title="Override">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </button>
                                                </div>
                                                <span class="metric-value" id="displayRhrBpm">--</span>
                                                <!-- Override input (hidden by default) -->
                                                <div class="override-input" id="rhrOverrideInput" style="display: none;">
                                                    <input type="number" class="form-control form-control-sm" id="overrideRhrBpm" 
                                                           placeholder="bpm" min="40" max="120">
                                                    <div class="override-actions">
                                                        <button type="button" class="btn btn-xs btn-link" onclick="resetCardioToAuto('rhr')">Reset</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="cardio-metric-display" id="hrvCardioCard">
                                                <div class="metric-header">
                                                    <span class="metric-label">HRV</span>
                                                    <span class="auto-chip" id="hrvAutoChip">AUTO</span>
                                                    <button type="button" class="btn-override" id="hrvOverrideBtn" onclick="toggleCardioOverride('hrv')" title="Override">
                                                        <i class="fas fa-pencil-alt"></i>
                                                    </button>
                                                </div>
                                                <span class="metric-value" id="displayHrv">--</span>
                                                <!-- Override input (hidden by default) -->
                                                <div class="override-input" id="hrvOverrideInput" style="display: none;">
                                                    <div class="d-flex gap-1">
                                                        <input type="number" class="form-control form-control-sm" id="overrideHrvLow" 
                                                               placeholder="low" min="1" max="200" style="width: 60px;">
                                                        <span style="color: var(--color-muted);"></span>
                                                        <input type="number" class="form-control form-control-sm" id="overrideHrvHigh" 
                                                               placeholder="high" min="1" max="200" style="width: 60px;">
                                                    </div>
                                                    <div class="override-actions">
                                                        <button type="button" class="btn btn-xs btn-link" onclick="resetCardioToAuto('hrv')">Reset</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Manual Cardio Input (shown when no data) -->
                                <div id="manualCardioInput" style="display: none;">
                                    <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                        <i class="fas fa-edit me-1"></i>No cardio data - enter manually (optional)
                                    </p>
                                    <div class="row mb-2">
                                        <div class="col-4">
                                            <input type="number" class="form-control form-control-sm" id="manualRhrBpm" 
                                                   placeholder="RHR (bpm)" min="40" max="120" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-4">
                                            <input type="number" class="form-control form-control-sm" id="manualHrvLow" 
                                                   placeholder="HRV low" min="1" max="200" style="font-size: 0.75rem;">
                                        </div>
                                        <div class="col-4">
                                            <input type="number" class="form-control form-control-sm" id="manualHrvHigh" 
                                                   placeholder="HRV high" min="1" max="200" style="font-size: 0.75rem;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Status Selectors -->
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <label class="form-label">
                                            HRV Status
                                            <span class="auto-badge" id="hrvAutoLabel" style="display: none;">auto</span>
                                        </label>
                                        <div class="status-selector" data-field="hrv_status">
                                            <label class="status-option negative"><input type="radio" name="hrv_status" value="-1"></label>
                                            <label class="status-option neutral"><input type="radio" name="hrv_status" value="0"></label>
                                            <label class="status-option positive"><input type="radio" name="hrv_status" value="1"></label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">
                                            RHR Status
                                            <span class="auto-badge" id="rhrAutoLabel" style="display: none;">auto</span>
                                        </label>
                                        <div class="status-selector" data-field="rhr_status">
                                            <label class="status-option positive"><input type="radio" name="rhr_status" value="-1"></label>
                                            <label class="status-option neutral"><input type="radio" name="rhr_status" value="0"></label>
                                            <label class="status-option negative"><input type="radio" name="rhr_status" value="1"></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sleep Note -->
                            <p class="text-muted small mb-3" style="font-size: 0.7rem; opacity: 0.7;">
                                <i class="fas fa-info-circle me-1"></i>Sleep data is imported from screenshots
                            </p>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="symptomsFlag" name="symptoms_flag">
                                    <label class="form-check-label" style="font-size: 0.8rem; color: var(--color-muted-light);" for="symptomsFlag">
                                        Experiencing symptoms
                                    </label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-zyra w-100">
                                <i class="fas fa-save me-1"></i>Save Readiness
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Readiness History - Expanded Table -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-history"></i>Readiness History
                        <span class="score-info">
                            <button class="score-info-icon" onclick="toggleScoreTooltip()" title="How is the score calculated?">
                                <i class="fas fa-question-circle"></i>
                            </button>
                            <div class="score-tooltip" id="scoreTooltip">
                                <h4>Readiness Score Formula</h4>
                                <p class="category">Subjective Inputs (40 pts max):</p>
                                <ul>
                                    <li> Energy (1-5): up to 20 pts</li>
                                    <li> Mood (1-3): up to 10 pts</li>
                                    <li> Muscle Fatigue (1-3): up to 10 pts</li>
                                </ul>
                                <p class="category">Recovery (25 pts max):</p>
                                <ul>
                                    <li> HRV Status: up to 10 pts</li>
                                    <li> RHR Status: up to 10 pts</li>
                                    <li> Min HR Status: up to 5 pts</li>
                                </ul>
                                <p class="category">Sleep (25 pts max):</p>
                                <ul>
                                    <li> Duration: up to 10 pts (7-9h optimal)</li>
                                    <li> Deep Sleep: up to 10 pts (60-120min)</li>
                                    <li> Awake Time: up to 5 pts</li>
                                </ul>
                                <p style="color: var(--color-red); margin-top: 0.5rem;">Symptoms: -10 pts if present</p>
                            </div>
                        </span>
                    </h3>
                    <div class="table-responsive" id="readinessHistoryContainer">
                        <table class="data-table readiness-history-table" id="readinessHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th title="Energy"></th>
                                    <th title="Mood"></th>
                                    <th title="Fatigue"></th>
                                    <th title="Sleep"></th>
                                    <th title="RHR">RHR</th>
                                    <th title="HRV">HRV</th>
                                    <th title="HRV Status">H</th>
                                    <th title="RHR Status">R</th>
                                    <th title="Symptoms"></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="readinessHistoryBody">
                                <!-- Will be populated via JavaScript -->
                            </tbody>
                        </table>
                        <div class="empty-state sleep" id="readinessHistoryEmpty" style="display: none;">
                            <i class="fas fa-bed"></i>
                            <p>No readiness entries yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Readiness Trend Chart -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-chart-area"></i>Readiness Trend
                    </h3>
                    {% if readiness_chart.dates and readiness_chart.dates|length > 0 %}
                    <div class="chart-container compact">
                        <canvas id="readinessChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state sleep">
                        <i class="fas fa-chart-line"></i>
                        <p>No readiness data yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: AI Coach -->
    <div id="coachTab" class="tab-content">
        <div class="section-card training-rec-card">
            <h3 class="section-title training">
                <i class="fas fa-brain"></i>AI Training Coach
            </h3>
            
            <!-- Date Selector -->
            <div class="coach-date-selector mb-3">
                <label class="form-label" style="font-size: 0.75rem; color: var(--color-muted-light);">
                    Select date to analyze
                </label>
                <div class="d-flex gap-2 align-items-center">
                    <input type="date" class="form-control form-control-sm" id="coachDate" 
                           value="{{ today }}" style="max-width: 180px; font-size: 0.8rem;">
                    <button class="btn btn-zyra" id="analyzeBtn" style="font-size: 0.8rem; padding: 0.4rem 1rem;">
                        <i class="fas fa-magic me-1"></i>Analyze This Day
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="coachLoading" class="training-rec-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Analyzing your data...</span>
            </div>
            
            <!-- Empty State -->
            <div id="coachEmpty" class="training-rec-empty">
                <i class="fas fa-lightbulb"></i>
                <p>Select a date and click "Analyze This Day" to get AI-powered training recommendations based on your readiness, sleep, and workout history.</p>
            </div>
            
            <!-- Recommendation Content -->
            <div id="coachContent" class="training-rec-content" style="display: none;">
                <div class="training-rec-header">
                    <span class="day-type-badge" id="coachDayTypeBadge">--</span>
                    <span class="intensity-tag" id="coachIntensityTag">--</span>
                    <button class="btn-refresh-rec ms-auto" id="coachRefreshBtn" title="Refresh recommendation">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="training-rec-details">
                    <div class="rec-detail">
                        <i class="fas fa-clock"></i>
                        <span id="coachDuration">--</span>
                    </div>
                    <div class="rec-detail">
                        <i class="fas fa-calendar"></i>
                        <span id="coachDateLabel">--</span>
                    </div>
                </div>
                
                <div class="training-rec-reason" id="coachReason">
                    <!-- Reason text will be inserted here -->
                </div>
                
                <!-- Performance Targets Card -->
                <div class="performance-targets-card" id="coachTargetsCard" style="display: none;">
                    <div class="targets-header">
                        <span class="targets-icon"></span>
                        <span class="targets-title">Performance Targets (AI Estimated)</span>
                    </div>
                    <div class="targets-grid" id="coachTargetsGrid">
                        <!-- Targets will be inserted here -->
                    </div>
                </div>
                
                <!-- Session Plan with enhanced intervals -->
                <div class="training-rec-intervals" id="coachIntervals" style="display: none;">
                    <div class="intervals-header">
                        <i class="fas fa-list-ol"></i> Session Plan
                    </div>
                    <div class="intervals-list-enhanced" id="coachIntervalsList">
                        <!-- Intervals will be inserted here -->
                    </div>
                </div>
                
                <div class="training-rec-flags" id="coachFlags" style="display: none;">
                    <!-- Flags will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Recent AI Recommendations -->
        <div class="section-card mt-3">
            <h3 class="section-title">
                <i class="fas fa-history"></i>Quick Access
            </h3>
            <p class="text-muted small mb-2" style="font-size: 0.7rem;">
                Click on a date from Recent Workouts or Expanded Table to analyze that day.
            </p>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-zyra btn-sm quick-date-btn" data-date="{{ today }}">
                    Today
                </button>
                {% for workout in cycling_workouts[:5] %}
                <button class="btn btn-outline-zyra btn-sm quick-date-btn" 
                        data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                    {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============== Toast Helper ==============
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-zyra ${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // ============== Status Message Helper ==============
    function showStatus(type, message) {
        const el = document.getElementById('statusMessage');
        el.className = `status-msg ${type}`;
        const icon = type === 'loading' ? 'fa-spinner fa-spin' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        el.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        el.classList.remove('d-none');
    }

    function hideStatus() {
        document.getElementById('statusMessage').classList.add('d-none');
    }

    // ============== Loading Overlay ==============
    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading(text = 'Processing screenshots...') {
        loadingOverlay.querySelector('.loading-text').textContent = text;
        loadingOverlay.classList.add('active');
    }
    function hideLoading() { loadingOverlay.classList.remove('active'); }

    // ============== Tab Switching ==============
    document.querySelectorAll('.cycle-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.cycle-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
    });

    // ============== Rating Selectors ==============
    document.querySelectorAll('.rating-selector, .status-selector').forEach(selector => {
        selector.querySelectorAll('.rating-option, .status-option').forEach(option => {
            option.addEventListener('click', function() {
                selector.querySelectorAll('.rating-option, .status-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });
    });

    // ============== Morning Readiness - Collapse/Expand ==============
    let hasCardioData = false;
    let autoHrvStatus = null;
    let autoRhrStatus = null;
    let currentReadinessData = null;
    let rhrManualOverride = false;
    let hrvManualOverride = false;
    let originalRhrBpm = null;
    let originalHrvLow = null;
    let originalHrvHigh = null;

    // Toggle collapse/expand of Morning Readiness form
    function toggleReadinessForm() {
        const card = document.getElementById('morningReadinessCard');
        const summary = document.getElementById('readinessSummary');
        const formBody = document.getElementById('readinessFormBody');
        
        if (card.classList.contains('collapsed')) {
            // Expand
            card.classList.remove('collapsed');
            summary.style.display = 'none';
        } else {
            // Collapse (only if we have readiness data)
            if (currentReadinessData && currentReadinessData.has_readiness) {
                card.classList.add('collapsed');
                summary.style.display = 'flex';
            }
        }
    }
    
    // Edit readiness for current date
    function editReadinessForDate() {
        const card = document.getElementById('morningReadinessCard');
        card.classList.remove('collapsed');
        document.getElementById('readinessSummary').style.display = 'none';
        // Scroll to form
        card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Update the summary pills display
    function updateReadinessSummary(data) {
        if (!data || !data.has_readiness) return;
        
        const r = data.readiness;
        const c = data.cardio;
        
        // Score
        const scoreEl = document.getElementById('summaryScore');
        if (r.morning_score) {
            scoreEl.textContent = r.morning_score;
            scoreEl.classList.remove('score-high', 'score-medium', 'score-low');
            if (r.morning_score >= 70) scoreEl.classList.add('score-high');
            else if (r.morning_score >= 40) scoreEl.classList.add('score-medium');
            else scoreEl.classList.add('score-low');
        } else {
            scoreEl.textContent = '--';
        }
        
        // Energy
        document.getElementById('summaryEnergy').textContent = ` ${r.energy || '--'}`;
        
        // Mood
        const moodEmojis = { 1: '', 2: '', 3: '' };
        document.getElementById('summaryMood').textContent = moodEmojis[r.mood] || '';
        
        // Fatigue
        const fatigueLabels = { 1: 'Low', 2: 'Med', 3: 'High' };
        document.getElementById('summaryFatigue').textContent = ` ${fatigueLabels[r.muscle_fatigue] || '--'}`;
        
        // HRV Status
        const hrvArrows = { '-1': '', 0: '', 1: '' };
        document.getElementById('summaryHrv').textContent = `HRV ${hrvArrows[r.hrv_status] || ''}`;
        
        // RHR Status
        document.getElementById('summaryRhr').textContent = `RHR ${hrvArrows[r.rhr_status] || ''}`;
        
        // Symptoms
        const symptomsEl = document.getElementById('summarySymptoms');
        symptomsEl.style.display = r.symptoms_flag ? 'inline-flex' : 'none';
    }
    
    // Update the date label in the header
    function updateDateLabel(dateStr) {
        const label = document.getElementById('readinessDateLabel');
        if (dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateOnly = new Date(dateStr + 'T00:00:00');
            
            if (dateOnly.getTime() === today.getTime()) {
                label.textContent = '(Today)';
            } else {
                label.textContent = `(${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
            }
        }
    }

    // Load full readiness data for a date
    async function loadFullReadinessData(date) {
        try {
            const response = await fetch(`/cycling-readiness/api/readiness/full?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                currentReadinessData = data;
                hasCardioData = data.has_cardio;
                
                updateDateLabel(date);
                
                const card = document.getElementById('morningReadinessCard');
                const cardioDisplay = document.getElementById('cardioDataDisplay');
                const manualInput = document.getElementById('manualCardioInput');
                const hrvAutoLabel = document.getElementById('hrvAutoLabel');
                const rhrAutoLabel = document.getElementById('rhrAutoLabel');
                
                // Store original cardio values
                if (data.cardio) {
                    originalRhrBpm = data.cardio.rhr_bpm;
                    originalHrvLow = data.cardio.hrv_low_ms;
                    originalHrvHigh = data.cardio.hrv_high_ms;
                    rhrManualOverride = data.cardio.rhr_manual_override;
                    hrvManualOverride = data.cardio.hrv_manual_override;
                }
                
                if (data.has_cardio) {
                    cardioDisplay.style.display = 'block';
                    manualInput.style.display = 'none';
                    
                    // Display RHR
                    const rhrDisplay = document.getElementById('displayRhrBpm');
                    rhrDisplay.textContent = data.cardio.rhr_bpm ? `${data.cardio.rhr_bpm} bpm` : '--';
                    
                    // Display HRV
                    const hrvDisplay = document.getElementById('displayHrv');
                    if (data.cardio.hrv_low_ms && data.cardio.hrv_high_ms) {
                        if (data.cardio.hrv_low_ms === data.cardio.hrv_high_ms) {
                            hrvDisplay.textContent = `${data.cardio.hrv_low_ms} ms`;
                        } else {
                            hrvDisplay.textContent = `${data.cardio.hrv_low_ms}${data.cardio.hrv_high_ms} ms`;
                        }
                    } else {
                        hrvDisplay.textContent = '--';
                    }
                    
                    // Update override chips
                    updateOverrideChip('rhr', data.cardio.rhr_manual_override);
                    updateOverrideChip('hrv', data.cardio.hrv_manual_override);
                    
                    // Auto-select status buttons
                    autoHrvStatus = data.calculated_status.hrv_status;
                    autoRhrStatus = data.calculated_status.rhr_status;
                    
                    if (autoHrvStatus !== null) {
                        selectStatusButton('hrv_status', autoHrvStatus);
                        hrvAutoLabel.style.display = 'inline';
                    }
                    
                    if (autoRhrStatus !== null) {
                        selectStatusButton('rhr_status', autoRhrStatus);
                        rhrAutoLabel.style.display = 'inline';
                    }
                } else {
                    cardioDisplay.style.display = 'none';
                    manualInput.style.display = 'block';
                    hrvAutoLabel.style.display = 'none';
                    rhrAutoLabel.style.display = 'none';
                }
                
                // If there's existing readiness data, prefill the form
                if (data.has_readiness && data.readiness) {
                    prefillReadinessForm(data.readiness);
                    updateReadinessSummary(data);
                    // Collapse the form by default
                    card.classList.add('collapsed');
                    document.getElementById('readinessSummary').style.display = 'flex';
                } else {
                    // Clear form and expand
                    clearReadinessForm();
                    card.classList.remove('collapsed');
                    document.getElementById('readinessSummary').style.display = 'none';
                }
            }
        } catch (err) {
            console.error('Error loading full readiness data:', err);
        }
    }
    
    // Helper to select a status button
    function selectStatusButton(name, value) {
        const radio = document.querySelector(`[name="${name}"][value="${value}"]`);
        if (radio) {
            document.querySelectorAll(`[name="${name}"]`).forEach(r => {
                r.checked = false;
                r.closest('.status-option').classList.remove('selected');
            });
            radio.checked = true;
            radio.closest('.status-option').classList.add('selected');
        }
    }
    
    // Update override chip display
    function updateOverrideChip(type, isManual) {
        const chip = document.getElementById(`${type}AutoChip`);
        if (chip) {
            if (isManual) {
                chip.textContent = 'MANUAL';
                chip.classList.add('manual');
            } else {
                chip.textContent = 'AUTO';
                chip.classList.remove('manual');
            }
        }
    }
    
    // Toggle cardio override mode
    function toggleCardioOverride(type) {
        const inputDiv = document.getElementById(`${type}OverrideInput`);
        const valueSpan = document.getElementById(`display${type === 'rhr' ? 'RhrBpm' : 'Hrv'}`);
        
        if (inputDiv.style.display === 'none') {
            // Show override input
            inputDiv.style.display = 'block';
            valueSpan.style.display = 'none';
            
            // Pre-fill with current values
            if (type === 'rhr' && originalRhrBpm) {
                document.getElementById('overrideRhrBpm').value = originalRhrBpm;
            } else if (type === 'hrv') {
                if (originalHrvLow) document.getElementById('overrideHrvLow').value = originalHrvLow;
                if (originalHrvHigh) document.getElementById('overrideHrvHigh').value = originalHrvHigh;
            }
        } else {
            // Hide override input
            inputDiv.style.display = 'none';
            valueSpan.style.display = 'block';
        }
    }
    
    // Reset cardio value to auto
    function resetCardioToAuto(type) {
        const inputDiv = document.getElementById(`${type}OverrideInput`);
        const valueSpan = document.getElementById(`display${type === 'rhr' ? 'RhrBpm' : 'Hrv'}`);
        
        // Hide override input
        inputDiv.style.display = 'none';
        valueSpan.style.display = 'block';
        
        // Clear override values
        if (type === 'rhr') {
            document.getElementById('overrideRhrBpm').value = '';
            rhrManualOverride = false;
        } else {
            document.getElementById('overrideHrvLow').value = '';
            document.getElementById('overrideHrvHigh').value = '';
            hrvManualOverride = false;
        }
        
        updateOverrideChip(type, false);
    }
    
    // Prefill the readiness form with existing data
    function prefillReadinessForm(r) {
        document.getElementById('readinessEntryId').value = r.id || '';
        
        // Energy
        if (r.energy) {
            const energyRadio = document.querySelector(`[name="energy"][value="${r.energy}"]`);
            if (energyRadio) {
                energyRadio.checked = true;
                energyRadio.closest('.rating-option').classList.add('selected');
            }
        }
        
        // Mood
        if (r.mood) {
            const moodRadio = document.querySelector(`[name="mood"][value="${r.mood}"]`);
            if (moodRadio) {
                moodRadio.checked = true;
                moodRadio.closest('.rating-option').classList.add('selected');
            }
        }
        
        // Muscle fatigue
        if (r.muscle_fatigue) {
            const fatigueRadio = document.querySelector(`[name="muscle_fatigue"][value="${r.muscle_fatigue}"]`);
            if (fatigueRadio) {
                fatigueRadio.checked = true;
                fatigueRadio.closest('.rating-option').classList.add('selected');
            }
        }
        
        // HRV Status
        if (r.hrv_status !== null && r.hrv_status !== undefined) {
            selectStatusButton('hrv_status', r.hrv_status);
        }
        
        // RHR Status
        if (r.rhr_status !== null && r.rhr_status !== undefined) {
            selectStatusButton('rhr_status', r.rhr_status);
        }
        
        // Symptoms
        document.getElementById('symptomsFlag').checked = r.symptoms_flag || false;
    }
    
    // Clear the readiness form
    function clearReadinessForm() {
        document.getElementById('readinessEntryId').value = '';
        
        // Clear all radio buttons
        document.querySelectorAll('#readinessForm input[type="radio"]').forEach(r => {
            r.checked = false;
            const opt = r.closest('.rating-option, .status-option');
            if (opt) opt.classList.remove('selected');
        });
        
        // Clear symptoms
        document.getElementById('symptomsFlag').checked = false;
        
        // Clear manual cardio inputs
        const manualRhr = document.getElementById('manualRhrBpm');
        const manualHrvLow = document.getElementById('manualHrvLow');
        const manualHrvHigh = document.getElementById('manualHrvHigh');
        if (manualRhr) manualRhr.value = '';
        if (manualHrvLow) manualHrvLow.value = '';
        if (manualHrvHigh) manualHrvHigh.value = '';
    }
    
    // ============== Readiness History Table ==============
    async function loadReadinessHistory() {
        try {
            const response = await fetch('/cycling-readiness/api/readiness?limit=14');
            const data = await response.json();
            
            const tbody = document.getElementById('readinessHistoryBody');
            const emptyState = document.getElementById('readinessHistoryEmpty');
            const table = document.getElementById('readinessHistoryTable');
            
            if (data.entries && data.entries.length > 0) {
                table.style.display = 'table';
                emptyState.style.display = 'none';
                tbody.innerHTML = data.entries.map(e => renderReadinessHistoryRow(e)).join('');
            } else {
                table.style.display = 'none';
                emptyState.style.display = 'block';
            }
        } catch (err) {
            console.error('Error loading readiness history:', err);
        }
    }
    
    function renderReadinessHistoryRow(e) {
        const dateStr = e.date;
        const d = new Date(dateStr + 'T00:00:00');
        const dateLabel = d.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        
        // Score badge
        let scoreBadge = '<span class="val-empty">--</span>';
        if (e.morning_score) {
            let scoreClass = e.morning_score >= 70 ? 'score-high' : (e.morning_score >= 40 ? 'score-medium' : 'score-low');
            scoreBadge = `<span class="score-badge ${scoreClass}">${e.morning_score}</span>`;
        }
        
        // Mood emoji
        const moodEmojis = { 1: '', 2: '', 3: '' };
        const moodDisplay = moodEmojis[e.mood] || '<span class="val-empty">--</span>';
        
        // Fatigue
        const fatigueLabels = { 1: 'Lo', 2: 'Med', 3: 'Hi' };
        const fatigueDisplay = fatigueLabels[e.muscle_fatigue] || '--';
        
        // Sleep
        let sleepDisplay = '<span class="val-empty">--</span>';
        if (e.sleep_minutes) {
            sleepDisplay = `${(e.sleep_minutes / 60).toFixed(1)}h`;
        }
        
        // RHR
        let rhrDisplay = '<span class="val-empty">--</span>';
        if (e.rhr_bpm) {
            const rhrClass = e.rhr_manual_override ? 'cardio-value has-override' : 'cardio-value';
            rhrDisplay = `<span class="${rhrClass}">${e.rhr_bpm}</span>`;
        }
        
        // HRV
        let hrvDisplay = '<span class="val-empty">--</span>';
        if (e.hrv_low_ms && e.hrv_high_ms) {
            const hrvClass = e.hrv_manual_override ? 'cardio-value has-override' : 'cardio-value';
            if (e.hrv_low_ms === e.hrv_high_ms) {
                hrvDisplay = `<span class="${hrvClass}">${e.hrv_low_ms}</span>`;
            } else {
                hrvDisplay = `<span class="${hrvClass}">${e.hrv_low_ms}-${e.hrv_high_ms}</span>`;
            }
        }
        
        // Status arrows
        function statusArrow(val) {
            if (val === 1) return '<span class="status-arrow positive"></span>';
            if (val === -1) return '<span class="status-arrow negative"></span>';
            return '<span class="status-arrow neutral"></span>';
        }
        
        // Symptoms
        const symptomsDisplay = e.symptoms_flag ? '' : '<span class="val-empty">-</span>';
        
        return `
            <tr data-readiness-id="${e.id}" data-date="${dateStr}">
                <td>${dateLabel}</td>
                <td>${scoreBadge}</td>
                <td>${e.energy || '--'}</td>
                <td class="mood-emoji">${moodDisplay}</td>
                <td>${fatigueDisplay}</td>
                <td class="val-time">${sleepDisplay}</td>
                <td>${rhrDisplay}</td>
                <td>${hrvDisplay}</td>
                <td>${statusArrow(e.hrv_status)}</td>
                <td>${statusArrow(e.rhr_status)}</td>
                <td>${symptomsDisplay}</td>
                <td>
                    <button class="edit-row-btn" onclick="editReadinessFromHistory('${dateStr}')" title="Edit">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="btn-delete btn-delete-readiness" data-id="${e.id}" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        `;
    }
    
    // Edit readiness from history row
    function editReadinessFromHistory(dateStr) {
        // Set the date in the form
        document.getElementById('readinessDate').value = dateStr;
        
        // Load full data for that date
        loadFullReadinessData(dateStr).then(() => {
            // Expand the form
            const card = document.getElementById('morningReadinessCard');
            card.classList.remove('collapsed');
            document.getElementById('readinessSummary').style.display = 'none';
            
            // Scroll to form
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    }
    
    // Initial load
    const today = document.getElementById('readinessDate').value;
    updateDateLabel(today);
    loadFullReadinessData(today);
    loadReadinessHistory();

    // ============== AI Coach Tab ==============
    const DAY_TYPE_LABELS = {
        'rest': 'Rest Day',
        'recovery_spin_z1': 'Recovery Z1',
        'easy_endurance_z1': 'Easy Z1',
        'steady_endurance_z2': 'Endurance Z2',
        'norwegian_4x4': '44 VO2max',
        'hybrid_endurance': 'Hybrid',
        'other': 'Training'
    };

    const DAY_TYPE_CLASSES = {
        'rest': 'rest',
        'recovery_spin_z1': 'z1',
        'easy_endurance_z1': 'z1',
        'steady_endurance_z2': 'z2',
        'norwegian_4x4': 'hard',
        'hybrid_endurance': 'z2',
        'other': ''
    };

    // Switch to AI Coach tab and optionally set date
    function switchToCoachTab(targetDate = null) {
        // Switch tabs
        document.querySelectorAll('.cycle-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="coach"]').classList.add('active');
        document.getElementById('coachTab').classList.add('active');
        
        // Set date if provided
        if (targetDate) {
            document.getElementById('coachDate').value = targetDate;
        }
        
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('tab', 'coach');
        if (targetDate) {
            url.searchParams.set('date', targetDate);
        }
        window.history.replaceState({}, '', url);
    }

    // Fetch and display AI Coach recommendation
    async function fetchCoachRecommendation(date, refresh = false) {
        const loadingEl = document.getElementById('coachLoading');
        const emptyEl = document.getElementById('coachEmpty');
        const contentEl = document.getElementById('coachContent');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        // Show loading state
        loadingEl.style.display = 'flex';
        emptyEl.style.display = 'none';
        contentEl.style.display = 'none';
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
        
        try {
            let url = `/cycling-readiness/api/training-recommendation?date=${date}`;
            if (refresh) {
                url += '&refresh=true';
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            loadingEl.style.display = 'none';
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Analyze This Day';
            
            if (data.success && data.recommendation) {
                renderCoachRecommendation(data.recommendation, date);
                contentEl.style.display = 'block';
            } else {
                emptyEl.style.display = 'block';
                if (data.error) {
                    showToast(data.error, 'error');
                }
            }
        } catch (err) {
            console.error('Error fetching AI Coach recommendation:', err);
            loadingEl.style.display = 'none';
            emptyEl.style.display = 'block';
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Analyze This Day';
            showToast('Could not load AI Coach recommendation', 'error');
        }
    }

    function renderCoachRecommendation(rec, dateStr) {
        // Day type badge
        const dayTypeBadge = document.getElementById('coachDayTypeBadge');
        dayTypeBadge.textContent = DAY_TYPE_LABELS[rec.day_type] || rec.day_type;
        dayTypeBadge.className = 'day-type-badge ' + (DAY_TYPE_CLASSES[rec.day_type] || '');
        
        // Intensity tag
        const intensityTag = document.getElementById('coachIntensityTag');
        if (rec.session_plan && rec.session_plan.overall_intensity) {
            intensityTag.textContent = rec.session_plan.overall_intensity.replace('_', ' ');
            intensityTag.className = 'intensity-tag ' + rec.session_plan.overall_intensity;
            intensityTag.style.display = 'inline';
        } else {
            intensityTag.style.display = 'none';
        }
        
        // Duration
        const durationEl = document.getElementById('coachDuration');
        if (rec.session_plan && rec.session_plan.duration_minutes) {
            durationEl.textContent = rec.session_plan.duration_minutes + ' min';
        } else if (rec.day_type === 'rest') {
            durationEl.textContent = 'Rest';
        } else {
            durationEl.textContent = '--';
        }
        
        // Date label
        document.getElementById('coachDateLabel').textContent = dateStr;
        
        // Reason
        document.getElementById('coachReason').textContent = rec.reason_short || '';
        
        // Performance Targets Card
        const targetsCard = document.getElementById('coachTargetsCard');
        const targetsGrid = document.getElementById('coachTargetsGrid');
        if (rec.session_plan) {
            const sp = rec.session_plan;
            let targetsHtml = '';
            
            if (sp.expected_avg_hr_bpm) {
                targetsHtml += `
                    <div class="target-item">
                        <span class="target-label">Avg HR:</span>
                        <span class="target-value hr">${sp.expected_avg_hr_bpm} bpm</span>
                    </div>`;
            }
            
            if (sp.expected_avg_power_w) {
                targetsHtml += `
                    <div class="target-item">
                        <span class="target-label">Avg Power:</span>
                        <span class="target-value power">${sp.expected_avg_power_w} W</span>
                    </div>`;
            }
            
            if (sp.primary_zone) {
                targetsHtml += `
                    <div class="target-item">
                        <span class="target-label">Zone:</span>
                        <span class="target-value zone">${sp.primary_zone}</span>
                    </div>`;
            }
            
            if (sp.session_target_power_w_min && sp.session_target_power_w_max) {
                targetsHtml += `
                    <div class="target-item">
                        <span class="target-label">Power Range:</span>
                        <span class="target-value power">${sp.session_target_power_w_min}${sp.session_target_power_w_max} W</span>
                    </div>`;
            }
            
            if (targetsHtml) {
                targetsGrid.innerHTML = targetsHtml;
                targetsCard.style.display = 'block';
            } else {
                targetsCard.style.display = 'none';
            }
        } else {
            targetsCard.style.display = 'none';
        }
        
        // Enhanced Intervals
        const intervalsContainer = document.getElementById('coachIntervals');
        const intervalsList = document.getElementById('coachIntervalsList');
        if (rec.session_plan && rec.session_plan.intervals && rec.session_plan.intervals.length > 0) {
            intervalsList.innerHTML = rec.session_plan.intervals.map(interval => {
                // Duration description
                let durationDesc = '';
                if (interval.repeats) {
                    durationDesc = `${interval.repeats} ${interval.work_minutes || interval.duration_minutes}min`;
                    if (interval.rest_minutes) {
                        durationDesc += ` / ${interval.rest_minutes}min rest`;
                    }
                } else {
                    durationDesc = `${interval.duration_minutes} min`;
                }
                
                // HR metric
                let hrHtml = '';
                if (interval.target_hr_bpm_min && interval.target_hr_bpm_max) {
                    hrHtml = `
                        <div class="interval-metric">
                            <span class="interval-metric-label">HR:</span>
                            <span class="interval-metric-value hr">${interval.target_hr_bpm_min}${interval.target_hr_bpm_max} bpm</span>
                        </div>`;
                } else if (interval.expected_avg_hr_bpm) {
                    hrHtml = `
                        <div class="interval-metric">
                            <span class="interval-metric-label">HR:</span>
                            <span class="interval-metric-value hr">~${interval.expected_avg_hr_bpm} bpm</span>
                        </div>`;
                }
                
                // Power metric
                let powerHtml = '';
                if (interval.target_power_w_min && interval.target_power_w_max) {
                    powerHtml = `
                        <div class="interval-metric">
                            <span class="interval-metric-label">Power:</span>
                            <span class="interval-metric-value power">${interval.target_power_w_min}${interval.target_power_w_max} W</span>
                        </div>`;
                }
                
                // Notes
                let notesHtml = '';
                if (interval.notes) {
                    notesHtml = `
                        <div class="interval-notes">
                            <i class="fas fa-info-circle"></i>${interval.notes}
                        </div>`;
                }
                
                return `
                    <div class="interval-row ${interval.kind}">
                        <div class="interval-left">
                            <span class="interval-type ${interval.kind}">${interval.kind}</span>
                        </div>
                        <div class="interval-center">
                            <span class="interval-duration">${durationDesc}</span>
                            <span class="interval-zone-badge ${interval.target_zone}">${interval.target_zone}</span>
                        </div>
                        <div class="interval-right">
                            ${hrHtml}
                            ${powerHtml}
                        </div>
                        ${notesHtml}
                    </div>
                `;
            }).join('');
            intervalsContainer.style.display = 'block';
        } else {
            intervalsContainer.style.display = 'none';
        }
        
        // Flags
        const flagsContainer = document.getElementById('coachFlags');
        if (rec.flags && Object.keys(rec.flags).length > 0) {
            const flagsHtml = Object.entries(rec.flags)
                .filter(([_, v]) => v)
                .map(([key, _]) => {
                    const isPositive = ['ok_to_push'].includes(key);
                    const isWarning = ['consider_rest_day', 'prioritize_sleep', 'monitor_hrv'].includes(key);
                    const className = isPositive ? 'positive' : (isWarning ? 'warning' : '');
                    const label = key.replace(/_/g, ' ');
                    return `<span class="rec-flag ${className}">${label}</span>`;
                })
                .join('');
            
            if (flagsHtml) {
                flagsContainer.innerHTML = flagsHtml;
                flagsContainer.style.display = 'flex';
            } else {
                flagsContainer.style.display = 'none';
            }
        } else {
            flagsContainer.style.display = 'none';
        }
    }

    // Analyze button click handler
    document.getElementById('analyzeBtn').addEventListener('click', function() {
        const date = document.getElementById('coachDate').value;
        fetchCoachRecommendation(date, false);
    });

    // Refresh button click handler
    document.getElementById('coachRefreshBtn').addEventListener('click', function() {
        const date = document.getElementById('coachDate').value;
        fetchCoachRecommendation(date, true);
    });

    // Quick date buttons
    document.querySelectorAll('.quick-date-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const date = this.dataset.date;
            if (date) {
                document.getElementById('coachDate').value = date;
                fetchCoachRecommendation(date, false);
            }
        });
    });

    // AI Coach buttons in workouts table
    document.querySelectorAll('.btn-coach').forEach(btn => {
        btn.addEventListener('click', function() {
            const date = this.dataset.date;
            if (date) {
                switchToCoachTab(date);
                fetchCoachRecommendation(date, false);
            }
        });
    });

    // Open AI Coach for a specific date (used from Day View modal)
    window.openCoachForDate = function(dateStr) {
        closeDayViewModal();  // Close the day view modal first
        switchToCoachTab(dateStr);
        fetchCoachRecommendation(dateStr, false);
    };

    // Handle URL params on page load
    (function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        const date = urlParams.get('date');
        
        if (tab === 'coach') {
            switchToCoachTab(date || today);
            if (date) {
                fetchCoachRecommendation(date, false);
            }
        }
    })();

    // ============== Multi-file Upload ==============
    const bundleZone = document.getElementById('bundleUploadZone');
    const bundleInput = document.getElementById('bundleImageInput');
    const fileListContainer = document.getElementById('fileListContainer');
    const uploadActions = document.getElementById('uploadActions');
    const extractionResults = document.getElementById('extractionResults');
    let selectedFiles = [];

    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileListContainer.classList.add('d-none');
            uploadActions.classList.add('d-none');
            hideStatus();
            return;
        }

        fileListContainer.classList.remove('d-none');
        uploadActions.classList.remove('d-none');
        fileListContainer.innerHTML = selectedFiles.map((file, idx) => `
            <div class="file-item">
                <i class="fas fa-image"></i>
                <span class="filename">${file.name}</span>
                <span class="remove-file" data-idx="${idx}"><i class="fas fa-times"></i></span>
            </div>
        `).join('');

        fileListContainer.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedFiles.splice(parseInt(this.dataset.idx), 1);
                updateFileList();
            });
        });
    }

    bundleZone.addEventListener('click', () => bundleInput.click());
    bundleZone.addEventListener('dragover', (e) => { e.preventDefault(); bundleZone.classList.add('dragover'); });
    bundleZone.addEventListener('dragleave', () => bundleZone.classList.remove('dragover'));
    bundleZone.addEventListener('drop', (e) => {
        e.preventDefault();
        bundleZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(e.dataTransfer.files)];
            updateFileList();
        }
    });

    bundleInput.addEventListener('change', function() {
        if (this.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(this.files)];
            updateFileList();
        }
    });

    // ============== Bundle Upload Form ==============
    document.getElementById('bundleUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (selectedFiles.length === 0) {
            showToast('Please select at least one image', 'error');
            return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('images', file));

        showLoading(`Processing ${selectedFiles.length} image(s)...`);
        showStatus('loading', 'Analyzing screenshots...');
        extractionResults.classList.add('d-none');
        document.getElementById('uploadBtn').disabled = true;

        try {
            const response = await fetch('/cycling-readiness/api/cycle/import-bundle', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;

            if (data.success) {
                const results = data.extraction_results || [];
                const errors = results.filter(r => r.type === 'error').length;

                if (errors > 0 && errors === results.length) {
                    showStatus('error', 'Could not parse screenshots');
                } else if (errors > 0) {
                    showStatus('success', `Merged successfully! (${errors} failed)`);
                } else {
                    showStatus('success', 'Merged successfully!');
                }

                if (results.length > 0) {
                    extractionResults.classList.remove('d-none');
                    extractionResults.innerHTML = results.map(r => {
                        // Handle both old (cycling_workout) and new (cycling_power, watch_workout) types
                        const isCycling = r.type === 'cycling_workout' || r.type === 'cycling_power' || r.type === 'watch_workout';
                        const isSleep = r.type === 'sleep_summary';
                        const isError = r.type === 'error';
                        
                        const typeClass = isCycling ? 'cycling' : isSleep ? 'sleep' : isError ? 'error' : 'unknown';
                        const icon = isCycling ? 'fa-bicycle' : isSleep ? 'fa-moon' : isError ? 'fa-exclamation-triangle' : 'fa-question';
                        const typeName = isCycling ? 'Cycling' : isSleep ? 'Sleep' : isError ? 'Error' : 'Unknown';
                        const confidence = r.confidence ? ` (${Math.round(r.confidence * 100)}%)` : '';
                        
                        return `
                            <div class="extraction-item ${typeClass}">
                                <div class="extraction-icon"><i class="fas ${icon}"></i></div>
                                <div class="extraction-details">
                                    <div class="extraction-type">${typeName}${confidence}</div>
                                    <div class="extraction-filename">${r.filename}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                selectedFiles = [];
                updateFileList();
                
                // Check if there's missing data that needs review
                if (data.has_missing_data && 
                    (data.missing_fields?.workout?.length > 0 || data.missing_fields?.sleep?.length > 0)) {
                    // Store the data for review modal
                    window.lastImportData = data;
                    showReviewModal(data);
                } else {
                    // No missing data, reload after showing results
                    setTimeout(() => location.reload(), 2500);
                }
            } else {
                showStatus('error', data.error || 'Import failed');
                showToast(data.error || 'Import failed', 'error');
            }
        } catch (err) {
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;
            showStatus('error', 'Error processing images');
            showToast('Error processing images', 'error');
        }
    });

    // ============== Readiness Form ==============
    document.getElementById('readinessForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Get manual cardio values if no screenshot data exists
        const manualRhr = document.getElementById('manualRhrBpm')?.value;
        const manualHrvLow = document.getElementById('manualHrvLow')?.value;
        const manualHrvHigh = document.getElementById('manualHrvHigh')?.value;
        
        // Get override cardio values if in override mode
        const overrideRhr = document.getElementById('overrideRhrBpm')?.value;
        const overrideHrvLow = document.getElementById('overrideHrvLow')?.value;
        const overrideHrvHigh = document.getElementById('overrideHrvHigh')?.value;

        // Note: Sleep data is now imported via screenshots, not entered manually
        const data = {
            date: document.getElementById('readinessDate').value,
            energy: document.querySelector('[name="energy"]:checked')?.value,
            mood: document.querySelector('[name="mood"]:checked')?.value,
            muscle_fatigue: document.querySelector('[name="muscle_fatigue"]:checked')?.value,
            hrv_status: document.querySelector('[name="hrv_status"]:checked')?.value,
            rhr_status: document.querySelector('[name="rhr_status"]:checked')?.value,
            min_hr_status: 0,
            symptoms_flag: document.getElementById('symptomsFlag').checked
        };

        // Include manual cardio values if entered (when no screenshot data)
        if (!hasCardioData) {
            if (manualRhr) {
                data.manual_rhr_bpm = parseInt(manualRhr);
            }
            if (manualHrvLow && manualHrvHigh) {
                data.manual_hrv_low_ms = parseInt(manualHrvLow);
                data.manual_hrv_high_ms = parseInt(manualHrvHigh);
            }
        } else {
            // Check for override values
            const rhrOverrideVisible = document.getElementById('rhrOverrideInput').style.display !== 'none';
            const hrvOverrideVisible = document.getElementById('hrvOverrideInput').style.display !== 'none';
            
            if (rhrOverrideVisible && overrideRhr) {
                data.manual_rhr_bpm = parseInt(overrideRhr);
                data.rhr_manual_override = true;
            }
            if (hrvOverrideVisible && overrideHrvLow && overrideHrvHigh) {
                data.manual_hrv_low_ms = parseInt(overrideHrvLow);
                data.manual_hrv_high_ms = parseInt(overrideHrvHigh);
                data.hrv_manual_override = true;
            }
        }

        // If status not explicitly selected, pass null for auto-calculation
        if (data.hrv_status === undefined) data.hrv_status = null;
        if (data.rhr_status === undefined) data.rhr_status = null;

        if (!data.energy || !data.mood || !data.muscle_fatigue) {
            showToast('Please fill Energy, Mood, and Fatigue', 'error');
            return;
        }

        try {
            const response = await fetch('/cycling-readiness/api/readiness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast(`Saved! Score: ${result.morning_score}`, 'success');
                
                // Update local data and UI
                currentReadinessData = {
                    has_readiness: true,
                    readiness: result.readiness,
                    cardio: result.cardio,
                    calculated_status: {
                        hrv_status: result.hrv_status,
                        rhr_status: result.rhr_status
                    }
                };
                
                // Update the summary display
                updateReadinessSummary(currentReadinessData);
                
                // Collapse the form
                const card = document.getElementById('morningReadinessCard');
                card.classList.add('collapsed');
                document.getElementById('readinessSummary').style.display = 'flex';
                
                // Reload history table
                loadReadinessHistory();
            } else {
                showToast(result.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Error saving readiness', 'error');
        }
    });

    // ============== Delete Records ==============
    let deleteType = null; // 'workout', 'readiness', or 'sleep'
    let deleteId = null;

    window.closeConfirmModal = function() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteType = null;
        deleteId = null;
    };

    function showConfirmModal(type, id) {
        deleteType = type;
        deleteId = id;
        
        // Set modal title based on type
        const titles = {
            'workout': 'Delete Workout?',
            'readiness': 'Delete Readiness Entry?',
            'sleep': 'Delete Sleep Summary?'
        };
        document.getElementById('confirmModalTitle').textContent = titles[type] || 'Delete?';
        document.getElementById('confirmModal').classList.add('active');
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (!deleteId || !deleteType) return;

        let endpoint = '';
        let successMessage = '';
        
        switch(deleteType) {
            case 'workout':
                endpoint = `/cycling-readiness/api/cycling/${deleteId}`;
                successMessage = 'Workout deleted';
                break;
            case 'readiness':
                endpoint = `/cycling-readiness/api/readiness/${deleteId}`;
                successMessage = 'Readiness entry deleted';
                break;
            case 'sleep':
                endpoint = `/cycling-readiness/api/sleep/${deleteId}`;
                successMessage = 'Sleep summary deleted';
                break;
            default:
                closeConfirmModal();
                return;
        }

        try {
            const response = await fetch(endpoint, { method: 'DELETE' });
            const data = await response.json();
            closeConfirmModal();

            if (data.success) {
                showToast(successMessage, 'success');
                
                // For readiness entries, reload history table and update form state
                if (deleteType === 'readiness') {
                    loadReadinessHistory();
                    // Reload form data for current date
                    const currentDate = document.getElementById('readinessDate').value;
                    loadFullReadinessData(currentDate);
                } else {
                    // For workouts and sleep, reload page to update stats and charts
                    setTimeout(() => location.reload(), 500);
                }
            } else {
                showToast(data.error || 'Failed to delete', 'error');
            }
        } catch (err) {
            closeConfirmModal();
            showToast('Error deleting record', 'error');
        }
    });

    // Workout delete buttons
    document.querySelectorAll('.btn-delete-workout').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showConfirmModal('workout', this.dataset.id);
        });
    });

    // Readiness delete buttons (using event delegation for dynamically generated table)
    document.getElementById('readinessHistoryBody').addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.btn-delete-readiness');
        if (deleteBtn) {
            e.stopPropagation();
            showConfirmModal('readiness', deleteBtn.dataset.id);
        }
    });

    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmModal();
    });

    // ============== Edit Workout Functions ==============
    
    // Edit workout buttons
    document.querySelectorAll('.btn-edit-workout').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const workoutId = this.dataset.id;
            await openEditModal(workoutId);
        });
    });

    async function openEditModal(workoutId) {
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`);
            const data = await response.json();
            
            if (data.success && data.workout) {
                const w = data.workout;
                document.getElementById('editWorkoutId').value = w.id;
                document.getElementById('editDate').value = w.date || '';
                
                // Convert duration_sec to mm:ss
                if (w.duration_sec) {
                    const mins = Math.floor(w.duration_sec / 60);
                    const secs = w.duration_sec % 60;
                    document.getElementById('editDuration').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('editDuration').value = '';
                }
                
                document.getElementById('editAvgPower').value = w.avg_power_w || '';
                document.getElementById('editMaxPower').value = w.max_power_w || '';
                document.getElementById('editNormalizedPower').value = w.normalized_power_w || '';
                document.getElementById('editIF').value = w.intensity_factor || '';
                document.getElementById('editTSS').value = w.tss || '';
                document.getElementById('editAvgHR').value = w.avg_heart_rate || '';
                document.getElementById('editMaxHR').value = w.max_heart_rate || '';
                document.getElementById('editCadence').value = w.avg_cadence || '';
                document.getElementById('editDistance').value = w.distance_km || '';
                document.getElementById('editKcalActive').value = w.kcal_active || '';
                document.getElementById('editKcalTotal').value = w.kcal_total || '';
                document.getElementById('editNotes').value = w.notes || '';
                
                document.getElementById('editWorkoutModal').classList.add('active');
            } else {
                showToast('Failed to load workout', 'error');
            }
        } catch (err) {
            showToast('Error loading workout', 'error');
        }
    }

    window.closeEditModal = function() {
        document.getElementById('editWorkoutModal').classList.remove('active');
    };

    window.saveEditedWorkout = async function() {
        const workoutId = document.getElementById('editWorkoutId').value;
        
        // Parse duration mm:ss to seconds
        let durationSec = null;
        const durationVal = document.getElementById('editDuration').value;
        if (durationVal) {
            const parts = durationVal.split(':');
            if (parts.length === 2) {
                durationSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
        }
        
        const data = {
            date: document.getElementById('editDate').value || null,
            duration_sec: durationSec,
            avg_power_w: parseFloat(document.getElementById('editAvgPower').value) || null,
            max_power_w: parseFloat(document.getElementById('editMaxPower').value) || null,
            normalized_power_w: parseFloat(document.getElementById('editNormalizedPower').value) || null,
            intensity_factor: parseFloat(document.getElementById('editIF').value) || null,
            tss: parseFloat(document.getElementById('editTSS').value) || null,
            avg_heart_rate: parseInt(document.getElementById('editAvgHR').value) || null,
            max_heart_rate: parseInt(document.getElementById('editMaxHR').value) || null,
            avg_cadence: parseInt(document.getElementById('editCadence').value) || null,
            distance_km: parseFloat(document.getElementById('editDistance').value) || null,
            kcal_active: parseInt(document.getElementById('editKcalActive').value) || null,
            kcal_total: parseInt(document.getElementById('editKcalTotal').value) || null,
            notes: document.getElementById('editNotes').value || null
        };
        
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                closeEditModal();
                showToast('Workout updated!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error saving workout', 'error');
        }
    };

    document.getElementById('editWorkoutModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    // ============== Edit Readiness Functions ==============
    
    // Edit readiness buttons
    document.querySelectorAll('.btn-edit-readiness').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const entryId = this.dataset.id;
            await openEditReadinessModal(entryId);
        });
    });

    async function openEditReadinessModal(entryId) {
        try {
            const response = await fetch(`/cycling-readiness/api/readiness/${entryId}`);
            const data = await response.json();
            
            if (data.success && data.entry) {
                const e = data.entry;
                document.getElementById('editReadinessId').value = e.id;
                document.getElementById('editReadinessDate').value = e.date;
                document.getElementById('editReadinessEnergy').value = e.energy || '';
                document.getElementById('editReadinessMood').value = e.mood || '';
                document.getElementById('editReadinessFatigue').value = e.muscle_fatigue || '';
                document.getElementById('editReadinessHRV').value = e.hrv_status !== null ? e.hrv_status : '';
                document.getElementById('editReadinessRHR').value = e.rhr_status !== null ? e.rhr_status : '';
                document.getElementById('editReadinessMinHR').value = e.min_hr_status !== null ? e.min_hr_status : '';
                document.getElementById('editReadinessSymptoms').checked = e.symptoms_flag || false;
                document.getElementById('editReadinessNotes').value = e.evening_note || '';
                
                // Load cardio status for this date
                const cardioDisplay = document.getElementById('editCardioDisplay');
                const hrvAutoLabel = document.getElementById('editHrvAutoLabel');
                const rhrAutoLabel = document.getElementById('editRhrAutoLabel');
                
                cardioDisplay.style.display = 'none';
                hrvAutoLabel.style.display = 'none';
                rhrAutoLabel.style.display = 'none';
                
                try {
                    const cardioRes = await fetch(`/cycling-readiness/api/cardio-status?date=${e.date}`);
                    const cardioData = await cardioRes.json();
                    
                    if (cardioData.success && cardioData.has_cardio) {
                        cardioDisplay.style.display = 'block';
                        
                        // Display RHR
                        const rhrDisplay = document.getElementById('editDisplayRhr');
                        if (cardioData.cardio.rhr_bpm) {
                            rhrDisplay.textContent = `${cardioData.cardio.rhr_bpm} bpm`;
                        } else {
                            rhrDisplay.textContent = '--';
                        }
                        
                        // Display HRV
                        const hrvDisplay = document.getElementById('editDisplayHrv');
                        if (cardioData.cardio.hrv_low_ms && cardioData.cardio.hrv_high_ms) {
                            if (cardioData.cardio.hrv_low_ms === cardioData.cardio.hrv_high_ms) {
                                hrvDisplay.textContent = `${cardioData.cardio.hrv_low_ms} ms`;
                            } else {
                                hrvDisplay.textContent = `${cardioData.cardio.hrv_low_ms}${cardioData.cardio.hrv_high_ms} ms`;
                            }
                        } else {
                            hrvDisplay.textContent = '--';
                        }
                        
                        // Show auto labels if status was calculated
                        if (cardioData.calculated_status.hrv_status !== null) {
                            hrvAutoLabel.style.display = 'inline';
                        }
                        if (cardioData.calculated_status.rhr_status !== null) {
                            rhrAutoLabel.style.display = 'inline';
                        }
                    }
                } catch (cardioErr) {
                    console.error('Error loading cardio status:', cardioErr);
                }
                
                document.getElementById('editReadinessModal').classList.add('active');
            } else {
                showToast('Failed to load entry', 'error');
            }
        } catch (err) {
            showToast('Error loading entry', 'error');
        }
    }

    window.closeEditReadinessModal = function() {
        document.getElementById('editReadinessModal').classList.remove('active');
    };

    window.saveEditedReadiness = async function() {
        const entryId = document.getElementById('editReadinessId').value;
        
        const data = {
            energy: parseInt(document.getElementById('editReadinessEnergy').value) || null,
            mood: parseInt(document.getElementById('editReadinessMood').value) || null,
            muscle_fatigue: parseInt(document.getElementById('editReadinessFatigue').value) || null,
            hrv_status: document.getElementById('editReadinessHRV').value !== '' ? 
                parseInt(document.getElementById('editReadinessHRV').value) : null,
            rhr_status: document.getElementById('editReadinessRHR').value !== '' ? 
                parseInt(document.getElementById('editReadinessRHR').value) : null,
            min_hr_status: document.getElementById('editReadinessMinHR').value !== '' ? 
                parseInt(document.getElementById('editReadinessMinHR').value) : null,
            symptoms_flag: document.getElementById('editReadinessSymptoms').checked,
            evening_note: document.getElementById('editReadinessNotes').value || null
        };
        
        try {
            const response = await fetch(`/cycling-readiness/api/readiness/${entryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                closeEditReadinessModal();
                showToast('Entry updated!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error saving entry', 'error');
        }
    };

    document.getElementById('editReadinessModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditReadinessModal();
    });

    // ============== Score Tooltip ==============
    
    window.toggleScoreTooltip = function() {
        const tooltip = document.getElementById('scoreTooltip');
        tooltip.classList.toggle('active');
    };

    // Close tooltip when clicking outside
    document.addEventListener('click', function(e) {
        const tooltip = document.getElementById('scoreTooltip');
        const infoBtn = document.querySelector('.score-info-icon');
        if (tooltip && !tooltip.contains(e.target) && !infoBtn.contains(e.target)) {
            tooltip.classList.remove('active');
        }
    });

    // ============== Day View Functions ==============
    
    // View day buttons
    document.querySelectorAll('.btn-view-day').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const date = this.dataset.date;
            if (date) {
                await openDayViewModal(date);
            }
        });
    });

    async function openDayViewModal(date) {
        document.getElementById('dayViewDate').textContent = date;
        document.getElementById('dayViewModal').classList.add('active');
        document.getElementById('dayViewContent').innerHTML = `
            <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        `;
        
        try {
            const response = await fetch(`/cycling-readiness/api/day-summary?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                renderDayView(data);
            } else {
                document.getElementById('dayViewContent').innerHTML = `
                    <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load data
                    </div>
                `;
            }
        } catch (err) {
            document.getElementById('dayViewContent').innerHTML = `
                <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </div>
            `;
        }
    }

    function renderDayView(data) {
        const container = document.getElementById('dayViewContent');
        let html = '';
        
        // Cycling Workout Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title cycling"><i class="fas fa-bicycle me-2"></i>Cycling Workout</div>
                ${data.cycling_workout ? `<button class="btn-edit" onclick="openEditModal(${data.cycling_workout.id})" title="Edit"><i class="fas fa-pencil-alt"></i></button>` : ''}
            </div>`;
        
        if (data.cycling_workout) {
            const w = data.cycling_workout;
            const missingCycling = data.missing?.cycling || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Duration', formatDuration(w.duration_sec), missingCycling.includes('duration_sec'))}
                ${renderDayDataItem('Avg Power', w.avg_power_w ? w.avg_power_w + 'W' : null, missingCycling.includes('avg_power_w'), 'good')}
                ${renderDayDataItem('Max Power', w.max_power_w ? w.max_power_w + 'W' : null, missingCycling.includes('max_power_w'), 'good')}
                ${renderDayDataItem('NP', w.normalized_power_w ? w.normalized_power_w + 'W' : null, missingCycling.includes('normalized_power_w'), 'good')}
                ${renderDayDataItem('Avg HR', w.avg_heart_rate ? w.avg_heart_rate + ' bpm' : null, missingCycling.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', w.max_heart_rate ? w.max_heart_rate + ' bpm' : null, missingCycling.includes('max_heart_rate'), 'hr')}
                ${renderDayDataItem('TSS', w.tss, missingCycling.includes('tss'))}
                ${renderDayDataItem('IF', w.intensity_factor, missingCycling.includes('intensity_factor'))}
                ${renderDayDataItem('Cadence', w.avg_cadence ? w.avg_cadence + ' rpm' : null, missingCycling.includes('avg_cadence'))}
                ${renderDayDataItem('Distance', w.distance_km ? w.distance_km + ' km' : null, missingCycling.includes('distance_km'))}
                ${renderDayDataItem('Active kcal', w.kcal_active, missingCycling.includes('kcal_active'))}
                ${renderDayDataItem('Total kcal', w.kcal_total, missingCycling.includes('kcal_total'))}
            </div>`;
        } else {
            html += `<p class="empty-note">No cycling workout recorded for this date.</p>`;
        }
        html += `</div>`;
        
        // Readiness Entry Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title readiness"><i class="fas fa-sun me-2"></i>Readiness Entry</div>
            </div>`;
        
        if (data.readiness_entry) {
            const r = data.readiness_entry;
            const missingReadiness = data.missing?.readiness || [];
            const score = r.morning_score;
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? '' : 'missing';
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Score', score, false, scoreClass)}
                ${renderDayDataItem('Energy', r.energy ? r.energy + '/5' : null, missingReadiness.includes('energy'))}
                ${renderDayDataItem('Mood', r.mood ? r.mood + '/3' : null, missingReadiness.includes('mood'))}
                ${renderDayDataItem('Fatigue', r.muscle_fatigue ? r.muscle_fatigue + '/3' : null, missingReadiness.includes('muscle_fatigue'))}
                ${renderDayDataItem('Sleep', r.sleep_minutes ? (r.sleep_minutes / 60).toFixed(1) + 'h' : null, missingReadiness.includes('sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', r.deep_sleep_minutes ? r.deep_sleep_minutes + 'min' : null, missingReadiness.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Awake', r.awake_minutes ? r.awake_minutes + 'min' : null, false)}
                ${renderDayDataItem('Symptoms', r.symptoms_flag ? 'Yes' : 'No', false)}
            </div>`;
        } else {
            html += `<p class="empty-note">No readiness entry for this date.</p>`;
        }
        html += `</div>`;
        
        // Sleep Summary Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title sleep"><i class="fas fa-moon me-2"></i>Sleep Summary</div>
            </div>`;
        
        if (data.sleep_summary) {
            const s = data.sleep_summary;
            const missingSleep = data.missing?.sleep || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Total Sleep', s.total_sleep_minutes ? (s.total_sleep_minutes / 60).toFixed(1) + 'h' : null, missingSleep.includes('total_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', s.deep_sleep_minutes ? s.deep_sleep_minutes + 'min' : null, missingSleep.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Awake', s.awake_minutes ? s.awake_minutes + 'min' : null, missingSleep.includes('awake_minutes'))}
                ${renderDayDataItem('Start', formatTime(s.sleep_start_time), false)}
                ${renderDayDataItem('End', formatTime(s.sleep_end_time), false)}
                ${renderDayDataItem('Min HR', s.min_heart_rate ? s.min_heart_rate + ' bpm' : null, missingSleep.includes('min_heart_rate'), 'hr')}
                ${renderDayDataItem('Avg HR', s.avg_heart_rate ? s.avg_heart_rate + ' bpm' : null, missingSleep.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', s.max_heart_rate ? s.max_heart_rate + ' bpm' : null, missingSleep.includes('max_heart_rate'), 'hr')}
            </div>`;
        } else {
            html += `<p class="empty-note">No sleep data for this date.</p>`;
        }
        html += `</div>`;
        
        // Cardio Metrics Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title" style="color: var(--color-red);"><i class="fas fa-heartbeat me-2"></i>Cardio Metrics</div>
            </div>`;
        
        if (data.cardio_metrics) {
            const c = data.cardio_metrics;
            const missingCardio = data.missing?.cardio || [];
            
            // Format RHR (single value)
            let rhrDisplay = null;
            if (c.rhr_bpm !== null && c.rhr_bpm !== undefined) {
                rhrDisplay = `${c.rhr_bpm} bpm`;
            }
            
            // Format HRV range
            let hrvDisplay = null;
            if (c.hrv_low_ms !== null && c.hrv_high_ms !== null) {
                if (c.hrv_low_ms === c.hrv_high_ms) {
                    hrvDisplay = `${c.hrv_low_ms} ms`;
                } else {
                    hrvDisplay = `${c.hrv_low_ms}${c.hrv_high_ms} ms`;
                }
            }
            
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Resting HR', rhrDisplay, missingCardio.includes('rhr_bpm'), 'hr')}
                ${renderDayDataItem('HRV', hrvDisplay, missingCardio.includes('hrv_low_ms') || missingCardio.includes('hrv_high_ms'))}
            </div>`;
        } else {
            html += `<p class="empty-note">No cardio metrics for this date.</p>`;
        }
        html += `</div>`;
        
        // Training Recommendation Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title" style="color: var(--color-yellow);"><i class="fas fa-brain me-2"></i>AI Coach</div>
                <button class="btn-coach" onclick="openCoachForDate('${data.date}')" title="Open in AI Coach">
                    <i class="fas fa-external-link-alt"></i>
                </button>
            </div>`;
        
        if (data.training_recommendation) {
            const rec = data.training_recommendation;
            const dayTypeLabel = DAY_TYPE_LABELS[rec.day_type] || rec.day_type;
            const dayTypeClass = DAY_TYPE_CLASSES[rec.day_type] || '';
            
            html += `
                <div class="training-rec-mini">
                    <div class="rec-mini-header">
                        <span class="day-type-badge ${dayTypeClass}">${dayTypeLabel}</span>
                        ${rec.session_plan ? `
                            <span class="rec-mini-details">
                                <i class="fas fa-clock"></i> ${rec.session_plan.duration_minutes}min
                                <i class="fas fa-heartbeat ms-2"></i> ${rec.session_plan.primary_zone}
                            </span>
                        ` : ''}
                    </div>
                    <p class="rec-mini-reason">${rec.reason_short}</p>
                    ${rec.session_plan && rec.session_plan.intervals ? `
                        <div class="rec-mini-intervals">
                            ${rec.session_plan.intervals.map(interval => {
                                let desc = interval.repeats 
                                    ? `${interval.repeats} ${interval.work_minutes || interval.duration_minutes}min`
                                    : `${interval.duration_minutes}min`;
                                return `<span class="interval-chip">${interval.kind} ${desc} ${interval.target_zone}</span>`;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            html += `
                <p class="empty-note mb-2">No recommendation saved for this date.</p>
                <button class="btn btn-outline-zyra btn-sm" onclick="openCoachForDate('${data.date}')">
                    <i class="fas fa-magic me-1"></i>Get AI Recommendation
                </button>
            `;
        }
        html += `</div>`;
        
        container.innerHTML = html;
    }

    function renderDayDataItem(label, value, isMissing, valueClass = '') {
        const displayValue = value !== null && value !== undefined ? value : '--';
        const missingClass = isMissing ? 'missing' : valueClass;
        return `
            <div class="day-data-item">
                <div class="label">${label}</div>
                <div class="value ${missingClass}">${displayValue}</div>
            </div>
        `;
    }

    function formatDuration(seconds) {
        if (!seconds) return null;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function formatTime(timeValue) {
        if (!timeValue) return null;
        // Handle time strings like "22:00:00" or seconds
        if (typeof timeValue === 'string' && timeValue.includes(':')) {
            return timeValue.substring(0, 5); // Return HH:MM
        }
        // Handle seconds (e.g., 79200 = 22:00)
        if (typeof timeValue === 'number') {
            const hours = Math.floor(timeValue / 3600) % 24;
            const mins = Math.floor((timeValue % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }
        return timeValue;
    }

    window.closeDayViewModal = function() {
        document.getElementById('dayViewModal').classList.remove('active');
    };

    document.getElementById('dayViewModal').addEventListener('click', function(e) {
        if (e.target === this) closeDayViewModal();
    });

    // ============== Review Modal Functions ==============
    
    let reviewData = null;

    function showReviewModal(data) {
        reviewData = data;
        const container = document.getElementById('reviewContent');
        let html = '';
        
        // Workout review card
        if (data.canonical_workout && data.canonical_workout.date) {
            const cw = data.canonical_workout;
            const missingWorkout = data.missing_fields?.workout || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type cycling"><i class="fas fa-bicycle me-1"></i>Cycling Workout</span>
                    ${missingWorkout.length > 0 ? `<span class="review-missing-badge">${missingWorkout.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('duration_sec', 'Duration (sec)', cw.duration_minutes ? Math.round(cw.duration_minutes * 60) : null, missingWorkout)}
                    ${renderReviewField('avg_power_w', 'Avg Power (W)', cw.avg_power, missingWorkout)}
                    ${renderReviewField('max_power_w', 'Max Power (W)', cw.max_power, missingWorkout)}
                    ${renderReviewField('normalized_power_w', 'NP (W)', cw.normalized_power, missingWorkout)}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cw.avg_hr, missingWorkout)}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cw.max_hr, missingWorkout)}
                    ${renderReviewField('tss', 'TSS', cw.tss, missingWorkout)}
                    ${renderReviewField('intensity_factor', 'IF', cw.intensity_factor, missingWorkout)}
                    ${renderReviewField('avg_cadence', 'Cadence (rpm)', cw.cadence_avg, missingWorkout)}
                    ${renderReviewField('distance_km', 'Distance (km)', cw.distance_km, missingWorkout)}
                    ${renderReviewField('kcal_active', 'Active kcal', cw.calories_active, missingWorkout)}
                    ${renderReviewField('kcal_total', 'Total kcal', cw.calories_total, missingWorkout)}
                </div>
            </div>`;
        }
        
        // Sleep review card
        if (data.canonical_sleep && data.canonical_sleep.date) {
            const cs = data.canonical_sleep;
            const missingSleep = data.missing_fields?.sleep || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type sleep"><i class="fas fa-moon me-1"></i>Sleep Summary</span>
                    ${missingSleep.length > 0 ? `<span class="review-missing-badge">${missingSleep.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('total_sleep_minutes', 'Total Sleep (min)', cs.total_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('deep_sleep_minutes', 'Deep Sleep (min)', cs.deep_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('wakeups_count', 'Wakeups', cs.wakeups, missingSleep, 'sleep_')}
                    ${renderReviewField('min_heart_rate', 'Min HR (bpm)', cs.min_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cs.avg_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cs.max_hr, missingSleep, 'sleep_')}
                </div>
            </div>`;
        }
        
        if (!html) {
            html = '<p style="color: var(--color-muted);">No data to review.</p>';
        }
        
        container.innerHTML = html;
        document.getElementById('reviewModal').classList.add('active');
    }

    function renderReviewField(fieldName, label, value, missingFields, prefix = '') {
        const isMissing = missingFields.includes(fieldName);
        const inputId = prefix + fieldName;
        return `
            <div class="modal-field">
                <label>${label}</label>
                <input type="number" id="review_${inputId}" class="${isMissing ? 'missing' : ''}" 
                       value="${value !== null && value !== undefined ? value : ''}" 
                       step="any" placeholder="${isMissing ? 'Missing - enter value' : ''}">
            </div>
        `;
    }

    window.closeReviewModal = function() {
        document.getElementById('reviewModal').classList.remove('active');
        reviewData = null;
        // Reload to show saved data
        setTimeout(() => location.reload(), 500);
    };

    window.skipReviewAndSave = function() {
        // Data was already saved during import, just close modal
        closeReviewModal();
    };

    window.saveReviewedData = async function() {
        if (!reviewData) return;
        
        const workoutId = reviewData.workout_id;
        
        // Collect workout corrections if we have a workout
        if (workoutId) {
            const workoutUpdates = {
                duration_sec: parseInt(document.getElementById('review_duration_sec')?.value) || null,
                avg_power_w: parseFloat(document.getElementById('review_avg_power_w')?.value) || null,
                max_power_w: parseFloat(document.getElementById('review_max_power_w')?.value) || null,
                normalized_power_w: parseFloat(document.getElementById('review_normalized_power_w')?.value) || null,
                avg_heart_rate: parseInt(document.getElementById('review_avg_heart_rate')?.value) || null,
                max_heart_rate: parseInt(document.getElementById('review_max_heart_rate')?.value) || null,
                tss: parseFloat(document.getElementById('review_tss')?.value) || null,
                intensity_factor: parseFloat(document.getElementById('review_intensity_factor')?.value) || null,
                avg_cadence: parseInt(document.getElementById('review_avg_cadence')?.value) || null,
                distance_km: parseFloat(document.getElementById('review_distance_km')?.value) || null,
                kcal_active: parseInt(document.getElementById('review_kcal_active')?.value) || null,
                kcal_total: parseInt(document.getElementById('review_kcal_total')?.value) || null
            };
            
            try {
                const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workoutUpdates)
                });
                
                const result = await response.json();
                if (!result.success) {
                    showToast('Failed to update workout', 'error');
                    return;
                }
            } catch (err) {
                showToast('Error updating workout', 'error');
                return;
            }
        }
        
        // Note: Sleep data is already saved and linked to readiness
        // Future enhancement: add sleep update endpoint if needed
        
        showToast('Data updated successfully!', 'success');
        closeReviewModal();
    };

    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) closeReviewModal();
    });

    // ============== Charts ==============
    const cyclingChartData = {{ cycling_chart | tojson | safe }};
    const readinessChartData = {{ readiness_chart | tojson | safe }};

    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                labels: { color: 'rgba(255,255,255,0.6)', boxWidth: 10, font: { size: 10 } }
            }
        },
        scales: {
            x: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 }, maxRotation: 0 },
                grid: { color: 'rgba(255,255,255,0.04)' }
            },
            y: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                grid: { color: 'rgba(255,255,255,0.04)' }
            }
        }
    };

    // Cycling Chart
    if (cyclingChartData.dates && cyclingChartData.dates.length > 0) {
        new Chart(document.getElementById('cyclingChart'), {
            type: 'line',
            data: {
                labels: cyclingChartData.dates,
                datasets: [
                    {
                        label: 'Power (W)',
                        data: cyclingChartData.avg_power,
                        borderColor: '#00E676',
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2
                    },
                    {
                        label: 'Avg HR',
                        data: cyclingChartData.avg_heart_rate,
                        borderColor: '#FF5252',
                        backgroundColor: 'rgba(255, 82, 82, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 2,
                        yAxisID: 'y2'
                    },
                    {
                        label: 'TSS',
                        data: cyclingChartData.tss,
                        borderColor: '#FFC107',
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 2
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    ...chartDefaults.scales,
                    y1: {
                        position: 'right',
                        ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                        grid: { display: false }
                    },
                    y2: {
                        position: 'right',
                        ticks: { 
                            color: 'rgba(255, 82, 82, 0.6)', 
                            font: { size: 9 },
                            callback: function(value) { return value + ' bpm'; }
                        },
                        grid: { display: false },
                        min: 60,
                        suggestedMax: 200
                    }
                }
            }
        });
    }

    // Readiness Chart
    if (readinessChartData.dates && readinessChartData.dates.length > 0) {
        new Chart(document.getElementById('readinessChart'), {
            type: 'line',
            data: {
                labels: readinessChartData.dates,
                datasets: [{
                    label: 'Score',
                    data: readinessChartData.morning_score,
                    borderColor: '#0077FF',
                    backgroundColor: 'rgba(0, 119, 255, 0.15)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                ...chartDefaults,
                plugins: { legend: { display: false } },
                scales: {
                    ...chartDefaults.scales,
                    y: { ...chartDefaults.scales.y, min: 0, max: 100 }
                }
            }
        });
    }

    console.log(' Zyra Cycle v3 initialized');
});
</script>
{% endblock %}
