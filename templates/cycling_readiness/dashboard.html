{% extends 'layout.html' %}

{% block title %}Zyra Cycle - Cycling & Readiness{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cycling_readiness.css') }}">
{% endblock %}

{% block content %}
<div class="cycle-container py-3">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-zyra"></div>
        <p class="loading-text">Processing screenshots...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <h4><i class="fas fa-exclamation-triangle text-warning me-2"></i><span id="confirmModalTitle">Delete?</span></h4>
            <p>This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Review Missing Data Modal -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit me-2"></i>Review Extracted Data</h3>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-muted-light); font-size: 0.85rem; margin-bottom: 1rem;">
                    Some fields could not be extracted. Review and fill in missing values below (yellow highlight).
                </p>
                <div id="reviewContent">
                    <!-- Filled dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="skipReviewAndSave()">Skip & Save As-Is</button>
                <button class="btn-modal btn-modal-primary" onclick="saveReviewedData()">
                    <i class="fas fa-save me-1"></i>Save Corrected Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="editWorkoutModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bicycle me-2" style="color: var(--color-green)"></i>Edit Workout</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWorkoutId">
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Date</label>
                        <input type="date" id="editDate" name="date">
                    </div>
                    <div class="modal-field">
                        <label>Duration (mm:ss)</label>
                        <input type="text" id="editDuration" placeholder="30:00" pattern="\d+:\d{2}">
                    </div>
                    <div class="modal-field">
                        <label>Avg Power (W)</label>
                        <input type="number" id="editAvgPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Max Power (W)</label>
                        <input type="number" id="editMaxPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Normalized Power (W)</label>
                        <input type="number" id="editNormalizedPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Intensity Factor</label>
                        <input type="number" id="editIF" step="0.01" min="0" max="2">
                    </div>
                    <div class="modal-field">
                        <label>TSS</label>
                        <input type="number" id="editTSS" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Avg Heart Rate (bpm)</label>
                        <input type="number" id="editAvgHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Max Heart Rate (bpm)</label>
                        <input type="number" id="editMaxHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Avg Cadence (rpm)</label>
                        <input type="number" id="editCadence" min="0" max="200">
                    </div>
                    <div class="modal-field">
                        <label>Distance (km)</label>
                        <input type="number" id="editDistance" step="0.01">
                    </div>
                    <div class="modal-field">
                        <label>Active Calories</label>
                        <input type="number" id="editKcalActive">
                    </div>
                    <div class="modal-field">
                        <label>Total Calories</label>
                        <input type="number" id="editKcalTotal">
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedWorkout()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Readiness Modal -->
    <div id="editReadinessModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-sun me-2" style="color: var(--color-teal)"></i>Edit Readiness Entry</h3>
                <button class="modal-close" onclick="closeEditReadinessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editReadinessId">
                <input type="hidden" id="editReadinessDate">
                <p style="color: var(--color-muted); font-size: 0.75rem; margin-bottom: 1rem;">
                    Edit subjective readiness inputs. Sleep/cardio data is managed via screenshot imports.
                </p>
                
                <!-- Cardio Data Display in Edit Modal -->
                <div id="editCardioDisplay" style="display: none; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">Resting HR</span>
                            <span class="metric-value" id="editDisplayRhr">--</span>
                        </div>
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">HRV</span>
                            <span class="metric-value" id="editDisplayHrv">--</span>
                        </div>
                    </div>
                    <p style="color: var(--color-muted); font-size: 0.65rem; text-align: center;">
                        <i class="fas fa-magic me-1"></i>Status auto-calculated from 14-day baseline
                    </p>
                </div>
                
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Energy (1-5)</label>
                        <select id="editReadinessEnergy" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3">3 - Normal</option>
                            <option value="4">4 - Good</option>
                            <option value="5">5 - Great</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Mood (1-3)</label>
                        <select id="editReadinessMood" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - üòî</option>
                            <option value="2">2 - üòê</option>
                            <option value="3">3 - üòä</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Muscle Fatigue (1-3)</label>
                        <select id="editReadinessFatigue" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>HRV Status <span id="editHrvAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessHRV" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Below Baseline</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Above Baseline</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>RHR Status <span id="editRhrAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessRHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Below Normal (good)</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Above Normal</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Min HR Status</label>
                        <select id="editReadinessMinHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Lower than usual</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Higher than usual</option>
                        </select>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>
                            <input type="checkbox" id="editReadinessSymptoms" style="margin-right: 0.5rem;">
                            Experiencing symptoms (illness, injury, etc.)
                        </label>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editReadinessNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditReadinessModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedReadiness()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Daily Expanded View Modal -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day me-2"></i>Day Summary: <span id="dayViewDate"></span></h3>
                <button class="modal-close" onclick="closeDayViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dayViewContent">
                    <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeDayViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="cycle-hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1><i class="fas fa-bicycle me-2"></i>Zyra Cycle</h1>
                <p class="subtitle">Cycling performance & morning readiness</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <a href="{{ url_for('cycling_readiness.expanded_table') }}" class="btn-expanded-link" title="View all data in expanded table">
                    <i class="fas fa-table me-1"></i>Expanded View
                </a>
                <span class="date-badge">
                    <i class="fas fa-calendar-day me-1"></i>{{ today }}
                </span>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ cycling_stats.total_workouts or 0 }}</div>
            <div class="stat-label">Workouts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value tss">{{ "%.0f"|format(cycling_stats.total_tss or 0) }}</div>
            <div class="stat-label">Total TSS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.0f"|format(cycling_stats.avg_power or 0) }}W</div>
            <div class="stat-label">Avg Power</div>
        </div>
        <div class="stat-card">
            <div class="stat-value time">{{ "%.0f"|format((cycling_stats.total_duration_sec or 0) / 3600) }}h</div>
            <div class="stat-label">Total Time</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="cycle-tabs">
        <button class="cycle-tab active" data-tab="workouts">
            <i class="fas fa-bicycle"></i>Workouts
        </button>
        <button class="cycle-tab" data-tab="readiness">
            <i class="fas fa-moon"></i>Readiness & Sleep
        </button>
        <button class="cycle-tab" data-tab="analytics">
            <i class="fas fa-chart-bar"></i>Analytics
        </button>
        <button class="cycle-tab" data-tab="coach">
            <i class="fas fa-brain"></i>AI Coach
        </button>
    </div>

    <!-- Tab: Workouts -->
    <div id="workoutsTab" class="tab-content active">
        <!-- Import Section -->
        <div class="section-card mb-3">
            <h3 class="section-title">
                <i class="fas fa-cloud-upload-alt"></i>Import Screenshots
            </h3>
            <form id="bundleUploadForm" enctype="multipart/form-data">
                <div class="upload-zone" id="bundleUploadZone">
                    <i class="fas fa-images"></i>
                    <p class="title">Drop screenshots here</p>
                    <p class="hint">Cycling app, Apple Watch, Sleep data</p>
                    <input type="file" id="bundleImageInput" name="images" accept="image/*" multiple class="d-none">
                </div>
                <div id="fileListContainer" class="file-list d-none"></div>
                <div id="statusMessage" class="d-none"></div>
                <div id="uploadActions" class="d-none mt-2">
                    <button type="submit" class="btn btn-zyra w-100" id="uploadBtn">
                        <i class="fas fa-magic me-1"></i>Extract & Merge
                    </button>
                </div>
                <div id="extractionResults" class="extraction-results d-none"></div>
            </form>
        </div>

        <!-- Recent Workouts Table - Full Width -->
        <div class="section-card">
            <h3 class="section-title power">
                <i class="fas fa-list"></i>Recent Workouts
            </h3>
            {% if cycling_workouts %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Power</th>
                            <th>Avg HR</th>
                            <th>Max HR</th>
                            <th>TSS</th>
                            <th>IF</th>
                            <th>Distance</th>
                            <th>Coach</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cyclingTableBody">
                        {% for workout in cycling_workouts %}
                        <tr data-workout-id="{{ workout.id }}" data-workout-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                            <td>
                                <button class="btn-view-day" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="View Day Details">
                                    {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                                </button>
                            </td>
                            <td class="val-time">{{ "%d:%02d"|format((workout.duration_sec or 0) // 60, (workout.duration_sec or 0) % 60) if workout.duration_sec else '<span class="val-empty">--</span>' | safe }}</td>
                            <td class="val-power">{{ "%.0f"|format(workout.avg_power_w) if workout.avg_power_w else '<span class="val-empty">--</span>' | safe }}{{ 'W' if workout.avg_power_w else '' }}</td>
                            <td class="val-hr">{{ workout.avg_heart_rate if workout.avg_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.avg_heart_rate else '' }}</td>
                            <td class="val-hr">{{ workout.max_heart_rate if workout.max_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.max_heart_rate else '' }}</td>
                            <td class="val-tss">{{ "%.0f"|format(workout.tss) if workout.tss else '<span class="val-empty">--</span>' | safe }}</td>
                            <td class="val-if">{{ "%.2f"|format(workout.intensity_factor) if workout.intensity_factor else '<span class="val-empty">--</span>' | safe }}</td>
                            <td class="val-distance">{{ "%.1f km"|format(workout.distance_km) if workout.distance_km else '<span class="val-empty">--</span>' | safe }}</td>
                            <td>
                                <button class="btn-coach" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="Get AI Coach recommendation">
                                    <i class="fas fa-brain"></i>
                                </button>
                            </td>
                            <td>
                                <button class="btn-edit btn-edit-workout" data-id="{{ workout.id }}" title="Edit Workout">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="btn-delete btn-delete-workout" data-id="{{ workout.id }}" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state power">
                <i class="fas fa-bicycle"></i>
                <p>No workouts imported yet.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Readiness & Sleep -->
    <div id="readinessTab" class="tab-content">
        <!-- Morning Readiness - Collapsible Card -->
        <div class="section-card readiness-card mb-3" id="morningReadinessCard">
            <!-- Card Header - Always visible -->
            <div class="readiness-header" id="readinessHeader">
                <div class="readiness-header-content" onclick="toggleReadinessForm()">
                    <h3 class="section-title sleep mb-0">
                        <i class="fas fa-sun"></i>Morning Readiness
                        <span class="readiness-date-label" id="readinessDateLabel"></span>
                    </h3>
                    <span class="collapse-indicator" id="collapseIndicator">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </div>
                
                <!-- Summary View (shown when collapsed) -->
                <div class="readiness-summary" id="readinessSummary" style="display: none;">
                    <div class="summary-pills">
                        <span class="summary-pill score" id="summaryScore" title="Readiness Score">--</span>
                        <span class="summary-pill energy" id="summaryEnergy" title="Energy">‚ö° --</span>
                        <span class="summary-pill mood" id="summaryMood" title="Mood">üòê</span>
                        <span class="summary-pill fatigue" id="summaryFatigue" title="Muscle Fatigue">üí™ --</span>
                        <span class="summary-pill hrv" id="summaryHrv" title="HRV Status">HRV ‚Üí</span>
                        <span class="summary-pill rhr" id="summaryRhr" title="RHR Status">RHR ‚Üí</span>
                        <span class="summary-pill symptoms" id="summarySymptoms" title="Symptoms" style="display: none;">ü§í</span>
                    </div>
                    <button class="btn btn-sm btn-outline-zyra edit-summary-btn" onclick="event.stopPropagation(); editReadinessForDate()" title="Edit">
                        <i class="fas fa-pencil-alt"></i> Edit
                    </button>
                </div>
            </div>
            
            <!-- Form Body (collapsible) -->
            <div class="readiness-form-body" id="readinessFormBody">
                <form id="readinessForm">
                    <input type="hidden" id="readinessDate" name="date" value="{{ today }}">
                    <input type="hidden" id="readinessEntryId" value="">

                    <!-- Energy -->
                    <div class="mb-2">
                        <label class="form-label">Energy Level</label>
                        <div class="rating-selector" data-field="energy">
                            {% for i in range(1, 6) %}
                            <label class="rating-option"><input type="radio" name="energy" value="{{ i }}">{{ i }}</label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Mood -->
                    <div class="mb-2">
                        <label class="form-label">Mood</label>
                        <div class="rating-selector" data-field="mood">
                            <label class="rating-option"><input type="radio" name="mood" value="1">üòî</label>
                            <label class="rating-option"><input type="radio" name="mood" value="2">üòê</label>
                            <label class="rating-option"><input type="radio" name="mood" value="3">üòä</label>
                        </div>
                    </div>

                    <!-- Muscle Fatigue -->
                    <div class="mb-2">
                        <label class="form-label">Muscle Fatigue</label>
                        <div class="rating-selector" data-field="muscle_fatigue">
                            <label class="rating-option"><input type="radio" name="muscle_fatigue" value="1">Low</label>
                            <label class="rating-option"><input type="radio" name="muscle_fatigue" value="2">Med</label>
                            <label class="rating-option"><input type="radio" name="muscle_fatigue" value="3">High</label>
                        </div>
                    </div>

                    <!-- HRV & RHR Section -->
                    <div class="cardio-status-section mb-3" id="cardioStatusSection">
                        <!-- Cardio Data Display (shown when data exists) -->
                        <div id="cardioDataDisplay" style="display: none;">
                            <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                <i class="fas fa-heartbeat me-1" style="color: var(--color-red);"></i>Cardio metrics
                            </p>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <div class="cardio-metric-display" id="rhrCardioCard">
                                        <div class="metric-header">
                                            <span class="metric-label">Resting HR</span>
                                            <span class="auto-chip" id="rhrAutoChip">AUTO</span>
                                            <button type="button" class="btn-override" id="rhrOverrideBtn" onclick="toggleCardioOverride('rhr')" title="Override">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                        </div>
                                        <span class="metric-value" id="displayRhrBpm">--</span>
                                        <!-- Override input (hidden by default) -->
                                        <div class="override-input" id="rhrOverrideInput" style="display: none;">
                                            <input type="number" class="form-control form-control-sm" id="overrideRhrBpm" 
                                                   placeholder="bpm" min="40" max="120">
                                            <div class="override-actions">
                                                <button type="button" class="btn btn-xs btn-link" onclick="resetCardioToAuto('rhr')">Reset</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="cardio-metric-display" id="hrvCardioCard">
                                        <div class="metric-header">
                                            <span class="metric-label">HRV</span>
                                            <span class="auto-chip" id="hrvAutoChip">AUTO</span>
                                            <button type="button" class="btn-override" id="hrvOverrideBtn" onclick="toggleCardioOverride('hrv')" title="Override">
                                                <i class="fas fa-pencil-alt"></i>
                                            </button>
                                        </div>
                                        <span class="metric-value" id="displayHrv">--</span>
                                        <!-- Override input (hidden by default) -->
                                        <div class="override-input" id="hrvOverrideInput" style="display: none;">
                                            <div class="d-flex gap-1">
                                                <input type="number" class="form-control form-control-sm" id="overrideHrvLow" 
                                                       placeholder="low" min="1" max="200" style="width: 60px;">
                                                <span style="color: var(--color-muted);">‚Äì</span>
                                                <input type="number" class="form-control form-control-sm" id="overrideHrvHigh" 
                                                       placeholder="high" min="1" max="200" style="width: 60px;">
                                            </div>
                                            <div class="override-actions">
                                                <button type="button" class="btn btn-xs btn-link" onclick="resetCardioToAuto('hrv')">Reset</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Cardio Input (shown when no data) -->
                        <div id="manualCardioInput" style="display: none;">
                            <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                <i class="fas fa-edit me-1"></i>No cardio data - enter manually (optional)
                            </p>
                            <div class="row mb-2">
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" id="manualRhrBpm" 
                                           placeholder="RHR (bpm)" min="40" max="120" style="font-size: 0.75rem;">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" id="manualHrvLow" 
                                           placeholder="HRV low" min="1" max="200" style="font-size: 0.75rem;">
                                </div>
                                <div class="col-4">
                                    <input type="number" class="form-control form-control-sm" id="manualHrvHigh" 
                                           placeholder="HRV high" min="1" max="200" style="font-size: 0.75rem;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Status Selectors -->
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">
                                    HRV Status
                                    <span class="auto-badge" id="hrvAutoLabel" style="display: none;">auto</span>
                                </label>
                                <div class="status-selector" data-field="hrv_status">
                                    <label class="status-option negative"><input type="radio" name="hrv_status" value="-1">‚Üì</label>
                                    <label class="status-option neutral"><input type="radio" name="hrv_status" value="0">‚Üí</label>
                                    <label class="status-option positive"><input type="radio" name="hrv_status" value="1">‚Üë</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">
                                    RHR Status
                                    <span class="auto-badge" id="rhrAutoLabel" style="display: none;">auto</span>
                                </label>
                                <div class="status-selector" data-field="rhr_status">
                                    <label class="status-option positive"><input type="radio" name="rhr_status" value="-1">‚Üì</label>
                                    <label class="status-option neutral"><input type="radio" name="rhr_status" value="0">‚Üí</label>
                                    <label class="status-option negative"><input type="radio" name="rhr_status" value="1">‚Üë</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sleep Note -->
                    <p class="text-muted small mb-3" style="font-size: 0.7rem; opacity: 0.7;">
                        <i class="fas fa-info-circle me-1"></i>Sleep data is imported from screenshots
                    </p>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="symptomsFlag" name="symptoms_flag">
                            <label class="form-check-label" style="font-size: 0.8rem; color: var(--color-muted-light);" for="symptomsFlag">
                                Experiencing symptoms
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-zyra w-100">
                        <i class="fas fa-save me-1"></i>Save Readiness
                    </button>
                </form>
            </div>
        </div>

        <!-- Readiness History - Full Width -->
        <div class="section-card">
            <h3 class="section-title sleep">
                <i class="fas fa-history"></i>Readiness History
                <span class="score-info">
                    <button class="score-info-icon" onclick="toggleScoreTooltip()" title="How is the score calculated?">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <div class="score-tooltip" id="scoreTooltip">
                        <h4>Readiness Score Formula</h4>
                        <p class="category">Subjective Inputs (40 pts max):</p>
                        <ul>
                            <li>‚Ä¢ Energy (1-5): up to 20 pts</li>
                            <li>‚Ä¢ Mood (1-3): up to 10 pts</li>
                            <li>‚Ä¢ Muscle Fatigue (1-3): up to 10 pts</li>
                        </ul>
                        <p class="category">Recovery (25 pts max):</p>
                        <ul>
                            <li>‚Ä¢ HRV Status: up to 10 pts</li>
                            <li>‚Ä¢ RHR Status: up to 10 pts</li>
                            <li>‚Ä¢ Min HR Status: up to 5 pts</li>
                        </ul>
                        <p class="category">Sleep (25 pts max):</p>
                        <ul>
                            <li>‚Ä¢ Duration: up to 10 pts (7-9h optimal)</li>
                            <li>‚Ä¢ Deep Sleep: up to 10 pts (60-120min)</li>
                            <li>‚Ä¢ Awake Time: up to 5 pts</li>
                        </ul>
                        <p style="color: var(--color-red); margin-top: 0.5rem;">Symptoms: -10 pts if present</p>
                    </div>
                </span>
            </h3>
            <div class="table-responsive" id="readinessHistoryContainer">
                <table class="data-table readiness-history-table" id="readinessHistoryTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Score</th>
                            <th title="Energy">‚ö°</th>
                            <th title="Mood">üòä</th>
                            <th title="Fatigue">üí™</th>
                            <th title="Sleep">üí§</th>
                            <th title="RHR">RHR</th>
                            <th title="HRV">HRV</th>
                            <th title="HRV Status">H‚Üï</th>
                            <th title="RHR Status">R‚Üï</th>
                            <th title="Symptoms">ü§í</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="readinessHistoryBody">
                        <!-- Will be populated via JavaScript -->
                    </tbody>
                </table>
                <div class="empty-state sleep" id="readinessHistoryEmpty" style="display: none;">
                    <i class="fas fa-bed"></i>
                    <p>No readiness entries yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Analytics -->
    <div id="analyticsTab" class="tab-content">
        <!-- KPI Cards Grid -->
        <div class="kpi-grid mb-3">
            <!-- KPI 1: Acute Load (7-day TSS) -->
            <div class="kpi-card" id="kpiAcuteLoad">
                <div class="kpi-header">
                    <span class="kpi-icon">üî•</span>
                    <span class="kpi-title">Acute Load (7d)</span>
                </div>
                <div class="kpi-value" id="kpiAcuteValue">--</div>
                <div class="kpi-subtitle" id="kpiAcuteSubtitle">TSS / 7 days</div>
                <div class="kpi-badge" id="kpiAcuteBadge">--</div>
            </div>
            
            <!-- KPI 2: Chronic Load (42-day) -->
            <div class="kpi-card" id="kpiChronicLoad">
                <div class="kpi-header">
                    <span class="kpi-icon">üìä</span>
                    <span class="kpi-title">Chronic Load (42d)</span>
                </div>
                <div class="kpi-value" id="kpiChronicValue">--</div>
                <div class="kpi-subtitle" id="kpiChronicSubtitle">Weekly TSS avg</div>
                <div class="kpi-badge neutral" id="kpiChronicBadge">Baseline</div>
            </div>
            
            <!-- KPI 3: HRV Trend -->
            <div class="kpi-card" id="kpiHrvTrend">
                <div class="kpi-header">
                    <span class="kpi-icon">üíö</span>
                    <span class="kpi-title">HRV Trend</span>
                </div>
                <div class="kpi-value" id="kpiHrvValue">--</div>
                <div class="kpi-subtitle" id="kpiHrvSubtitle">vs 30-day baseline</div>
                <div class="kpi-trend" id="kpiHrvTrendArrow">
                    <span class="trend-arrow">‚Üí</span>
                    <span class="trend-pct">0%</span>
                </div>
            </div>
            
            <!-- KPI 4: Resting HR Trend -->
            <div class="kpi-card" id="kpiRhrTrend">
                <div class="kpi-header">
                    <span class="kpi-icon">‚ù§Ô∏è</span>
                    <span class="kpi-title">Resting HR</span>
                </div>
                <div class="kpi-value" id="kpiRhrValue">--</div>
                <div class="kpi-subtitle" id="kpiRhrSubtitle">vs 30-day baseline</div>
                <div class="kpi-trend" id="kpiRhrTrendArrow">
                    <span class="trend-arrow">‚Üí</span>
                    <span class="trend-pct">0%</span>
                </div>
            </div>
            
            <!-- KPI 5: Z2 Power Trend -->
            <div class="kpi-card" id="kpiPowerTrend">
                <div class="kpi-header">
                    <span class="kpi-icon">‚ö°</span>
                    <span class="kpi-title">Z2 Power</span>
                </div>
                <div class="kpi-value" id="kpiPowerValue">--</div>
                <div class="kpi-subtitle" id="kpiPowerSubtitle">7d vs 30d avg</div>
                <div class="kpi-trend" id="kpiPowerTrendArrow">
                    <span class="trend-arrow">‚Üí</span>
                    <span class="trend-pct">0%</span>
                </div>
            </div>
        </div>
        
        <!-- Charts Grid -->
        <div class="analytics-charts-grid">
            <!-- Performance Trends Chart -->
            <div class="section-card">
                <h3 class="section-title power">
                    <i class="fas fa-chart-line"></i>Performance Trends
                </h3>
                {% if cycling_chart.dates and cycling_chart.dates|length > 0 %}
                <div class="chart-container">
                    <canvas id="cyclingChart"></canvas>
                </div>
                {% else %}
                <div class="empty-state power">
                    <i class="fas fa-chart-area"></i>
                    <p>No data yet. Upload screenshots to see your performance trend.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Readiness Trend Chart -->
            <div class="section-card">
                <h3 class="section-title sleep">
                    <i class="fas fa-chart-area"></i>Readiness Trend
                </h3>
                {% if readiness_chart.dates and readiness_chart.dates|length > 0 %}
                <div class="chart-container">
                    <canvas id="readinessChart"></canvas>
                </div>
                {% else %}
                <div class="empty-state sleep">
                    <i class="fas fa-chart-line"></i>
                    <p>No readiness data yet.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab: AI Coach -->
    <div id="coachTab" class="tab-content">
        <div class="section-card training-rec-card">
            <h3 class="section-title training">
                <i class="fas fa-brain"></i>AI Training Coach
            </h3>
            
            <!-- Date Selector -->
            <div class="coach-date-selector mb-3">
                <label class="form-label" style="font-size: 0.75rem; color: var(--color-muted-light);">
                    Select date to analyze
                </label>
                <div class="d-flex gap-2 align-items-center">
                    <input type="date" class="form-control form-control-sm" id="coachDate" 
                           value="{{ today }}" style="max-width: 180px; font-size: 0.8rem;">
                    <button class="btn btn-zyra" id="analyzeBtn" style="font-size: 0.8rem; padding: 0.4rem 1rem;">
                        <i class="fas fa-magic me-1"></i>Analyze This Day
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="coachLoading" class="training-rec-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Analyzing your data...</span>
            </div>
            
            <!-- Empty State -->
            <div id="coachEmpty" class="training-rec-empty">
                <i class="fas fa-lightbulb"></i>
                <p>Select a date and click "Analyze This Day" to get AI-powered training recommendations based on your readiness, sleep, and workout history.</p>
            </div>
            
            <!-- Recommendation Content -->
            <div id="coachContent" class="training-rec-content" style="display: none;">
                <div class="training-rec-header">
                    <span class="day-type-badge" id="coachDayTypeBadge">--</span>
                    <span class="intensity-tag" id="coachIntensityTag">--</span>
                    <button class="btn-refresh-rec ms-auto" id="coachRefreshBtn" title="Refresh recommendation">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div class="training-rec-details">
                    <div class="rec-detail">
                        <i class="fas fa-clock"></i>
                        <span id="coachDuration">--</span>
                    </div>
                    <div class="rec-detail">
                        <i class="fas fa-calendar"></i>
                        <span id="coachDateLabel">--</span>
                    </div>
                </div>
                
                <div class="training-rec-reason" id="coachReason">
                    <!-- Reason text will be inserted here -->
                </div>
                
                <!-- Coach Notes / Analysis Card (v2.5) -->
                <div class="coach-analysis-card" id="coachAnalysisCard" style="display: none;">
                    <div class="analysis-header">
                        <span class="analysis-icon">üìä</span>
                        <span class="analysis-title">Coach Notes</span>
                    </div>
                    <div class="analysis-text" id="coachAnalysisText">
                        <!-- Analysis text will be inserted here -->
                    </div>
                </div>
                
                <!-- Performance Targets Card -->
                <div class="performance-targets-card" id="coachTargetsCard" style="display: none;">
                    <div class="targets-header">
                        <span class="targets-icon">üìà</span>
                        <span class="targets-title">Performance Targets (AI Estimated)</span>
                    </div>
                    <div class="targets-grid" id="coachTargetsGrid">
                        <!-- Targets will be inserted here -->
                    </div>
                </div>
                
                <!-- Session Plan with enhanced intervals -->
                <div class="training-rec-intervals" id="coachIntervals" style="display: none;">
                    <div class="intervals-header">
                        <i class="fas fa-list-ol"></i> Session Plan
                    </div>
                    <div class="intervals-list-enhanced" id="coachIntervalsList">
                        <!-- Intervals will be inserted here -->
                    </div>
                </div>
                
                <div class="training-rec-flags" id="coachFlags" style="display: none;">
                    <!-- Flags will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Recent AI Recommendations -->
        <div class="section-card mt-3">
            <h3 class="section-title">
                <i class="fas fa-history"></i>Quick Access
            </h3>
            <p class="text-muted small mb-2" style="font-size: 0.7rem;">
                Click on a date from Recent Workouts or Expanded Table to analyze that day.
            </p>
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-zyra btn-sm quick-date-btn" data-date="{{ today }}">
                    Today
                </button>
                {% for workout in cycling_workouts[:5] %}
                <button class="btn btn-outline-zyra btn-sm quick-date-btn" 
                        data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                    {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/cycling_readiness.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pass chart data from Flask to JavaScript
    const cyclingChartData = {{ cycling_chart | tojson | safe }};
    const readinessChartData = {{ readiness_chart | tojson | safe }};
    
    // Initialize the module
    initCyclingReadiness(cyclingChartData, readinessChartData);
});
</script>
{% endblock %}
