{% extends 'layout.html' %}

{% block title %}Zyra Cycle - Cycling & Readiness{% endblock %}

{% block head %}
<style>
    /* ============== CSS Variables & Color Roles ============== */
    :root {
        --color-teal: #00FFC6;      /* Primary UI */
        --color-blue: #0077FF;       /* Sleep/Recovery */
        --color-green: #00E676;      /* Power/Performance */
        --color-red: #FF5252;        /* Warnings/Low */
        --color-yellow: #FFC107;     /* Moderate */
        --color-muted: rgba(255, 255, 255, 0.4);
        --color-muted-light: rgba(255, 255, 255, 0.6);
    }

    /* ============== Layout & Container ============== */
    .cycle-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 0.75rem;
    }

    @media (min-width: 768px) {
        .cycle-container {
            padding: 0 1.5rem;
        }
    }

    /* ============== Hero Section (Compact) ============== */
    .cycle-hero {
        background: linear-gradient(135deg, rgba(0, 119, 255, 0.12) 0%, rgba(0, 255, 198, 0.08) 100%);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(0, 255, 198, 0.15);
    }

    .cycle-hero h1 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 800;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0;
    }

    .cycle-hero .subtitle {
        font-size: 0.8rem;
        color: var(--color-muted-light);
        margin: 0;
    }

    .date-badge {
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-teal);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .btn-expanded-link {
        background: rgba(0, 119, 255, 0.15);
        color: var(--color-blue);
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid rgba(0, 119, 255, 0.3);
    }

    .btn-expanded-link:hover {
        background: rgba(0, 119, 255, 0.25);
        color: white;
    }

    /* Score formula tooltip */
    .score-info {
        position: relative;
        display: inline-block;
        margin-left: 0.5rem;
    }

    .score-info-icon {
        background: none;
        border: none;
        color: var(--color-muted);
        cursor: help;
        font-size: 0.85rem;
        padding: 0;
    }

    .score-info-icon:hover {
        color: var(--color-teal);
    }

    .score-tooltip {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 20, 20, 0.98);
        border: 1px solid rgba(0, 255, 198, 0.3);
        border-radius: 8px;
        padding: 1rem;
        width: 300px;
        z-index: 100;
        font-size: 0.75rem;
        line-height: 1.5;
        color: var(--color-muted-light);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .score-tooltip.active {
        display: block;
    }

    .score-tooltip h4 {
        color: var(--color-teal);
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }

    .score-tooltip ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .score-tooltip li {
        padding: 0.15rem 0;
    }

    .score-tooltip .category {
        color: white;
        font-weight: 500;
        margin-top: 0.5rem;
    }

    /* ============== Stats Grid (Compact) ============== */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    @media (min-width: 640px) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }

    .stat-card {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 0.75rem 0.5rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: var(--color-teal);
        transform: translateY(-1px);
    }

    .stat-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--color-green);
    }

    .stat-value.tss { color: var(--color-yellow); }
    .stat-value.time { color: var(--color-blue); }

    .stat-label {
        color: var(--color-muted);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.125rem;
    }

    /* ============== Tabs ============== */
    .cycle-tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .cycle-tab {
        position: relative;
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        color: var(--color-muted);
        font-weight: 600;
        font-size: 0.85rem;
        font-family: 'Montserrat', sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .cycle-tab::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 50%;
        width: 0;
        height: 2px;
        background: var(--color-teal);
        transition: all 0.3s ease;
        transform: translateX(-50%);
        border-radius: 2px;
    }

    .cycle-tab:hover {
        color: rgba(255, 255, 255, 0.8);
    }

    .cycle-tab:hover::after {
        width: 30%;
    }

    .cycle-tab.active {
        color: var(--color-teal);
        text-shadow: 0 0 20px rgba(0, 255, 198, 0.3);
    }

    .cycle-tab.active::after {
        width: 60%;
        box-shadow: 0 0 8px rgba(0, 255, 198, 0.5);
    }

    .cycle-tab i {
        margin-right: 0.5rem;
        transition: color 0.3s ease;
    }

    .cycle-tab.active i {
        color: var(--color-teal);
    }

    .cycle-tab[data-tab="readiness"] i {
        color: var(--color-blue);
    }

    .cycle-tab[data-tab="readiness"].active i {
        color: var(--color-blue);
        text-shadow: 0 0 10px rgba(0, 119, 255, 0.5);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* ============== Section Cards (Compact) ============== */
    .section-card {
        background: rgba(26, 26, 26, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .section-title {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: var(--color-teal);
        font-size: 0.85rem;
    }

    .section-title.power i { color: var(--color-green); }
    .section-title.sleep i { color: var(--color-blue); }
    .section-title.training i { color: var(--color-yellow); }

    /* ============== Training Recommendation Card ============== */
    .training-rec-card {
        border: 1px solid rgba(255, 193, 7, 0.2);
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.05) 0%, rgba(0, 0, 0, 0.3) 100%);
    }

    .section-title .btn-suggest {
        float: right;
        font-size: 0.7rem;
        padding: 0.25rem 0.6rem;
        background: linear-gradient(135deg, var(--color-yellow) 0%, #FF9800 100%);
        border: none;
        border-radius: 4px;
        color: #1a1a2e;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .section-title .btn-suggest:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
    }

    .section-title .btn-suggest:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .training-rec-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.5rem;
        color: var(--color-yellow);
        font-size: 0.8rem;
    }

    .training-rec-empty {
        text-align: center;
        padding: 1rem;
        color: var(--color-muted);
    }

    .training-rec-empty i {
        font-size: 1.5rem;
        color: var(--color-yellow);
        opacity: 0.5;
        margin-bottom: 0.5rem;
        display: block;
    }

    .training-rec-empty p {
        font-size: 0.75rem;
        line-height: 1.4;
        margin: 0;
    }

    .training-rec-content {
        padding: 0.5rem 0;
    }

    .training-rec-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .day-type-badge {
        background: var(--color-yellow);
        color: #1a1a2e;
        padding: 0.3rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .day-type-badge.rest {
        background: var(--color-blue);
        color: white;
    }

    .day-type-badge.z1 {
        background: #4CAF50;
        color: white;
    }

    .day-type-badge.z2 {
        background: var(--color-green);
        color: #1a1a2e;
    }

    .day-type-badge.hard {
        background: var(--color-red);
        color: white;
    }

    .intensity-tag {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-muted-light);
        text-transform: capitalize;
    }

    .intensity-tag.very_easy { color: #81C784; }
    .intensity-tag.easy { color: #4CAF50; }
    .intensity-tag.moderate { color: var(--color-yellow); }
    .intensity-tag.hard { color: var(--color-red); }

    .training-rec-details {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.75rem;
    }

    .rec-detail {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: var(--color-muted-light);
    }

    .rec-detail i {
        color: var(--color-teal);
        font-size: 0.7rem;
    }

    .training-rec-reason {
        font-size: 0.75rem;
        line-height: 1.5;
        color: var(--color-muted-light);
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 4px;
        margin-bottom: 0.75rem;
        border-left: 2px solid var(--color-yellow);
    }

    .training-rec-intervals {
        margin-bottom: 0.75rem;
    }

    .intervals-header {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--color-teal);
        margin-bottom: 0.5rem;
    }

    .intervals-list {
        font-size: 0.7rem;
        color: var(--color-muted-light);
    }

    .interval-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .interval-item:last-child {
        border-bottom: none;
    }

    .interval-kind {
        color: var(--color-yellow);
        font-weight: 500;
        min-width: 70px;
    }

    .interval-zone {
        font-weight: 600;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        background: rgba(0, 255, 198, 0.2);
        color: var(--color-teal);
    }

    .training-rec-flags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .rec-flag {
        font-size: 0.6rem;
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
    }

    .rec-flag.positive {
        background: rgba(0, 230, 118, 0.2);
        color: var(--color-green);
    }

    .rec-flag.warning {
        background: rgba(255, 82, 82, 0.2);
        color: var(--color-red);
    }

    .training-rec-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .rec-cached-label {
        font-size: 0.6rem;
        color: var(--color-muted);
    }

    .btn-refresh-rec {
        font-size: 0.65rem;
        padding: 0.2rem 0.5rem;
        background: transparent;
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 3px;
        color: var(--color-yellow);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-refresh-rec:hover {
        background: rgba(255, 193, 7, 0.1);
        border-color: var(--color-yellow);
    }

    /* Training Recommendation Mini (Day View) */
    .training-rec-mini {
        padding: 0.5rem;
    }

    .rec-mini-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .rec-mini-details {
        font-size: 0.75rem;
        color: var(--color-muted-light);
    }

    .rec-mini-details i {
        color: var(--color-teal);
    }

    .rec-mini-reason {
        font-size: 0.75rem;
        color: var(--color-muted-light);
        line-height: 1.4;
        margin: 0 0 0.5rem 0;
        padding: 0.4rem;
        background: rgba(255, 193, 7, 0.05);
        border-left: 2px solid var(--color-yellow);
        border-radius: 2px;
    }

    .rec-mini-intervals {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
    }

    .interval-chip {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        background: rgba(0, 255, 198, 0.1);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 3px;
        color: var(--color-teal);
    }

    /* ============== Grid Layouts ============== */
    .flex-layout {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    @media (min-width: 992px) {
        .flex-layout {
            flex-direction: row;
        }

        .flex-layout > .flex-col-main {
            flex: 1;
            min-width: 0;
        }

        .flex-layout > .flex-col-side {
            width: 380px;
            flex-shrink: 0;
        }
    }

    /* ============== Upload Zone (Compact) ============== */
    .upload-zone {
        border: 2px dashed rgba(0, 255, 198, 0.25);
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 255, 198, 0.02);
    }

    .upload-zone:hover, .upload-zone.dragover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.06);
    }

    .upload-zone i {
        font-size: 2rem;
        color: var(--color-teal);
        margin-bottom: 0.5rem;
    }

    .upload-zone .title {
        font-size: 0.9rem;
        color: white;
        margin-bottom: 0.25rem;
    }

    .upload-zone .hint {
        color: var(--color-muted);
        font-size: 0.75rem;
    }

    /* File list */
    .file-list {
        margin-top: 0.75rem;
        max-height: 120px;
        overflow-y: auto;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.5rem;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        margin-bottom: 0.375rem;
        font-size: 0.8rem;
    }

    .file-item i { color: var(--color-teal); font-size: 0.75rem; }
    .file-item .filename {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: var(--color-muted-light);
    }

    .file-item .remove-file {
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.125rem;
        font-size: 0.7rem;
    }

    .file-item .remove-file:hover { color: var(--color-red); }

    /* ============== Status Messages ============== */
    .status-msg {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 0.75rem;
        border-radius: 8px;
        font-size: 0.8rem;
        margin-top: 0.75rem;
    }

    .status-msg.loading {
        background: rgba(0, 255, 198, 0.1);
        color: var(--color-teal);
        border: 1px solid rgba(0, 255, 198, 0.2);
    }

    .status-msg.success {
        background: rgba(0, 230, 118, 0.1);
        color: var(--color-green);
        border: 1px solid rgba(0, 230, 118, 0.2);
    }

    .status-msg.error {
        background: rgba(255, 82, 82, 0.1);
        color: var(--color-red);
        border: 1px solid rgba(255, 82, 82, 0.2);
    }

    .status-msg i { font-size: 0.9rem; }

    /* ============== Empty States ============== */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--color-muted);
    }

    .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.85rem;
        margin: 0;
    }

    .empty-state.power i { color: var(--color-green); }
    .empty-state.sleep i { color: var(--color-blue); }

    /* ============== Data Table (Compact) ============== */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -0.5rem;
        padding: 0 0.5rem;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8rem;
    }

    .data-table th {
        color: var(--color-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.65rem;
        letter-spacing: 0.5px;
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: left;
        white-space: nowrap;
    }

    .data-table td {
        padding: 0.5rem 0.375rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        font-family: 'Roboto Mono', monospace;
        white-space: nowrap;
    }

    .data-table tr:hover {
        background: rgba(0, 255, 198, 0.03);
    }

    /* Placeholder values */
    .val-empty {
        color: var(--color-muted);
        font-size: 0.7rem;
    }

    .val-power { color: var(--color-green); }
    .val-hr { color: var(--color-red); }
    .val-tss { color: var(--color-yellow); }
    .val-time { color: var(--color-blue); }

    /* ============== Score Badge ============== */
    .score-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        font-weight: 700;
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
    }

    .score-high { background: rgba(0, 230, 118, 0.2); color: var(--color-green); }
    .score-medium { background: rgba(255, 193, 7, 0.2); color: var(--color-yellow); }
    .score-low { background: rgba(255, 82, 82, 0.2); color: var(--color-red); }

    /* ============== Form Controls (Compact) ============== */
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .form-control:focus, .form-select:focus {
        background: rgba(255, 255, 255, 0.06);
        border-color: var(--color-teal);
        box-shadow: 0 0 0 2px rgba(0, 255, 198, 0.1);
        color: white;
    }

    .form-label {
        color: var(--color-muted-light);
        font-weight: 500;
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }

    /* ============== Rating & Status Selectors ============== */
    .rating-selector, .status-selector {
        display: flex;
        gap: 0.25rem;
    }

    .rating-option, .status-option {
        flex: 1;
        padding: 0.4rem 0.25rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.02);
    }

    /* ============== Cardio Display ============== */
    .cardio-metric-display {
        background: rgba(255, 82, 82, 0.1);
        border: 1px solid rgba(255, 82, 82, 0.2);
        border-radius: 6px;
        padding: 0.4rem 0.5rem;
        text-align: center;
    }

    .cardio-metric-display .metric-label {
        display: block;
        font-size: 0.65rem;
        color: var(--color-muted-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cardio-metric-display .metric-value {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-red);
    }

    .auto-badge {
        font-size: 0.55rem;
        background: var(--color-teal);
        color: white;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        margin-left: 0.3rem;
        text-transform: uppercase;
        vertical-align: middle;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s ease;
        color: var(--color-muted);
        font-size: 0.8rem;
    }

    .rating-option:hover, .status-option:hover {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.08);
    }

    .rating-option.selected {
        border-color: var(--color-teal);
        background: rgba(0, 255, 198, 0.15);
        color: var(--color-teal);
    }

    .rating-option input, .status-option input { display: none; }

    .status-option.negative { color: var(--color-red); }
    .status-option.neutral { color: var(--color-yellow); }
    .status-option.positive { color: var(--color-teal); }

    .status-option.selected.negative { background: rgba(255, 82, 82, 0.15); border-color: var(--color-red); }
    .status-option.selected.neutral { background: rgba(255, 193, 7, 0.15); border-color: var(--color-yellow); }
    .status-option.selected.positive { background: rgba(0, 255, 198, 0.15); border-color: var(--color-teal); }

    /* ============== Buttons ============== */
    .btn-zyra {
        background: linear-gradient(135deg, var(--color-blue) 0%, var(--color-teal) 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    .btn-zyra:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 16px rgba(0, 119, 255, 0.3);
        color: white;
    }

    .btn-zyra:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Delete button */
    .btn-delete {
        background: transparent;
        border: none;
        color: var(--color-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.75rem;
    }

    .btn-delete:hover {
        color: var(--color-red);
        background: rgba(255, 82, 82, 0.1);
    }

    /* ============== Chart Container ============== */
    .chart-container {
        position: relative;
        height: 220px;
    }

    @media (min-width: 768px) {
        .chart-container { height: 250px; }
    }

    .chart-container.compact {
        height: 180px;
    }

    /* ============== Loading Overlay ============== */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .loading-overlay.active { display: flex; }

    .spinner-zyra {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 255, 198, 0.2);
        border-top-color: var(--color-teal);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
        color: white;
        margin-top: 0.75rem;
        font-size: 0.85rem;
    }

    /* ============== Toast ============== */
    .toast-container {
        position: fixed;
        top: 70px;
        right: 0.75rem;
        z-index: 9999;
        max-width: 320px;
    }

    .toast-zyra {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid var(--color-teal);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        color: white;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
        animation: slideIn 0.3s ease;
    }

    .toast-zyra.error { border-color: var(--color-red); }
    .toast-zyra.success { border-color: var(--color-green); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ============== Confirm Modal ============== */
    .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }

    .confirm-modal.active { display: flex; }

    .confirm-dialog {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 1.25rem;
        max-width: 320px;
        width: 90%;
        text-align: center;
    }

    .confirm-dialog h4 {
        color: white;
        font-size: 1rem;
        margin-bottom: 0.375rem;
    }

    .confirm-dialog p {
        color: var(--color-muted);
        font-size: 0.8rem;
        margin-bottom: 1.25rem;
    }

    .confirm-actions {
        display: flex;
        gap: 0.5rem;
    }

    .confirm-actions button {
        flex: 1;
    }

    /* ============== Large Modal Base (Review, Edit, Day View) ============== */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 10000;
        justify-content: center;
        align-items: flex-start;
        padding: 2rem 1rem;
        overflow-y: auto;
    }

    .modal-overlay.active { display: flex; }

    .modal-content {
        background: rgba(26, 26, 26, 0.98);
        border: 1px solid rgba(0, 255, 198, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
        color: white;
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--color-muted);
        font-size: 1.25rem;
        cursor: pointer;
        padding: 0.25rem;
    }

    .modal-close:hover { color: white; }

    .modal-body { margin-bottom: 1.25rem; }

    .modal-footer {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }

    /* ============== Form Fields in Modals ============== */
    .modal-form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1rem;
    }

    @media (max-width: 500px) {
        .modal-form-grid { grid-template-columns: 1fr; }
    }

    .modal-field {
        display: flex;
        flex-direction: column;
    }

    .modal-field label {
        font-size: 0.75rem;
        color: var(--color-muted-light);
        margin-bottom: 0.25rem;
    }

    .modal-field input {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        color: white;
        font-size: 0.85rem;
    }

    .modal-field input:focus {
        outline: none;
        border-color: var(--color-teal);
    }

    .modal-field input.missing {
        border-color: var(--color-yellow);
        background: rgba(255, 193, 7, 0.1);
    }

    .modal-field input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .modal-field-full { grid-column: span 2; }

    @media (max-width: 500px) {
        .modal-field-full { grid-column: span 1; }
    }

    /* ============== Section Headers in Modals ============== */
    .modal-section {
        margin-bottom: 1.25rem;
    }

    .modal-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-teal);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-section-title.power { color: var(--color-green); }
    .modal-section-title.sleep { color: var(--color-blue); }
    .modal-section-title.warning { color: var(--color-yellow); }

    /* ============== Review Modal Cards ============== */
    .review-card {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .review-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .review-card-type {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
    }

    .review-card-type.cycling { color: var(--color-green); }
    .review-card-type.sleep { color: var(--color-blue); }

    .review-missing-badge {
        background: rgba(255, 193, 7, 0.2);
        color: var(--color-yellow);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    /* ============== Day View Panels ============== */
    .day-panel {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .day-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .day-panel-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .day-panel-title.cycling { color: var(--color-green); }
    .day-panel-title.readiness { color: var(--color-teal); }
    .day-panel-title.sleep { color: var(--color-blue); }

    .day-panel .empty-note {
        color: var(--color-muted);
        font-size: 0.8rem;
        font-style: italic;
    }

    .day-data-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }

    @media (max-width: 500px) {
        .day-data-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .day-data-item {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 0.5rem;
        text-align: center;
    }

    .day-data-item .label {
        font-size: 0.65rem;
        color: var(--color-muted);
        text-transform: uppercase;
    }

    .day-data-item .value {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
    }

    .day-data-item .value.missing {
        color: var(--color-yellow);
        font-style: italic;
    }

    .day-data-item .value.good { color: var(--color-green); }
    .day-data-item .value.hr { color: var(--color-red); }
    .day-data-item .value.sleep { color: var(--color-blue); }

    /* ============== Modal Buttons ============== */
    .btn-modal {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-modal-primary {
        background: linear-gradient(135deg, var(--color-teal), var(--color-green));
        border: none;
        color: #0a0a0a;
    }

    .btn-modal-primary:hover { opacity: 0.9; }

    .btn-modal-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .btn-modal-secondary:hover { background: rgba(255, 255, 255, 0.15); }

    .btn-modal-warning {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid var(--color-yellow);
        color: var(--color-yellow);
    }

    .btn-modal-warning:hover { background: rgba(255, 193, 7, 0.3); }

    /* ============== Action buttons in tables ============== */
    .btn-edit {
        background: none;
        border: none;
        color: var(--color-teal);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
    }

    .btn-edit:hover { opacity: 1; }

    .btn-view-day {
        background: none;
        border: none;
        color: var(--color-blue);
        cursor: pointer;
        padding: 0.25rem;
        margin-right: 0.25rem;
        opacity: 0.7;
        transition: all 0.2s;
        font-size: 0.85rem;
    }

    .btn-view-day:hover { opacity: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: white;
    }

    .btn-cancel:hover { background: rgba(255, 255, 255, 0.12); }

    .btn-confirm-delete {
        background: var(--color-red);
        border: none;
        color: white;
    }

    .btn-confirm-delete:hover { background: #FF3333; }

    /* ============== Extraction Results ============== */
    .extraction-results { margin-top: 0.75rem; }

    .extraction-item {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        padding: 0.5rem 0.625rem;
        margin-bottom: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
    }

    .extraction-item.cycling { border-left: 3px solid var(--color-green); }
    .extraction-item.sleep { border-left: 3px solid var(--color-blue); }
    .extraction-item.unknown { border-left: 3px solid var(--color-yellow); }
    .extraction-item.error { border-left: 3px solid var(--color-red); }

    .extraction-icon {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }

    .extraction-item.cycling .extraction-icon { background: rgba(0, 230, 118, 0.15); color: var(--color-green); }
    .extraction-item.sleep .extraction-icon { background: rgba(0, 119, 255, 0.15); color: var(--color-blue); }
    .extraction-item.unknown .extraction-icon { background: rgba(255, 193, 7, 0.15); color: var(--color-yellow); }
    .extraction-item.error .extraction-icon { background: rgba(255, 82, 82, 0.15); color: var(--color-red); }

    .extraction-details { flex: 1; min-width: 0; }

    .extraction-filename {
        font-size: 0.7rem;
        color: var(--color-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .extraction-type { font-weight: 600; font-size: 0.8rem; }
</style>
{% endblock %}

{% block content %}
<div class="cycle-container py-3">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-zyra"></div>
        <p class="loading-text">Processing screenshots...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Delete Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-dialog">
            <h4><i class="fas fa-exclamation-triangle text-warning me-2"></i><span id="confirmModalTitle">Delete?</span></h4>
            <p>This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Review Missing Data Modal -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit me-2"></i>Review Extracted Data</h3>
                <button class="modal-close" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-muted-light); font-size: 0.85rem; margin-bottom: 1rem;">
                    Some fields could not be extracted. Review and fill in missing values below (yellow highlight).
                </p>
                <div id="reviewContent">
                    <!-- Filled dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="skipReviewAndSave()">Skip & Save As-Is</button>
                <button class="btn-modal btn-modal-primary" onclick="saveReviewedData()">
                    <i class="fas fa-save me-1"></i>Save Corrected Data
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="editWorkoutModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-bicycle me-2" style="color: var(--color-green)"></i>Edit Workout</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editWorkoutId">
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Date</label>
                        <input type="date" id="editDate" name="date">
                    </div>
                    <div class="modal-field">
                        <label>Duration (mm:ss)</label>
                        <input type="text" id="editDuration" placeholder="30:00" pattern="\d+:\d{2}">
                    </div>
                    <div class="modal-field">
                        <label>Avg Power (W)</label>
                        <input type="number" id="editAvgPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Max Power (W)</label>
                        <input type="number" id="editMaxPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Normalized Power (W)</label>
                        <input type="number" id="editNormalizedPower" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Intensity Factor</label>
                        <input type="number" id="editIF" step="0.01" min="0" max="2">
                    </div>
                    <div class="modal-field">
                        <label>TSS</label>
                        <input type="number" id="editTSS" step="0.1">
                    </div>
                    <div class="modal-field">
                        <label>Avg Heart Rate (bpm)</label>
                        <input type="number" id="editAvgHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Max Heart Rate (bpm)</label>
                        <input type="number" id="editMaxHR" min="30" max="250">
                    </div>
                    <div class="modal-field">
                        <label>Avg Cadence (rpm)</label>
                        <input type="number" id="editCadence" min="0" max="200">
                    </div>
                    <div class="modal-field">
                        <label>Distance (km)</label>
                        <input type="number" id="editDistance" step="0.01">
                    </div>
                    <div class="modal-field">
                        <label>Active Calories</label>
                        <input type="number" id="editKcalActive">
                    </div>
                    <div class="modal-field">
                        <label>Total Calories</label>
                        <input type="number" id="editKcalTotal">
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedWorkout()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Readiness Modal -->
    <div id="editReadinessModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-sun me-2" style="color: var(--color-teal)"></i>Edit Readiness Entry</h3>
                <button class="modal-close" onclick="closeEditReadinessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editReadinessId">
                <input type="hidden" id="editReadinessDate">
                <p style="color: var(--color-muted); font-size: 0.75rem; margin-bottom: 1rem;">
                    Edit subjective readiness inputs. Sleep/cardio data is managed via screenshot imports.
                </p>
                
                <!-- Cardio Data Display in Edit Modal -->
                <div id="editCardioDisplay" style="display: none; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">Resting HR</span>
                            <span class="metric-value" id="editDisplayRhr">--</span>
                        </div>
                        <div class="cardio-metric-display" style="flex: 1;">
                            <span class="metric-label">HRV</span>
                            <span class="metric-value" id="editDisplayHrv">--</span>
                        </div>
                    </div>
                    <p style="color: var(--color-muted); font-size: 0.65rem; text-align: center;">
                        <i class="fas fa-magic me-1"></i>Status auto-calculated from 14-day baseline
                    </p>
                </div>
                
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Energy (1-5)</label>
                        <select id="editReadinessEnergy" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Very Low</option>
                            <option value="2">2 - Low</option>
                            <option value="3">3 - Normal</option>
                            <option value="4">4 - Good</option>
                            <option value="5">5 - Great</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Mood (1-3)</label>
                        <select id="editReadinessMood" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - üòî</option>
                            <option value="2">2 - üòê</option>
                            <option value="3">3 - üòä</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Muscle Fatigue (1-3)</label>
                        <select id="editReadinessFatigue" class="form-select">
                            <option value="">--</option>
                            <option value="1">1 - Low</option>
                            <option value="2">2 - Medium</option>
                            <option value="3">3 - High</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>HRV Status <span id="editHrvAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessHRV" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Below Baseline</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Above Baseline</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>RHR Status <span id="editRhrAutoLabel" class="auto-badge" style="display: none;">auto</span></label>
                        <select id="editReadinessRHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Below Normal (good)</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Above Normal</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Min HR Status</label>
                        <select id="editReadinessMinHR" class="form-select">
                            <option value="">--</option>
                            <option value="-1">‚Üì Lower than usual</option>
                            <option value="0">‚Üí Normal</option>
                            <option value="1">‚Üë Higher than usual</option>
                        </select>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>
                            <input type="checkbox" id="editReadinessSymptoms" style="margin-right: 0.5rem;">
                            Experiencing symptoms (illness, injury, etc.)
                        </label>
                    </div>
                    <div class="modal-field modal-field-full">
                        <label>Notes</label>
                        <input type="text" id="editReadinessNotes" placeholder="Optional notes...">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeEditReadinessModal()">Cancel</button>
                <button class="btn-modal btn-modal-primary" onclick="saveEditedReadiness()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Daily Expanded View Modal -->
    <div id="dayViewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-day me-2"></i>Day Summary: <span id="dayViewDate"></span></h3>
                <button class="modal-close" onclick="closeDayViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dayViewContent">
                    <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-secondary" onclick="closeDayViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="cycle-hero">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h1><i class="fas fa-bicycle me-2"></i>Zyra Cycle</h1>
                <p class="subtitle">Cycling performance & morning readiness</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <a href="{{ url_for('cycling_readiness.expanded_table') }}" class="btn-expanded-link" title="View all data in expanded table">
                    <i class="fas fa-table me-1"></i>Expanded View
                </a>
                <span class="date-badge">
                    <i class="fas fa-calendar-day me-1"></i>{{ today }}
                </span>
            </div>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ cycling_stats.total_workouts or 0 }}</div>
            <div class="stat-label">Workouts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value tss">{{ "%.0f"|format(cycling_stats.total_tss or 0) }}</div>
            <div class="stat-label">Total TSS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.0f"|format(cycling_stats.avg_power or 0) }}W</div>
            <div class="stat-label">Avg Power</div>
        </div>
        <div class="stat-card">
            <div class="stat-value time">{{ "%.0f"|format((cycling_stats.total_duration_sec or 0) / 3600) }}h</div>
            <div class="stat-label">Total Time</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="cycle-tabs">
        <button class="cycle-tab active" data-tab="workouts">
            <i class="fas fa-bicycle"></i>Workouts
        </button>
        <button class="cycle-tab" data-tab="readiness">
            <i class="fas fa-moon"></i>Readiness & Sleep
        </button>
    </div>

    <!-- Tab: Workouts -->
    <div id="workoutsTab" class="tab-content active">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Import Section -->
                <div class="section-card">
                    <h3 class="section-title">
                        <i class="fas fa-cloud-upload-alt"></i>Import Screenshots
                    </h3>
                    <form id="bundleUploadForm" enctype="multipart/form-data">
                        <div class="upload-zone" id="bundleUploadZone">
                            <i class="fas fa-images"></i>
                            <p class="title">Drop screenshots here</p>
                            <p class="hint">Cycling app, Apple Watch, Sleep data</p>
                            <input type="file" id="bundleImageInput" name="images" accept="image/*" multiple class="d-none">
                        </div>
                        <div id="fileListContainer" class="file-list d-none"></div>
                        <div id="statusMessage" class="d-none"></div>
                        <div id="uploadActions" class="d-none mt-2">
                            <button type="submit" class="btn btn-zyra w-100" id="uploadBtn">
                                <i class="fas fa-magic me-1"></i>Extract & Merge
                            </button>
                        </div>
                        <div id="extractionResults" class="extraction-results d-none"></div>
                    </form>
                </div>

                <!-- Recent Workouts Table -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-list"></i>Recent Workouts
                    </h3>
                    {% if cycling_workouts %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Power</th>
                                    <th>Avg HR</th>
                                    <th>Max HR</th>
                                    <th>TSS</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cyclingTableBody">
                                {% for workout in cycling_workouts %}
                                <tr data-workout-id="{{ workout.id }}" data-workout-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}">
                                    <td>
                                        <button class="btn-view-day" data-date="{{ workout.date if workout.date is string else workout.date.strftime('%Y-%m-%d') if workout.date else '' }}" title="View Day Details">
                                            {{ workout.date if workout.date is string else workout.date.strftime('%m/%d') if workout.date else '--' }}
                                        </button>
                                    </td>
                                    <td class="val-time">{{ "%d:%02d"|format((workout.duration_sec or 0) // 60, (workout.duration_sec or 0) % 60) if workout.duration_sec else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td class="val-power">{{ "%.0f"|format(workout.avg_power_w) if workout.avg_power_w else '<span class="val-empty">--</span>' | safe }}{{ 'W' if workout.avg_power_w else '' }}</td>
                                    <td class="val-hr">{{ workout.avg_heart_rate if workout.avg_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.avg_heart_rate else '' }}</td>
                                    <td class="val-hr">{{ workout.max_heart_rate if workout.max_heart_rate else '<span class="val-empty">--</span>' | safe }}{{ ' bpm' if workout.max_heart_rate else '' }}</td>
                                    <td class="val-tss">{{ "%.0f"|format(workout.tss) if workout.tss else '<span class="val-empty">--</span>' | safe }}</td>
                                    <td>
                                        <button class="btn-edit btn-edit-workout" data-id="{{ workout.id }}" title="Edit Workout">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn-delete btn-delete-workout" data-id="{{ workout.id }}" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-bicycle"></i>
                        <p>No workouts imported yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Performance Trends Chart -->
                <div class="section-card">
                    <h3 class="section-title power">
                        <i class="fas fa-chart-line"></i>Performance Trends
                    </h3>
                    {% if cycling_chart.dates and cycling_chart.dates|length > 0 %}
                    <div class="chart-container">
                        <canvas id="cyclingChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state power">
                        <i class="fas fa-chart-area"></i>
                        <p>No data yet. Upload screenshots to see your performance trend.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Readiness & Sleep -->
    <div id="readinessTab" class="tab-content">
        <div class="flex-layout">
            <div class="flex-col-main">
                <!-- Training Recommendation Card -->
                <div class="section-card training-rec-card" id="trainingRecommendationCard">
                    <h3 class="section-title training">
                        <i class="fas fa-dumbbell"></i>Today's Training
                        <button class="btn-suggest" id="suggestWorkoutBtn" title="Get AI suggestion">
                            <i class="fas fa-magic"></i> Suggest
                        </button>
                    </h3>
                    
                    <!-- Loading State -->
                    <div id="trainingRecLoading" class="training-rec-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Analyzing your data...</span>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="trainingRecEmpty" class="training-rec-empty">
                        <i class="fas fa-lightbulb"></i>
                        <p>Click "Suggest" to get AI-powered training recommendation based on your readiness, sleep, and recent workouts.</p>
                    </div>
                    
                    <!-- Recommendation Content -->
                    <div id="trainingRecContent" class="training-rec-content" style="display: none;">
                        <div class="training-rec-header">
                            <span class="day-type-badge" id="recDayTypeBadge">--</span>
                            <span class="intensity-tag" id="recIntensityTag">--</span>
                        </div>
                        
                        <div class="training-rec-details">
                            <div class="rec-detail">
                                <i class="fas fa-clock"></i>
                                <span id="recDuration">--</span>
                            </div>
                            <div class="rec-detail">
                                <i class="fas fa-heartbeat"></i>
                                <span id="recZone">--</span>
                            </div>
                        </div>
                        
                        <div class="training-rec-reason" id="recReason">
                            <!-- Reason text will be inserted here -->
                        </div>
                        
                        <div class="training-rec-intervals" id="recIntervals" style="display: none;">
                            <div class="intervals-header">
                                <i class="fas fa-list-ol"></i> Session Plan
                            </div>
                            <div class="intervals-list" id="recIntervalsList">
                                <!-- Intervals will be inserted here -->
                            </div>
                        </div>
                        
                        <div class="training-rec-flags" id="recFlags" style="display: none;">
                            <!-- Flags will be inserted here -->
                        </div>
                        
                        <div class="training-rec-footer">
                            <span class="rec-cached-label" id="recCachedLabel" style="display: none;">
                                <i class="fas fa-database"></i> Cached
                            </span>
                            <button class="btn-refresh-rec" id="refreshRecBtn" title="Refresh recommendation">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Morning Readiness Form -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-sun"></i>Morning Readiness
                    </h3>
                    <form id="readinessForm">
                        <input type="hidden" id="readinessDate" name="date" value="{{ today }}">

                        <!-- Energy -->
                        <div class="mb-2">
                            <label class="form-label">Energy Level</label>
                            <div class="rating-selector" data-field="energy">
                                {% for i in range(1, 6) %}
                                <label class="rating-option"><input type="radio" name="energy" value="{{ i }}">{{ i }}</label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Mood -->
                        <div class="mb-2">
                            <label class="form-label">Mood</label>
                            <div class="rating-selector" data-field="mood">
                                <label class="rating-option"><input type="radio" name="mood" value="1">üòî</label>
                                <label class="rating-option"><input type="radio" name="mood" value="2">üòê</label>
                                <label class="rating-option"><input type="radio" name="mood" value="3">üòä</label>
                            </div>
                        </div>

                        <!-- Muscle Fatigue -->
                        <div class="mb-2">
                            <label class="form-label">Muscle Fatigue</label>
                            <div class="rating-selector" data-field="muscle_fatigue">
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="1">Low</label>
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="2">Med</label>
                                <label class="rating-option"><input type="radio" name="muscle_fatigue" value="3">High</label>
                            </div>
                        </div>

                        <!-- HRV & RHR Section -->
                        <div class="cardio-status-section mb-3" id="cardioStatusSection">
                            <!-- Cardio Data Display (shown when data exists) -->
                            <div id="cardioDataDisplay" style="display: none;">
                                <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                    <i class="fas fa-heartbeat me-1" style="color: var(--color-red);"></i>Cardio metrics from Apple Health
                                </p>
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <div class="cardio-metric-display">
                                            <span class="metric-label">Resting HR</span>
                                            <span class="metric-value" id="displayRhrBpm">--</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="cardio-metric-display">
                                            <span class="metric-label">HRV</span>
                                            <span class="metric-value" id="displayHrv">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Manual Cardio Input (shown when no data) -->
                            <div id="manualCardioInput" style="display: none;">
                                <p class="text-muted small mb-2" style="font-size: 0.7rem; opacity: 0.7;">
                                    <i class="fas fa-edit me-1"></i>No cardio data - enter manually (optional)
                                </p>
                                <div class="row mb-2">
                                    <div class="col-4">
                                        <input type="number" class="form-control form-control-sm" id="manualRhrBpm" 
                                               placeholder="RHR (bpm)" min="40" max="120" style="font-size: 0.75rem;">
                                    </div>
                                    <div class="col-4">
                                        <input type="number" class="form-control form-control-sm" id="manualHrvLow" 
                                               placeholder="HRV low" min="1" max="200" style="font-size: 0.75rem;">
                                    </div>
                                    <div class="col-4">
                                        <input type="number" class="form-control form-control-sm" id="manualHrvHigh" 
                                               placeholder="HRV high" min="1" max="200" style="font-size: 0.75rem;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status Selectors -->
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label class="form-label">
                                        HRV Status
                                        <span class="auto-badge" id="hrvAutoLabel" style="display: none;">auto</span>
                                    </label>
                                    <div class="status-selector" data-field="hrv_status">
                                        <label class="status-option negative"><input type="radio" name="hrv_status" value="-1">‚Üì</label>
                                        <label class="status-option neutral"><input type="radio" name="hrv_status" value="0">‚Üí</label>
                                        <label class="status-option positive"><input type="radio" name="hrv_status" value="1">‚Üë</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">
                                        RHR Status
                                        <span class="auto-badge" id="rhrAutoLabel" style="display: none;">auto</span>
                                    </label>
                                    <div class="status-selector" data-field="rhr_status">
                                        <label class="status-option positive"><input type="radio" name="rhr_status" value="-1">‚Üì</label>
                                        <label class="status-option neutral"><input type="radio" name="rhr_status" value="0">‚Üí</label>
                                        <label class="status-option negative"><input type="radio" name="rhr_status" value="1">‚Üë</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sleep -->
                        <!-- Note: Sleep data is imported from screenshots, not entered manually -->
                        <p class="text-muted small mb-3" style="font-size: 0.7rem; opacity: 0.7;">
                            <i class="fas fa-info-circle me-1"></i>Sleep data is imported from screenshots
                        </p>

                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="symptomsFlag" name="symptoms_flag">
                                <label class="form-check-label" style="font-size: 0.8rem; color: var(--color-muted-light);" for="symptomsFlag">
                                    Experiencing symptoms
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-zyra w-100">
                            <i class="fas fa-save me-1"></i>Save Readiness
                        </button>
                    </form>
                </div>

                <!-- Readiness History -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-history"></i>Readiness History
                        <span class="score-info">
                            <button class="score-info-icon" onclick="toggleScoreTooltip()" title="How is the score calculated?">
                                <i class="fas fa-question-circle"></i>
                            </button>
                            <div class="score-tooltip" id="scoreTooltip">
                                <h4>Readiness Score Formula</h4>
                                <p class="category">Subjective Inputs (40 pts max):</p>
                                <ul>
                                    <li>‚Ä¢ Energy (1-5): up to 20 pts</li>
                                    <li>‚Ä¢ Mood (1-3): up to 10 pts</li>
                                    <li>‚Ä¢ Muscle Fatigue (1-3): up to 10 pts</li>
                                </ul>
                                <p class="category">Recovery (25 pts max):</p>
                                <ul>
                                    <li>‚Ä¢ HRV Status: up to 10 pts</li>
                                    <li>‚Ä¢ RHR Status: up to 10 pts</li>
                                    <li>‚Ä¢ Min HR Status: up to 5 pts</li>
                                </ul>
                                <p class="category">Sleep (25 pts max):</p>
                                <ul>
                                    <li>‚Ä¢ Duration: up to 10 pts (7-9h optimal)</li>
                                    <li>‚Ä¢ Deep Sleep: up to 10 pts (60-120min)</li>
                                    <li>‚Ä¢ Awake Time: up to 5 pts</li>
                                </ul>
                                <p style="color: var(--color-red); margin-top: 0.5rem;">Symptoms: -10 pts if present</p>
                            </div>
                        </span>
                    </h3>
                    {% if readiness_entries %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Score</th>
                                    <th>Energy</th>
                                    <th>Sleep</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in readiness_entries %}
                                <tr data-readiness-id="{{ entry.id }}">
                                    <td>{{ entry.date if entry.date is string else entry.date.strftime('%m/%d') if entry.date else '--' }}</td>
                                    <td>
                                        {% if entry.morning_score %}
                                        <span class="score-badge {% if entry.morning_score >= 70 %}score-high{% elif entry.morning_score >= 40 %}score-medium{% else %}score-low{% endif %}">
                                            {{ entry.morning_score }}
                                        </span>
                                        {% else %}
                                        <span class="val-empty">--</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ entry.energy if entry.energy else '<span class="val-empty">--</span>' | safe }}/5</td>
                                    <td class="val-time">{{ "%.1f"|format((entry.sleep_minutes or 0) / 60) if entry.sleep_minutes else '<span class="val-empty">--</span>' | safe }}{{ 'h' if entry.sleep_minutes else '' }}</td>
                                    <td>
                                        <button class="btn-edit btn-edit-readiness" data-id="{{ entry.id }}" title="Edit">
                                            <i class="fas fa-pencil-alt"></i>
                                        </button>
                                        <button class="btn-delete btn-delete-readiness" data-id="{{ entry.id }}" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state sleep">
                        <i class="fas fa-bed"></i>
                        <p>No readiness entries yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="flex-col-side">
                <!-- Readiness Trend Chart -->
                <div class="section-card">
                    <h3 class="section-title sleep">
                        <i class="fas fa-chart-area"></i>Readiness Trend
                    </h3>
                    {% if readiness_chart.dates and readiness_chart.dates|length > 0 %}
                    <div class="chart-container compact">
                        <canvas id="readinessChart"></canvas>
                    </div>
                    {% else %}
                    <div class="empty-state sleep">
                        <i class="fas fa-chart-line"></i>
                        <p>No readiness data yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============== Toast Helper ==============
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-zyra ${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    // ============== Status Message Helper ==============
    function showStatus(type, message) {
        const el = document.getElementById('statusMessage');
        el.className = `status-msg ${type}`;
        const icon = type === 'loading' ? 'fa-spinner fa-spin' : type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        el.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        el.classList.remove('d-none');
    }

    function hideStatus() {
        document.getElementById('statusMessage').classList.add('d-none');
    }

    // ============== Loading Overlay ==============
    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading(text = 'Processing screenshots...') {
        loadingOverlay.querySelector('.loading-text').textContent = text;
        loadingOverlay.classList.add('active');
    }
    function hideLoading() { loadingOverlay.classList.remove('active'); }

    // ============== Tab Switching ==============
    document.querySelectorAll('.cycle-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.cycle-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
    });

    // ============== Rating Selectors ==============
    document.querySelectorAll('.rating-selector, .status-selector').forEach(selector => {
        selector.querySelectorAll('.rating-option, .status-option').forEach(option => {
            option.addEventListener('click', function() {
                selector.querySelectorAll('.rating-option, .status-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
            });
        });
    });

    // ============== Cardio Status Auto-Fill ==============
    let hasCardioData = false;
    let autoHrvStatus = null;
    let autoRhrStatus = null;

    async function loadCardioStatus(date) {
        try {
            const response = await fetch(`/cycling-readiness/api/cardio-status?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                hasCardioData = data.has_cardio;
                
                const cardioDisplay = document.getElementById('cardioDataDisplay');
                const manualInput = document.getElementById('manualCardioInput');
                const hrvAutoLabel = document.getElementById('hrvAutoLabel');
                const rhrAutoLabel = document.getElementById('rhrAutoLabel');
                
                if (data.has_cardio) {
                    // Show cardio data display
                    cardioDisplay.style.display = 'block';
                    manualInput.style.display = 'none';
                    
                    // Display RHR
                    const rhrDisplay = document.getElementById('displayRhrBpm');
                    if (data.cardio.rhr_bpm) {
                        rhrDisplay.textContent = `${data.cardio.rhr_bpm} bpm`;
                    } else {
                        rhrDisplay.textContent = '--';
                    }
                    
                    // Display HRV
                    const hrvDisplay = document.getElementById('displayHrv');
                    if (data.cardio.hrv_low_ms && data.cardio.hrv_high_ms) {
                        if (data.cardio.hrv_low_ms === data.cardio.hrv_high_ms) {
                            hrvDisplay.textContent = `${data.cardio.hrv_low_ms} ms`;
                        } else {
                            hrvDisplay.textContent = `${data.cardio.hrv_low_ms}‚Äì${data.cardio.hrv_high_ms} ms`;
                        }
                    } else {
                        hrvDisplay.textContent = '--';
                    }
                    
                    // Auto-select status buttons if calculated
                    autoHrvStatus = data.calculated_status.hrv_status;
                    autoRhrStatus = data.calculated_status.rhr_status;
                    
                    if (autoHrvStatus !== null) {
                        const hrvRadio = document.querySelector(`[name="hrv_status"][value="${autoHrvStatus}"]`);
                        if (hrvRadio) {
                            hrvRadio.checked = true;
                            hrvRadio.closest('.status-option').classList.add('selected');
                        }
                        hrvAutoLabel.style.display = 'inline';
                    }
                    
                    if (autoRhrStatus !== null) {
                        const rhrRadio = document.querySelector(`[name="rhr_status"][value="${autoRhrStatus}"]`);
                        if (rhrRadio) {
                            rhrRadio.checked = true;
                            rhrRadio.closest('.status-option').classList.add('selected');
                        }
                        rhrAutoLabel.style.display = 'inline';
                    }
                } else {
                    // Show manual input fields
                    cardioDisplay.style.display = 'none';
                    manualInput.style.display = 'block';
                    hrvAutoLabel.style.display = 'none';
                    rhrAutoLabel.style.display = 'none';
                }
                
                // If there's existing readiness data, use those status values instead
                if (data.existing_readiness) {
                    const er = data.existing_readiness;
                    if (er.hrv_status !== null && er.hrv_status !== undefined) {
                        const hrvRadio = document.querySelector(`[name="hrv_status"][value="${er.hrv_status}"]`);
                        if (hrvRadio) {
                            document.querySelectorAll('[name="hrv_status"]').forEach(r => {
                                r.checked = false;
                                r.closest('.status-option').classList.remove('selected');
                            });
                            hrvRadio.checked = true;
                            hrvRadio.closest('.status-option').classList.add('selected');
                        }
                    }
                    if (er.rhr_status !== null && er.rhr_status !== undefined) {
                        const rhrRadio = document.querySelector(`[name="rhr_status"][value="${er.rhr_status}"]`);
                        if (rhrRadio) {
                            document.querySelectorAll('[name="rhr_status"]').forEach(r => {
                                r.checked = false;
                                r.closest('.status-option').classList.remove('selected');
                            });
                            rhrRadio.checked = true;
                            rhrRadio.closest('.status-option').classList.add('selected');
                        }
                    }
                }
            }
        } catch (err) {
            console.error('Error loading cardio status:', err);
        }
    }

    // Load cardio status on page load
    const today = document.getElementById('readinessDate').value;
    loadCardioStatus(today);

    // ============== Training Recommendation ==============
    const DAY_TYPE_LABELS = {
        'rest': 'Rest Day',
        'recovery_spin_z1': 'Recovery Z1',
        'easy_endurance_z1': 'Easy Z1',
        'steady_endurance_z2': 'Endurance Z2',
        'norwegian_4x4': '4√ó4 VO2max',
        'hybrid_endurance': 'Hybrid',
        'other': 'Training'
    };

    const DAY_TYPE_CLASSES = {
        'rest': 'rest',
        'recovery_spin_z1': 'z1',
        'easy_endurance_z1': 'z1',
        'steady_endurance_z2': 'z2',
        'norwegian_4x4': 'hard',
        'hybrid_endurance': 'z2',
        'other': ''
    };

    async function fetchTrainingRecommendation(date, refresh = false) {
        const loadingEl = document.getElementById('trainingRecLoading');
        const emptyEl = document.getElementById('trainingRecEmpty');
        const contentEl = document.getElementById('trainingRecContent');
        const suggestBtn = document.getElementById('suggestWorkoutBtn');
        
        // Show loading state
        loadingEl.style.display = 'flex';
        emptyEl.style.display = 'none';
        contentEl.style.display = 'none';
        suggestBtn.disabled = true;
        suggestBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        
        try {
            let url = `/cycling-readiness/api/training-recommendation?date=${date}`;
            if (refresh) {
                url += '&refresh=true';
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            loadingEl.style.display = 'none';
            suggestBtn.disabled = false;
            suggestBtn.innerHTML = '<i class="fas fa-magic"></i> Suggest';
            
            if (data.success && data.recommendation) {
                renderTrainingRecommendation(data.recommendation, data.cached);
                contentEl.style.display = 'block';
            } else {
                emptyEl.style.display = 'block';
                if (data.error) {
                    showToast(data.error, 'error');
                }
            }
        } catch (err) {
            console.error('Error fetching training recommendation:', err);
            loadingEl.style.display = 'none';
            emptyEl.style.display = 'block';
            suggestBtn.disabled = false;
            suggestBtn.innerHTML = '<i class="fas fa-magic"></i> Suggest';
            showToast('Could not load training suggestion', 'error');
        }
    }

    function renderTrainingRecommendation(rec, isCached) {
        // Day type badge
        const dayTypeBadge = document.getElementById('recDayTypeBadge');
        dayTypeBadge.textContent = DAY_TYPE_LABELS[rec.day_type] || rec.day_type;
        dayTypeBadge.className = 'day-type-badge ' + (DAY_TYPE_CLASSES[rec.day_type] || '');
        
        // Intensity tag
        const intensityTag = document.getElementById('recIntensityTag');
        if (rec.session_plan && rec.session_plan.overall_intensity) {
            intensityTag.textContent = rec.session_plan.overall_intensity.replace('_', ' ');
            intensityTag.className = 'intensity-tag ' + rec.session_plan.overall_intensity;
            intensityTag.style.display = 'inline';
        } else {
            intensityTag.style.display = 'none';
        }
        
        // Duration
        const durationEl = document.getElementById('recDuration');
        if (rec.session_plan && rec.session_plan.duration_minutes) {
            durationEl.textContent = rec.session_plan.duration_minutes + ' min';
        } else if (rec.day_type === 'rest') {
            durationEl.textContent = 'Rest';
        } else {
            durationEl.textContent = '--';
        }
        
        // Zone
        const zoneEl = document.getElementById('recZone');
        if (rec.session_plan && rec.session_plan.primary_zone) {
            zoneEl.textContent = rec.session_plan.primary_zone;
        } else {
            zoneEl.textContent = '--';
        }
        
        // Reason
        document.getElementById('recReason').textContent = rec.reason_short || '';
        
        // Intervals
        const intervalsContainer = document.getElementById('recIntervals');
        const intervalsList = document.getElementById('recIntervalsList');
        if (rec.session_plan && rec.session_plan.intervals && rec.session_plan.intervals.length > 0) {
            intervalsList.innerHTML = rec.session_plan.intervals.map(interval => {
                let desc = '';
                if (interval.repeats) {
                    desc = `${interval.repeats}√ó ${interval.work_minutes || interval.duration_minutes}min`;
                    if (interval.rest_minutes) {
                        desc += ` / ${interval.rest_minutes}min rest`;
                    }
                } else {
                    desc = `${interval.duration_minutes}min`;
                }
                return `
                    <div class="interval-item">
                        <span class="interval-kind">${interval.kind}</span>
                        <span>${desc}</span>
                        <span class="interval-zone">${interval.target_zone}</span>
                    </div>
                `;
            }).join('');
            intervalsContainer.style.display = 'block';
        } else {
            intervalsContainer.style.display = 'none';
        }
        
        // Flags
        const flagsContainer = document.getElementById('recFlags');
        if (rec.flags && Object.keys(rec.flags).length > 0) {
            const flagsHtml = Object.entries(rec.flags)
                .filter(([_, v]) => v)
                .map(([key, _]) => {
                    const isPositive = ['ok_to_push'].includes(key);
                    const isWarning = ['consider_rest_day', 'prioritize_sleep', 'monitor_hrv'].includes(key);
                    const className = isPositive ? 'positive' : (isWarning ? 'warning' : '');
                    const label = key.replace(/_/g, ' ');
                    return `<span class="rec-flag ${className}">${label}</span>`;
                })
                .join('');
            
            if (flagsHtml) {
                flagsContainer.innerHTML = flagsHtml;
                flagsContainer.style.display = 'flex';
            } else {
                flagsContainer.style.display = 'none';
            }
        } else {
            flagsContainer.style.display = 'none';
        }
        
        // Cached label
        document.getElementById('recCachedLabel').style.display = isCached ? 'inline' : 'none';
    }

    // Suggest button click handler
    document.getElementById('suggestWorkoutBtn').addEventListener('click', function() {
        const date = document.getElementById('readinessDate').value;
        fetchTrainingRecommendation(date, false);
    });

    // Refresh button click handler
    document.getElementById('refreshRecBtn').addEventListener('click', function() {
        const date = document.getElementById('readinessDate').value;
        fetchTrainingRecommendation(date, true);
    });

    // Load existing recommendation on page load (silent, no error toast)
    (async function() {
        try {
            const response = await fetch(`/cycling-readiness/api/training-recommendation?date=${today}`);
            const data = await response.json();
            
            if (data.success && data.recommendation && data.cached) {
                renderTrainingRecommendation(data.recommendation, true);
                document.getElementById('trainingRecEmpty').style.display = 'none';
                document.getElementById('trainingRecContent').style.display = 'block';
            }
        } catch (err) {
            // Silently fail on page load - don't show error
            console.log('No cached recommendation available');
        }
    })();

    // ============== Multi-file Upload ==============
    const bundleZone = document.getElementById('bundleUploadZone');
    const bundleInput = document.getElementById('bundleImageInput');
    const fileListContainer = document.getElementById('fileListContainer');
    const uploadActions = document.getElementById('uploadActions');
    const extractionResults = document.getElementById('extractionResults');
    let selectedFiles = [];

    function updateFileList() {
        if (selectedFiles.length === 0) {
            fileListContainer.classList.add('d-none');
            uploadActions.classList.add('d-none');
            hideStatus();
            return;
        }

        fileListContainer.classList.remove('d-none');
        uploadActions.classList.remove('d-none');
        fileListContainer.innerHTML = selectedFiles.map((file, idx) => `
            <div class="file-item">
                <i class="fas fa-image"></i>
                <span class="filename">${file.name}</span>
                <span class="remove-file" data-idx="${idx}"><i class="fas fa-times"></i></span>
            </div>
        `).join('');

        fileListContainer.querySelectorAll('.remove-file').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedFiles.splice(parseInt(this.dataset.idx), 1);
                updateFileList();
            });
        });
    }

    bundleZone.addEventListener('click', () => bundleInput.click());
    bundleZone.addEventListener('dragover', (e) => { e.preventDefault(); bundleZone.classList.add('dragover'); });
    bundleZone.addEventListener('dragleave', () => bundleZone.classList.remove('dragover'));
    bundleZone.addEventListener('drop', (e) => {
        e.preventDefault();
        bundleZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(e.dataTransfer.files)];
            updateFileList();
        }
    });

    bundleInput.addEventListener('change', function() {
        if (this.files.length) {
            selectedFiles = [...selectedFiles, ...Array.from(this.files)];
            updateFileList();
        }
    });

    // ============== Bundle Upload Form ==============
    document.getElementById('bundleUploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (selectedFiles.length === 0) {
            showToast('Please select at least one image', 'error');
            return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('images', file));

        showLoading(`Processing ${selectedFiles.length} image(s)...`);
        showStatus('loading', 'Analyzing screenshots...');
        extractionResults.classList.add('d-none');
        document.getElementById('uploadBtn').disabled = true;

        try {
            const response = await fetch('/cycling-readiness/api/cycle/import-bundle', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;

            if (data.success) {
                const results = data.extraction_results || [];
                const errors = results.filter(r => r.type === 'error').length;

                if (errors > 0 && errors === results.length) {
                    showStatus('error', 'Could not parse screenshots');
                } else if (errors > 0) {
                    showStatus('success', `Merged successfully! (${errors} failed)`);
                } else {
                    showStatus('success', 'Merged successfully!');
                }

                if (results.length > 0) {
                    extractionResults.classList.remove('d-none');
                    extractionResults.innerHTML = results.map(r => {
                        // Handle both old (cycling_workout) and new (cycling_power, watch_workout) types
                        const isCycling = r.type === 'cycling_workout' || r.type === 'cycling_power' || r.type === 'watch_workout';
                        const isSleep = r.type === 'sleep_summary';
                        const isError = r.type === 'error';
                        
                        const typeClass = isCycling ? 'cycling' : isSleep ? 'sleep' : isError ? 'error' : 'unknown';
                        const icon = isCycling ? 'fa-bicycle' : isSleep ? 'fa-moon' : isError ? 'fa-exclamation-triangle' : 'fa-question';
                        const typeName = isCycling ? 'Cycling' : isSleep ? 'Sleep' : isError ? 'Error' : 'Unknown';
                        const confidence = r.confidence ? ` (${Math.round(r.confidence * 100)}%)` : '';
                        
                        return `
                            <div class="extraction-item ${typeClass}">
                                <div class="extraction-icon"><i class="fas ${icon}"></i></div>
                                <div class="extraction-details">
                                    <div class="extraction-type">${typeName}${confidence}</div>
                                    <div class="extraction-filename">${r.filename}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                selectedFiles = [];
                updateFileList();
                
                // Check if there's missing data that needs review
                if (data.has_missing_data && 
                    (data.missing_fields?.workout?.length > 0 || data.missing_fields?.sleep?.length > 0)) {
                    // Store the data for review modal
                    window.lastImportData = data;
                    showReviewModal(data);
                } else {
                    // No missing data, reload after showing results
                    setTimeout(() => location.reload(), 2500);
                }
            } else {
                showStatus('error', data.error || 'Import failed');
                showToast(data.error || 'Import failed', 'error');
            }
        } catch (err) {
            hideLoading();
            document.getElementById('uploadBtn').disabled = false;
            showStatus('error', 'Error processing images');
            showToast('Error processing images', 'error');
        }
    });

    // ============== Readiness Form ==============
    document.getElementById('readinessForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Get manual cardio values if no screenshot data exists
        const manualRhr = document.getElementById('manualRhrBpm')?.value;
        const manualHrvLow = document.getElementById('manualHrvLow')?.value;
        const manualHrvHigh = document.getElementById('manualHrvHigh')?.value;

        // Note: Sleep data is now imported via screenshots, not entered manually
        const data = {
            date: document.getElementById('readinessDate').value,
            energy: document.querySelector('[name="energy"]:checked')?.value,
            mood: document.querySelector('[name="mood"]:checked')?.value,
            muscle_fatigue: document.querySelector('[name="muscle_fatigue"]:checked')?.value,
            hrv_status: document.querySelector('[name="hrv_status"]:checked')?.value,
            rhr_status: document.querySelector('[name="rhr_status"]:checked')?.value,
            min_hr_status: 0,
            symptoms_flag: document.getElementById('symptomsFlag').checked
        };

        // Include manual cardio values if entered (when no screenshot data)
        if (!hasCardioData) {
            if (manualRhr) {
                data.manual_rhr_bpm = parseInt(manualRhr);
            }
            if (manualHrvLow && manualHrvHigh) {
                data.manual_hrv_low_ms = parseInt(manualHrvLow);
                data.manual_hrv_high_ms = parseInt(manualHrvHigh);
            }
        }

        // If status not explicitly selected, pass null for auto-calculation
        if (data.hrv_status === undefined) data.hrv_status = null;
        if (data.rhr_status === undefined) data.rhr_status = null;

        if (!data.energy || !data.mood || !data.muscle_fatigue) {
            showToast('Please fill Energy, Mood, and Fatigue', 'error');
            return;
        }

        try {
            const response = await fetch('/cycling-readiness/api/readiness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                showToast(`Saved! Score: ${result.morning_score}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(result.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Error saving readiness', 'error');
        }
    });

    // ============== Delete Records ==============
    let deleteType = null; // 'workout', 'readiness', or 'sleep'
    let deleteId = null;

    window.closeConfirmModal = function() {
        document.getElementById('confirmModal').classList.remove('active');
        deleteType = null;
        deleteId = null;
    };

    function showConfirmModal(type, id) {
        deleteType = type;
        deleteId = id;
        
        // Set modal title based on type
        const titles = {
            'workout': 'Delete Workout?',
            'readiness': 'Delete Readiness Entry?',
            'sleep': 'Delete Sleep Summary?'
        };
        document.getElementById('confirmModalTitle').textContent = titles[type] || 'Delete?';
        document.getElementById('confirmModal').classList.add('active');
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (!deleteId || !deleteType) return;

        let endpoint = '';
        let successMessage = '';
        
        switch(deleteType) {
            case 'workout':
                endpoint = `/cycling-readiness/api/cycling/${deleteId}`;
                successMessage = 'Workout deleted';
                break;
            case 'readiness':
                endpoint = `/cycling-readiness/api/readiness/${deleteId}`;
                successMessage = 'Readiness entry deleted';
                break;
            case 'sleep':
                endpoint = `/cycling-readiness/api/sleep/${deleteId}`;
                successMessage = 'Sleep summary deleted';
                break;
            default:
                closeConfirmModal();
                return;
        }

        try {
            const response = await fetch(endpoint, { method: 'DELETE' });
            const data = await response.json();
            closeConfirmModal();

            if (data.success) {
                showToast(successMessage, 'success');
                // Reload page after short delay to update stats and charts
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(data.error || 'Failed to delete', 'error');
            }
        } catch (err) {
            closeConfirmModal();
            showToast('Error deleting record', 'error');
        }
    });

    // Workout delete buttons
    document.querySelectorAll('.btn-delete-workout').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showConfirmModal('workout', this.dataset.id);
        });
    });

    // Readiness delete buttons
    document.querySelectorAll('.btn-delete-readiness').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            showConfirmModal('readiness', this.dataset.id);
        });
    });

    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmModal();
    });

    // ============== Edit Workout Functions ==============
    
    // Edit workout buttons
    document.querySelectorAll('.btn-edit-workout').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const workoutId = this.dataset.id;
            await openEditModal(workoutId);
        });
    });

    async function openEditModal(workoutId) {
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`);
            const data = await response.json();
            
            if (data.success && data.workout) {
                const w = data.workout;
                document.getElementById('editWorkoutId').value = w.id;
                document.getElementById('editDate').value = w.date || '';
                
                // Convert duration_sec to mm:ss
                if (w.duration_sec) {
                    const mins = Math.floor(w.duration_sec / 60);
                    const secs = w.duration_sec % 60;
                    document.getElementById('editDuration').value = `${mins}:${secs.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('editDuration').value = '';
                }
                
                document.getElementById('editAvgPower').value = w.avg_power_w || '';
                document.getElementById('editMaxPower').value = w.max_power_w || '';
                document.getElementById('editNormalizedPower').value = w.normalized_power_w || '';
                document.getElementById('editIF').value = w.intensity_factor || '';
                document.getElementById('editTSS').value = w.tss || '';
                document.getElementById('editAvgHR').value = w.avg_heart_rate || '';
                document.getElementById('editMaxHR').value = w.max_heart_rate || '';
                document.getElementById('editCadence').value = w.avg_cadence || '';
                document.getElementById('editDistance').value = w.distance_km || '';
                document.getElementById('editKcalActive').value = w.kcal_active || '';
                document.getElementById('editKcalTotal').value = w.kcal_total || '';
                document.getElementById('editNotes').value = w.notes || '';
                
                document.getElementById('editWorkoutModal').classList.add('active');
            } else {
                showToast('Failed to load workout', 'error');
            }
        } catch (err) {
            showToast('Error loading workout', 'error');
        }
    }

    window.closeEditModal = function() {
        document.getElementById('editWorkoutModal').classList.remove('active');
    };

    window.saveEditedWorkout = async function() {
        const workoutId = document.getElementById('editWorkoutId').value;
        
        // Parse duration mm:ss to seconds
        let durationSec = null;
        const durationVal = document.getElementById('editDuration').value;
        if (durationVal) {
            const parts = durationVal.split(':');
            if (parts.length === 2) {
                durationSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
        }
        
        const data = {
            date: document.getElementById('editDate').value || null,
            duration_sec: durationSec,
            avg_power_w: parseFloat(document.getElementById('editAvgPower').value) || null,
            max_power_w: parseFloat(document.getElementById('editMaxPower').value) || null,
            normalized_power_w: parseFloat(document.getElementById('editNormalizedPower').value) || null,
            intensity_factor: parseFloat(document.getElementById('editIF').value) || null,
            tss: parseFloat(document.getElementById('editTSS').value) || null,
            avg_heart_rate: parseInt(document.getElementById('editAvgHR').value) || null,
            max_heart_rate: parseInt(document.getElementById('editMaxHR').value) || null,
            avg_cadence: parseInt(document.getElementById('editCadence').value) || null,
            distance_km: parseFloat(document.getElementById('editDistance').value) || null,
            kcal_active: parseInt(document.getElementById('editKcalActive').value) || null,
            kcal_total: parseInt(document.getElementById('editKcalTotal').value) || null,
            notes: document.getElementById('editNotes').value || null
        };
        
        try {
            const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                closeEditModal();
                showToast('Workout updated!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error saving workout', 'error');
        }
    };

    document.getElementById('editWorkoutModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditModal();
    });

    // ============== Edit Readiness Functions ==============
    
    // Edit readiness buttons
    document.querySelectorAll('.btn-edit-readiness').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const entryId = this.dataset.id;
            await openEditReadinessModal(entryId);
        });
    });

    async function openEditReadinessModal(entryId) {
        try {
            const response = await fetch(`/cycling-readiness/api/readiness/${entryId}`);
            const data = await response.json();
            
            if (data.success && data.entry) {
                const e = data.entry;
                document.getElementById('editReadinessId').value = e.id;
                document.getElementById('editReadinessDate').value = e.date;
                document.getElementById('editReadinessEnergy').value = e.energy || '';
                document.getElementById('editReadinessMood').value = e.mood || '';
                document.getElementById('editReadinessFatigue').value = e.muscle_fatigue || '';
                document.getElementById('editReadinessHRV').value = e.hrv_status !== null ? e.hrv_status : '';
                document.getElementById('editReadinessRHR').value = e.rhr_status !== null ? e.rhr_status : '';
                document.getElementById('editReadinessMinHR').value = e.min_hr_status !== null ? e.min_hr_status : '';
                document.getElementById('editReadinessSymptoms').checked = e.symptoms_flag || false;
                document.getElementById('editReadinessNotes').value = e.evening_note || '';
                
                // Load cardio status for this date
                const cardioDisplay = document.getElementById('editCardioDisplay');
                const hrvAutoLabel = document.getElementById('editHrvAutoLabel');
                const rhrAutoLabel = document.getElementById('editRhrAutoLabel');
                
                cardioDisplay.style.display = 'none';
                hrvAutoLabel.style.display = 'none';
                rhrAutoLabel.style.display = 'none';
                
                try {
                    const cardioRes = await fetch(`/cycling-readiness/api/cardio-status?date=${e.date}`);
                    const cardioData = await cardioRes.json();
                    
                    if (cardioData.success && cardioData.has_cardio) {
                        cardioDisplay.style.display = 'block';
                        
                        // Display RHR
                        const rhrDisplay = document.getElementById('editDisplayRhr');
                        if (cardioData.cardio.rhr_bpm) {
                            rhrDisplay.textContent = `${cardioData.cardio.rhr_bpm} bpm`;
                        } else {
                            rhrDisplay.textContent = '--';
                        }
                        
                        // Display HRV
                        const hrvDisplay = document.getElementById('editDisplayHrv');
                        if (cardioData.cardio.hrv_low_ms && cardioData.cardio.hrv_high_ms) {
                            if (cardioData.cardio.hrv_low_ms === cardioData.cardio.hrv_high_ms) {
                                hrvDisplay.textContent = `${cardioData.cardio.hrv_low_ms} ms`;
                            } else {
                                hrvDisplay.textContent = `${cardioData.cardio.hrv_low_ms}‚Äì${cardioData.cardio.hrv_high_ms} ms`;
                            }
                        } else {
                            hrvDisplay.textContent = '--';
                        }
                        
                        // Show auto labels if status was calculated
                        if (cardioData.calculated_status.hrv_status !== null) {
                            hrvAutoLabel.style.display = 'inline';
                        }
                        if (cardioData.calculated_status.rhr_status !== null) {
                            rhrAutoLabel.style.display = 'inline';
                        }
                    }
                } catch (cardioErr) {
                    console.error('Error loading cardio status:', cardioErr);
                }
                
                document.getElementById('editReadinessModal').classList.add('active');
            } else {
                showToast('Failed to load entry', 'error');
            }
        } catch (err) {
            showToast('Error loading entry', 'error');
        }
    }

    window.closeEditReadinessModal = function() {
        document.getElementById('editReadinessModal').classList.remove('active');
    };

    window.saveEditedReadiness = async function() {
        const entryId = document.getElementById('editReadinessId').value;
        
        const data = {
            energy: parseInt(document.getElementById('editReadinessEnergy').value) || null,
            mood: parseInt(document.getElementById('editReadinessMood').value) || null,
            muscle_fatigue: parseInt(document.getElementById('editReadinessFatigue').value) || null,
            hrv_status: document.getElementById('editReadinessHRV').value !== '' ? 
                parseInt(document.getElementById('editReadinessHRV').value) : null,
            rhr_status: document.getElementById('editReadinessRHR').value !== '' ? 
                parseInt(document.getElementById('editReadinessRHR').value) : null,
            min_hr_status: document.getElementById('editReadinessMinHR').value !== '' ? 
                parseInt(document.getElementById('editReadinessMinHR').value) : null,
            symptoms_flag: document.getElementById('editReadinessSymptoms').checked,
            evening_note: document.getElementById('editReadinessNotes').value || null
        };
        
        try {
            const response = await fetch(`/cycling-readiness/api/readiness/${entryId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                closeEditReadinessModal();
                showToast('Entry updated!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(result.error || 'Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error saving entry', 'error');
        }
    };

    document.getElementById('editReadinessModal').addEventListener('click', function(e) {
        if (e.target === this) closeEditReadinessModal();
    });

    // ============== Score Tooltip ==============
    
    window.toggleScoreTooltip = function() {
        const tooltip = document.getElementById('scoreTooltip');
        tooltip.classList.toggle('active');
    };

    // Close tooltip when clicking outside
    document.addEventListener('click', function(e) {
        const tooltip = document.getElementById('scoreTooltip');
        const infoBtn = document.querySelector('.score-info-icon');
        if (tooltip && !tooltip.contains(e.target) && !infoBtn.contains(e.target)) {
            tooltip.classList.remove('active');
        }
    });

    // ============== Day View Functions ==============
    
    // View day buttons
    document.querySelectorAll('.btn-view-day').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const date = this.dataset.date;
            if (date) {
                await openDayViewModal(date);
            }
        });
    });

    async function openDayViewModal(date) {
        document.getElementById('dayViewDate').textContent = date;
        document.getElementById('dayViewModal').classList.add('active');
        document.getElementById('dayViewContent').innerHTML = `
            <div class="text-center" style="padding: 2rem; color: var(--color-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading...
            </div>
        `;
        
        try {
            const response = await fetch(`/cycling-readiness/api/day-summary?date=${date}`);
            const data = await response.json();
            
            if (data.success) {
                renderDayView(data);
            } else {
                document.getElementById('dayViewContent').innerHTML = `
                    <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load data
                    </div>
                `;
            }
        } catch (err) {
            document.getElementById('dayViewContent').innerHTML = `
                <div class="text-center" style="padding: 2rem; color: var(--color-red);">
                    <i class="fas fa-exclamation-triangle"></i> Error loading data
                </div>
            `;
        }
    }

    function renderDayView(data) {
        const container = document.getElementById('dayViewContent');
        let html = '';
        
        // Cycling Workout Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title cycling"><i class="fas fa-bicycle me-2"></i>Cycling Workout</div>
                ${data.cycling_workout ? `<button class="btn-edit" onclick="openEditModal(${data.cycling_workout.id})" title="Edit"><i class="fas fa-pencil-alt"></i></button>` : ''}
            </div>`;
        
        if (data.cycling_workout) {
            const w = data.cycling_workout;
            const missingCycling = data.missing?.cycling || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Duration', formatDuration(w.duration_sec), missingCycling.includes('duration_sec'))}
                ${renderDayDataItem('Avg Power', w.avg_power_w ? w.avg_power_w + 'W' : null, missingCycling.includes('avg_power_w'), 'good')}
                ${renderDayDataItem('Max Power', w.max_power_w ? w.max_power_w + 'W' : null, missingCycling.includes('max_power_w'), 'good')}
                ${renderDayDataItem('NP', w.normalized_power_w ? w.normalized_power_w + 'W' : null, missingCycling.includes('normalized_power_w'), 'good')}
                ${renderDayDataItem('Avg HR', w.avg_heart_rate ? w.avg_heart_rate + ' bpm' : null, missingCycling.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', w.max_heart_rate ? w.max_heart_rate + ' bpm' : null, missingCycling.includes('max_heart_rate'), 'hr')}
                ${renderDayDataItem('TSS', w.tss, missingCycling.includes('tss'))}
                ${renderDayDataItem('IF', w.intensity_factor, missingCycling.includes('intensity_factor'))}
                ${renderDayDataItem('Cadence', w.avg_cadence ? w.avg_cadence + ' rpm' : null, missingCycling.includes('avg_cadence'))}
                ${renderDayDataItem('Distance', w.distance_km ? w.distance_km + ' km' : null, missingCycling.includes('distance_km'))}
                ${renderDayDataItem('Active kcal', w.kcal_active, missingCycling.includes('kcal_active'))}
                ${renderDayDataItem('Total kcal', w.kcal_total, missingCycling.includes('kcal_total'))}
            </div>`;
        } else {
            html += `<p class="empty-note">No cycling workout recorded for this date.</p>`;
        }
        html += `</div>`;
        
        // Readiness Entry Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title readiness"><i class="fas fa-sun me-2"></i>Readiness Entry</div>
            </div>`;
        
        if (data.readiness_entry) {
            const r = data.readiness_entry;
            const missingReadiness = data.missing?.readiness || [];
            const score = r.morning_score;
            const scoreClass = score >= 70 ? 'good' : score >= 40 ? '' : 'missing';
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Score', score, false, scoreClass)}
                ${renderDayDataItem('Energy', r.energy ? r.energy + '/5' : null, missingReadiness.includes('energy'))}
                ${renderDayDataItem('Mood', r.mood ? r.mood + '/3' : null, missingReadiness.includes('mood'))}
                ${renderDayDataItem('Fatigue', r.muscle_fatigue ? r.muscle_fatigue + '/3' : null, missingReadiness.includes('muscle_fatigue'))}
                ${renderDayDataItem('Sleep', r.sleep_minutes ? (r.sleep_minutes / 60).toFixed(1) + 'h' : null, missingReadiness.includes('sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', r.deep_sleep_minutes ? r.deep_sleep_minutes + 'min' : null, missingReadiness.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Awake', r.awake_minutes ? r.awake_minutes + 'min' : null, false)}
                ${renderDayDataItem('Symptoms', r.symptoms_flag ? 'Yes' : 'No', false)}
            </div>`;
        } else {
            html += `<p class="empty-note">No readiness entry for this date.</p>`;
        }
        html += `</div>`;
        
        // Sleep Summary Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title sleep"><i class="fas fa-moon me-2"></i>Sleep Summary</div>
            </div>`;
        
        if (data.sleep_summary) {
            const s = data.sleep_summary;
            const missingSleep = data.missing?.sleep || [];
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Total Sleep', s.total_sleep_minutes ? (s.total_sleep_minutes / 60).toFixed(1) + 'h' : null, missingSleep.includes('total_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Deep Sleep', s.deep_sleep_minutes ? s.deep_sleep_minutes + 'min' : null, missingSleep.includes('deep_sleep_minutes'), 'sleep')}
                ${renderDayDataItem('Awake', s.awake_minutes ? s.awake_minutes + 'min' : null, missingSleep.includes('awake_minutes'))}
                ${renderDayDataItem('Start', formatTime(s.sleep_start_time), false)}
                ${renderDayDataItem('End', formatTime(s.sleep_end_time), false)}
                ${renderDayDataItem('Min HR', s.min_heart_rate ? s.min_heart_rate + ' bpm' : null, missingSleep.includes('min_heart_rate'), 'hr')}
                ${renderDayDataItem('Avg HR', s.avg_heart_rate ? s.avg_heart_rate + ' bpm' : null, missingSleep.includes('avg_heart_rate'), 'hr')}
                ${renderDayDataItem('Max HR', s.max_heart_rate ? s.max_heart_rate + ' bpm' : null, missingSleep.includes('max_heart_rate'), 'hr')}
            </div>`;
        } else {
            html += `<p class="empty-note">No sleep data for this date.</p>`;
        }
        html += `</div>`;
        
        // Cardio Metrics Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title" style="color: var(--color-red);"><i class="fas fa-heartbeat me-2"></i>Cardio Metrics</div>
            </div>`;
        
        if (data.cardio_metrics) {
            const c = data.cardio_metrics;
            const missingCardio = data.missing?.cardio || [];
            
            // Format RHR (single value)
            let rhrDisplay = null;
            if (c.rhr_bpm !== null && c.rhr_bpm !== undefined) {
                rhrDisplay = `${c.rhr_bpm} bpm`;
            }
            
            // Format HRV range
            let hrvDisplay = null;
            if (c.hrv_low_ms !== null && c.hrv_high_ms !== null) {
                if (c.hrv_low_ms === c.hrv_high_ms) {
                    hrvDisplay = `${c.hrv_low_ms} ms`;
                } else {
                    hrvDisplay = `${c.hrv_low_ms}‚Äì${c.hrv_high_ms} ms`;
                }
            }
            
            html += `<div class="day-data-grid">
                ${renderDayDataItem('Resting HR', rhrDisplay, missingCardio.includes('rhr_bpm'), 'hr')}
                ${renderDayDataItem('HRV', hrvDisplay, missingCardio.includes('hrv_low_ms') || missingCardio.includes('hrv_high_ms'))}
            </div>`;
        } else {
            html += `<p class="empty-note">No cardio metrics for this date.</p>`;
        }
        html += `</div>`;
        
        // Training Recommendation Panel
        html += `<div class="day-panel">
            <div class="day-panel-header">
                <div class="day-panel-title" style="color: var(--color-yellow);"><i class="fas fa-dumbbell me-2"></i>Training Recommendation</div>
            </div>`;
        
        if (data.training_recommendation) {
            const rec = data.training_recommendation;
            const dayTypeLabel = DAY_TYPE_LABELS[rec.day_type] || rec.day_type;
            const dayTypeClass = DAY_TYPE_CLASSES[rec.day_type] || '';
            
            html += `
                <div class="training-rec-mini">
                    <div class="rec-mini-header">
                        <span class="day-type-badge ${dayTypeClass}">${dayTypeLabel}</span>
                        ${rec.session_plan ? `
                            <span class="rec-mini-details">
                                <i class="fas fa-clock"></i> ${rec.session_plan.duration_minutes}min
                                <i class="fas fa-heartbeat ms-2"></i> ${rec.session_plan.primary_zone}
                            </span>
                        ` : ''}
                    </div>
                    <p class="rec-mini-reason">${rec.reason_short}</p>
                    ${rec.session_plan && rec.session_plan.intervals ? `
                        <div class="rec-mini-intervals">
                            ${rec.session_plan.intervals.map(interval => {
                                let desc = interval.repeats 
                                    ? `${interval.repeats}√ó ${interval.work_minutes || interval.duration_minutes}min`
                                    : `${interval.duration_minutes}min`;
                                return `<span class="interval-chip">${interval.kind} ${desc} ${interval.target_zone}</span>`;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            html += `<p class="empty-note">No recommendation saved for this date.</p>`;
        }
        html += `</div>`;
        
        container.innerHTML = html;
    }

    function renderDayDataItem(label, value, isMissing, valueClass = '') {
        const displayValue = value !== null && value !== undefined ? value : '--';
        const missingClass = isMissing ? 'missing' : valueClass;
        return `
            <div class="day-data-item">
                <div class="label">${label}</div>
                <div class="value ${missingClass}">${displayValue}</div>
            </div>
        `;
    }

    function formatDuration(seconds) {
        if (!seconds) return null;
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function formatTime(timeValue) {
        if (!timeValue) return null;
        // Handle time strings like "22:00:00" or seconds
        if (typeof timeValue === 'string' && timeValue.includes(':')) {
            return timeValue.substring(0, 5); // Return HH:MM
        }
        // Handle seconds (e.g., 79200 = 22:00)
        if (typeof timeValue === 'number') {
            const hours = Math.floor(timeValue / 3600) % 24;
            const mins = Math.floor((timeValue % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }
        return timeValue;
    }

    window.closeDayViewModal = function() {
        document.getElementById('dayViewModal').classList.remove('active');
    };

    document.getElementById('dayViewModal').addEventListener('click', function(e) {
        if (e.target === this) closeDayViewModal();
    });

    // ============== Review Modal Functions ==============
    
    let reviewData = null;

    function showReviewModal(data) {
        reviewData = data;
        const container = document.getElementById('reviewContent');
        let html = '';
        
        // Workout review card
        if (data.canonical_workout && data.canonical_workout.date) {
            const cw = data.canonical_workout;
            const missingWorkout = data.missing_fields?.workout || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type cycling"><i class="fas fa-bicycle me-1"></i>Cycling Workout</span>
                    ${missingWorkout.length > 0 ? `<span class="review-missing-badge">${missingWorkout.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('duration_sec', 'Duration (sec)', cw.duration_minutes ? Math.round(cw.duration_minutes * 60) : null, missingWorkout)}
                    ${renderReviewField('avg_power_w', 'Avg Power (W)', cw.avg_power, missingWorkout)}
                    ${renderReviewField('max_power_w', 'Max Power (W)', cw.max_power, missingWorkout)}
                    ${renderReviewField('normalized_power_w', 'NP (W)', cw.normalized_power, missingWorkout)}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cw.avg_hr, missingWorkout)}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cw.max_hr, missingWorkout)}
                    ${renderReviewField('tss', 'TSS', cw.tss, missingWorkout)}
                    ${renderReviewField('intensity_factor', 'IF', cw.intensity_factor, missingWorkout)}
                    ${renderReviewField('avg_cadence', 'Cadence (rpm)', cw.cadence_avg, missingWorkout)}
                    ${renderReviewField('distance_km', 'Distance (km)', cw.distance_km, missingWorkout)}
                    ${renderReviewField('kcal_active', 'Active kcal', cw.calories_active, missingWorkout)}
                    ${renderReviewField('kcal_total', 'Total kcal', cw.calories_total, missingWorkout)}
                </div>
            </div>`;
        }
        
        // Sleep review card
        if (data.canonical_sleep && data.canonical_sleep.date) {
            const cs = data.canonical_sleep;
            const missingSleep = data.missing_fields?.sleep || [];
            
            html += `<div class="review-card">
                <div class="review-card-header">
                    <span class="review-card-type sleep"><i class="fas fa-moon me-1"></i>Sleep Summary</span>
                    ${missingSleep.length > 0 ? `<span class="review-missing-badge">${missingSleep.length} missing</span>` : '<span style="color: var(--color-green); font-size: 0.8rem;"><i class="fas fa-check"></i> Complete</span>'}
                </div>
                <div class="modal-form-grid">
                    ${renderReviewField('total_sleep_minutes', 'Total Sleep (min)', cs.total_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('deep_sleep_minutes', 'Deep Sleep (min)', cs.deep_sleep_minutes, missingSleep, 'sleep_')}
                    ${renderReviewField('wakeups_count', 'Wakeups', cs.wakeups, missingSleep, 'sleep_')}
                    ${renderReviewField('min_heart_rate', 'Min HR (bpm)', cs.min_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('avg_heart_rate', 'Avg HR (bpm)', cs.avg_hr, missingSleep, 'sleep_')}
                    ${renderReviewField('max_heart_rate', 'Max HR (bpm)', cs.max_hr, missingSleep, 'sleep_')}
                </div>
            </div>`;
        }
        
        if (!html) {
            html = '<p style="color: var(--color-muted);">No data to review.</p>';
        }
        
        container.innerHTML = html;
        document.getElementById('reviewModal').classList.add('active');
    }

    function renderReviewField(fieldName, label, value, missingFields, prefix = '') {
        const isMissing = missingFields.includes(fieldName);
        const inputId = prefix + fieldName;
        return `
            <div class="modal-field">
                <label>${label}</label>
                <input type="number" id="review_${inputId}" class="${isMissing ? 'missing' : ''}" 
                       value="${value !== null && value !== undefined ? value : ''}" 
                       step="any" placeholder="${isMissing ? 'Missing - enter value' : ''}">
            </div>
        `;
    }

    window.closeReviewModal = function() {
        document.getElementById('reviewModal').classList.remove('active');
        reviewData = null;
        // Reload to show saved data
        setTimeout(() => location.reload(), 500);
    };

    window.skipReviewAndSave = function() {
        // Data was already saved during import, just close modal
        closeReviewModal();
    };

    window.saveReviewedData = async function() {
        if (!reviewData) return;
        
        const workoutId = reviewData.workout_id;
        
        // Collect workout corrections if we have a workout
        if (workoutId) {
            const workoutUpdates = {
                duration_sec: parseInt(document.getElementById('review_duration_sec')?.value) || null,
                avg_power_w: parseFloat(document.getElementById('review_avg_power_w')?.value) || null,
                max_power_w: parseFloat(document.getElementById('review_max_power_w')?.value) || null,
                normalized_power_w: parseFloat(document.getElementById('review_normalized_power_w')?.value) || null,
                avg_heart_rate: parseInt(document.getElementById('review_avg_heart_rate')?.value) || null,
                max_heart_rate: parseInt(document.getElementById('review_max_heart_rate')?.value) || null,
                tss: parseFloat(document.getElementById('review_tss')?.value) || null,
                intensity_factor: parseFloat(document.getElementById('review_intensity_factor')?.value) || null,
                avg_cadence: parseInt(document.getElementById('review_avg_cadence')?.value) || null,
                distance_km: parseFloat(document.getElementById('review_distance_km')?.value) || null,
                kcal_active: parseInt(document.getElementById('review_kcal_active')?.value) || null,
                kcal_total: parseInt(document.getElementById('review_kcal_total')?.value) || null
            };
            
            try {
                const response = await fetch(`/cycling-readiness/api/cycling/${workoutId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(workoutUpdates)
                });
                
                const result = await response.json();
                if (!result.success) {
                    showToast('Failed to update workout', 'error');
                    return;
                }
            } catch (err) {
                showToast('Error updating workout', 'error');
                return;
            }
        }
        
        // Note: Sleep data is already saved and linked to readiness
        // Future enhancement: add sleep update endpoint if needed
        
        showToast('Data updated successfully!', 'success');
        closeReviewModal();
    };

    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) closeReviewModal();
    });

    // ============== Charts ==============
    const cyclingChartData = {{ cycling_chart | tojson | safe }};
    const readinessChartData = {{ readiness_chart | tojson | safe }};

    const chartDefaults = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: {
                labels: { color: 'rgba(255,255,255,0.6)', boxWidth: 10, font: { size: 10 } }
            }
        },
        scales: {
            x: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 }, maxRotation: 0 },
                grid: { color: 'rgba(255,255,255,0.04)' }
            },
            y: {
                ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                grid: { color: 'rgba(255,255,255,0.04)' }
            }
        }
    };

    // Cycling Chart
    if (cyclingChartData.dates && cyclingChartData.dates.length > 0) {
        new Chart(document.getElementById('cyclingChart'), {
            type: 'line',
            data: {
                labels: cyclingChartData.dates,
                datasets: [
                    {
                        label: 'Power (W)',
                        data: cyclingChartData.avg_power,
                        borderColor: '#00E676',
                        backgroundColor: 'rgba(0, 230, 118, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2
                    },
                    {
                        label: 'Avg HR',
                        data: cyclingChartData.avg_heart_rate,
                        borderColor: '#FF5252',
                        backgroundColor: 'rgba(255, 82, 82, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 2,
                        yAxisID: 'y2'
                    },
                    {
                        label: 'TSS',
                        data: cyclingChartData.tss,
                        borderColor: '#FFC107',
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 2
                    }
                ]
            },
            options: {
                ...chartDefaults,
                scales: {
                    ...chartDefaults.scales,
                    y1: {
                        position: 'right',
                        ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } },
                        grid: { display: false }
                    },
                    y2: {
                        position: 'right',
                        ticks: { 
                            color: 'rgba(255, 82, 82, 0.6)', 
                            font: { size: 9 },
                            callback: function(value) { return value + ' bpm'; }
                        },
                        grid: { display: false },
                        min: 60,
                        suggestedMax: 200
                    }
                }
            }
        });
    }

    // Readiness Chart
    if (readinessChartData.dates && readinessChartData.dates.length > 0) {
        new Chart(document.getElementById('readinessChart'), {
            type: 'line',
            data: {
                labels: readinessChartData.dates,
                datasets: [{
                    label: 'Score',
                    data: readinessChartData.morning_score,
                    borderColor: '#0077FF',
                    backgroundColor: 'rgba(0, 119, 255, 0.15)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                ...chartDefaults,
                plugins: { legend: { display: false } },
                scales: {
                    ...chartDefaults.scales,
                    y: { ...chartDefaults.scales.y, min: 0, max: 100 }
                }
            }
        });
    }

    console.log('üö¥ Zyra Cycle v3 initialized');
});
</script>
{% endblock %}
