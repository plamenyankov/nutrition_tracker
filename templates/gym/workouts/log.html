{% extends "layout.html" %}

{% block title %}Log Workout - Gym Tracker{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
/* Modern Mobile-First Design */
:root {
    --primary-color: #007bff;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --dark-color: #343a40;
    --light-color: #f8f9fa;
    --border-radius: 12px;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.workout-container {
    padding: 0;
    max-width: 100%;
}

/* Header */
.workout-header {
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.workout-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
    text-align: center;
}

/* Timer Section */
.timer-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    text-align: center;
    position: relative;
}

.timer-display {
    font-size: 2.5rem;
    font-weight: 300;
    margin: 0.5rem 0;
    font-family: 'SF Mono', Monaco, monospace;
}

.timer-status {
    opacity: 0.8;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.timer-btn {
    background: rgba(255,255,255,0.2);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.timer-btn:hover, .timer-btn:focus {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
    color: white;
    transform: translateY(-2px);
}

.timer-btn.running {
    background: rgba(255,193,7,0.2);
    border-color: rgba(255,193,7,0.5);
}

.timer-btn.paused {
    background: rgba(40,167,69,0.2);
    border-color: rgba(40,167,69,0.5);
}

/* Quick Stats */
.quick-stats {
    background: white;
    padding: 1rem;
    display: flex;
    justify-content: space-around;
    box-shadow: var(--shadow);
}

.stat-item {
    text-align: center;
    flex: 1;
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
    display: block;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Exercise Selection */
.exercise-selector {
    background: white;
    margin: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.selector-header {
    background: var(--light-color);
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.selector-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: var(--dark-color);
}

.selector-body {
    padding: 1rem;
}

.form-floating {
    margin-bottom: 1rem;
}

.form-floating > .form-select,
.form-floating > .form-control {
    border-radius: 10px;
    border: 2px solid #e9ecef;
    padding: 1rem 0.75rem 0.5rem;
    height: auto;
    font-size: 1rem;
    min-height: 56px; /* Ensure good touch target size on mobile */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-floating > .form-select:focus,
.form-floating > .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
}

/* Mobile-specific improvements */
@media (max-width: 768px) {
    .form-floating > .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 1.2rem 0.75rem 0.6rem;
        min-height: 60px;
    }

    .form-floating > label {
        font-size: 0.85rem;
        padding: 1.2rem 0.75rem;
    }

    /* Ensure dropdown options are visible */
    .form-select option {
        padding: 0.5rem;
        font-size: 16px;
    }

    /* Force refresh select rendering on mobile */
    .form-select option[hidden] {
        display: none !important;
    }

    /* Improved mobile layout for sets */
    .set-header {
        flex-wrap: wrap;
    }

    .set-progression-info {
        width: 100%;
        order: 3;
        margin: 0.5rem 0 0 0;
    }

    .set-actions {
        order: 2;
    }

    .progression-status {
        display: block;
        width: 100%;
    }

    .set-inputs {
        gap: 0.5rem;
    }

    .set-input {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 0.6rem;
    }

    .set-btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
        min-width: 48px;
        height: 30px;
    }

    .btn-delete {
        width: 30px;
        height: 30px;
        min-width: 30px;
    }

    .exercise-card {
        margin: 0.75rem;
    }

    .sets-container {
        padding: 0.5rem;
    }

    .set-row {
        padding: 0.6rem;
        margin-bottom: 0.6rem;
    }
}

.form-floating > label {
    padding: 1rem 0.75rem;
    font-size: 0.9rem;
    color: #6c757d;
}

.add-exercise-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    border: none;
    color: white;
    padding: 1rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
}

.add-exercise-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, #0056b3 0%, var(--primary-color) 100%);
}

/* Exercise Cards */
.exercise-card {
    background: white;
    margin: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.exercise-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
}

.exercise-info {
    flex: 1;
}

.exercise-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0 0 0.2rem 0;
    line-height: 1.3;
}

.exercise-history {
    font-size: 0.75rem;
    color: #6c757d;
    margin: 0;
    line-height: 1.2;
}

.progress-badge {
    color: var(--success-color);
    font-weight: 600;
}

.remove-exercise-btn {
    background: var(--danger-color);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.remove-exercise-btn i {
    font-size: 0.75rem;
}

.remove-exercise-btn:hover {
    background: #c82333;
    transform: scale(1.05);
}

/* Set Rows */
.sets-container {
    padding: 0.75rem;
}

.set-row {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
}

.set-row.logged {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border-color: var(--success-color);
}

.set-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.75rem;
    gap: 0.5rem;
}

.set-number {
    font-weight: 700;
    color: var(--dark-color);
    font-size: 0.9rem;
    min-width: 45px;
}

/* Improved Set Progression Styles for Mobile */
.set-progression-info {
    flex: 1;
    font-size: 0.75rem;
    line-height: 1.3;
    overflow: hidden;
}

.progression-status {
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    font-weight: 500;
    text-align: left;
    display: inline-block;
    max-width: 100%;
}

.progression-ready {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.progression-close {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    color: #856404;
    border: 1px solid #ffeaa7;
}

.progression-maintain {
    background: linear-gradient(135deg, #e2e3e5, #d6d8db);
    color: #383d41;
    border: 1px solid #d6d8db;
}

.progression-new {
    background: linear-gradient(135deg, #cce5ff, #b3d9ff);
    color: #004085;
    border: 1px solid #b3d9ff;
}

.progression-error {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.progression-details {
    font-size: 0.65rem;
    margin-top: 0.15rem;
    opacity: 0.85;
    line-height: 1.2;
    word-break: break-word;
}

/* New progression comparison styles */
.progression-header {
    font-size: 0.7rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
    line-height: 1.2;
}

.progression-comparison {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.4rem;
    font-size: 0.65rem;
    line-height: 1.2;
}

.last-performance, .suggested-performance {
    flex: 1;
    text-align: center;
    min-width: 0;
}

.progression-arrow {
    font-size: 0.8rem;
    color: #6c757d;
    flex-shrink: 0;
    margin: 0 0.2rem;
}

.performance-value {
    display: block;
    font-weight: 700;
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Mobile responsive adjustments */
@media (max-width: 576px) {
    .progression-comparison {
        flex-direction: column;
        gap: 0.2rem;
        text-align: center;
    }

    .progression-arrow {
        transform: rotate(90deg);
        margin: 0.1rem 0;
    }

    .last-performance, .suggested-performance {
        width: 100%;
    }

    .performance-value {
        font-size: 0.75rem;
    }
}

.loading-progression {
    color: #6c757d;
    font-style: italic;
    font-size: 0.75rem;
}

.set-actions {
    display: flex;
    gap: 0.25rem;
    margin-left: auto;
    flex-shrink: 0;
}

.set-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.input-group {
    position: relative;
}

.set-input {
    width: 100%;
    padding: 0.6rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    text-align: center;
    transition: all 0.3s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.set-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
}

.set-input:disabled {
    background: transparent;
    color: var(--dark-color);
    opacity: 0.8;
}

.input-label {
    position: absolute;
    top: -8px;
    left: 10px;
    background: #f8f9fa;
    padding: 0 4px;
    font-size: 0.7rem;
    color: #6c757d;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.set-btn {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    font-size: 0.8rem;
    transition: all 0.3s ease;
    min-width: 55px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-save {
    background: var(--success-color);
    color: white;
}

.btn-edit {
    background: var(--warning-color);
    color: var(--dark-color);
}

.btn-delete {
    background: var(--danger-color);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    padding: 0;
    min-width: 32px;
}

.btn-delete i {
    font-size: 0.75rem;
}

.set-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.add-set-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
    border: none;
    color: white;
    padding: 0.75rem;
    border-radius: 10px;
    font-weight: 600;
    width: 100%;
    margin-top: 0.5rem;
    transition: all 0.3s ease;
}

.add-set-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

/* Bottom Actions */
.bottom-actions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 1rem;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    display: flex;
    gap: 1rem;
    z-index: 50;
}

.action-btn {
    flex: 1;
    padding: 1rem;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.btn-cancel {
    background: #6c757d;
    color: white;
}

.btn-finish {
    background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.action-btn:disabled {
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

/* Notes Section */
.notes-section {
    background: white;
    margin: 1rem;
    margin-bottom: 100px; /* Space for bottom actions */
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.notes-header {
    background: var(--light-color);
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
}

.notes-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: var(--dark-color);
}

.notes-body {
    padding: 1rem;
}

.notes-textarea {
    width: 100%;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    font-size: 1rem;
    resize: vertical;
    min-height: 100px;
    transition: all 0.3s ease;
}

.notes-textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    outline: none;
}

/* Progress Badge */
.progress-badge {
    background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

/* Loading States */
.loading {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-size: 0.85rem;
}

.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #e9ecef;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (min-width: 768px) {
    .workout-container {
        max-width: 600px;
        margin: 0 auto;
    }

    .bottom-actions {
        position: relative;
        box-shadow: none;
        margin: 1rem;
        border-radius: var(--border-radius);
    }

    .notes-section {
        margin-bottom: 1rem;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    :root {
        --light-color: #2d3748;
        --dark-color: #f7fafc;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="workout-container">
    <!-- Header -->
    <div class="workout-header">
        <h1 class="workout-title">üí™ Log Workout</h1>
    </div>

    <!-- Timer Section -->
    <div class="timer-section">
        <div class="timer-display" id="workout-timer">00:00:00</div>
        <div class="timer-status" id="timer-status">Ready to start</div>
        <button id="timer-toggle" class="timer-btn">
            <i class="fas fa-play"></i> Start Timer
        </button>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-item">
            <span class="stat-number" id="exercise-count">0</span>
            <span class="stat-label">Exercises</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="total-sets">0</span>
            <span class="stat-label">Sets</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="workout-date"></span>
            <span class="stat-label">Date</span>
        </div>
    </div>

    <!-- Exercise Selection -->
    <div class="exercise-selector">
        <div class="selector-header">
            <h3 class="selector-title">üéØ Add Exercise</h3>
        </div>
        <div class="selector-body">
            <div class="form-floating">
                <select id="muscle-group-filter" class="form-select">
                    <option value="">All Muscle Groups</option>
                    {% set muscle_groups = [] %}
                    {% for exercise in exercises %}
                        {% if exercise[2] and exercise[2] not in muscle_groups %}
                            {% set _ = muscle_groups.append(exercise[2]) %}
                        {% endif %}
                    {% endfor %}
                    {% for muscle_group in muscle_groups|sort %}
                        <option value="{{ muscle_group }}">{{ muscle_group }}</option>
                    {% endfor %}
                </select>
                <label for="muscle-group-filter">Filter by Muscle Group</label>
            </div>

            <div class="form-floating">
                <select id="exercise-select" class="form-select">
                    <option value="">Choose an exercise...</option>
                    {% for exercise in exercises %}
                        <option value="{{ exercise[0] }}" data-muscle-group="{{ exercise[2] or '' }}">
                            {{ exercise[1] }}{% if exercise[2] %} ({{ exercise[2] }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
                <label for="exercise-select">Select Exercise</label>
            </div>

            <button id="add-exercise-btn" class="add-exercise-btn">
                <i class="fas fa-plus"></i> Add Exercise
            </button>
        </div>
    </div>

    <!-- Active Exercises Container -->
    <div id="exercises-container"></div>

    <!-- Notes Section -->
    <div class="notes-section">
        <div class="notes-header">
            <h3 class="notes-title">üìù Workout Notes</h3>
        </div>
        <div class="notes-body">
            <textarea id="workout-notes" class="notes-textarea" placeholder="How did the workout feel? Any observations or goals for next time..."></textarea>
        </div>
    </div>

    <!-- Bottom Actions -->
    <div class="bottom-actions">
        <a href="{{ url_for('gym.dashboard') }}" class="action-btn btn-cancel">
            <i class="fas fa-times"></i> Cancel
        </a>
        <button id="finish-workout" class="action-btn btn-finish" disabled>
            <i class="fas fa-check"></i> Finish Workout
        </button>
    </div>
</div>

<script>
let sessionId = null;
let exerciseData = {};
let totalSets = 0;

// Timer variables
let workoutStartTime = null;
let timerInterval = null;
let isTimerRunning = false;
let isPaused = false;
let pausedTime = 0;
let pauseStartTime = null;
let lastSetTime = null;

// Set today's date
document.getElementById('workout-date').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

// Muscle group filter with improved mobile support
document.getElementById('muscle-group-filter').addEventListener('change', function() {
    const selectedGroup = this.value.trim();
    const exerciseSelect = document.getElementById('exercise-select');
    const options = exerciseSelect.querySelectorAll('option[data-muscle-group]');

    // Clear current selection if it will be hidden
    if (exerciseSelect.value && exerciseSelect.selectedOptions[0]) {
        const currentOptionGroup = (exerciseSelect.selectedOptions[0].dataset.muscleGroup || '').trim();
        if (selectedGroup !== '' && currentOptionGroup !== selectedGroup) {
            exerciseSelect.value = '';
        }
    }

    // Filter options
    let visibleCount = 0;
    options.forEach(option => {
        const optionGroup = (option.dataset.muscleGroup || '').trim();
        const shouldShow = selectedGroup === '' || optionGroup === selectedGroup;

        if (shouldShow) {
            option.style.display = '';
            option.hidden = false;
            visibleCount++;
        } else {
            option.style.display = 'none';
            option.hidden = true;
        }
    });

    // Force refresh of select element for mobile devices
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // Create a small delay to ensure DOM updates are processed
        setTimeout(() => {
            exerciseSelect.blur();
            exerciseSelect.focus();
        }, 10);
    }

    console.log(`Filtered exercises: ${visibleCount} visible out of ${options.length} total`);
});

// Add exercise button click
document.getElementById('add-exercise-btn').addEventListener('click', function() {
    const select = document.getElementById('exercise-select');
    const exerciseId = select.value;

    if (!exerciseId) {
        showToast('Please select an exercise', 'warning');
        return;
    }

    if (exerciseData[exerciseId]) {
        showToast('This exercise has already been added', 'warning');
        return;
    }

    const exerciseName = select.options[select.selectedIndex].text;
    addExerciseCard(exerciseId, exerciseName);
    select.value = '';

    // Scroll to the new exercise
    setTimeout(() => {
        document.getElementById(`exercise-${exerciseId}`).scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    }, 100);
});

function addExerciseCard(exerciseId, exerciseName) {
    exerciseData[exerciseId] = {
        name: exerciseName,
        sets: []
    };

    const exerciseCard = document.createElement('div');
    exerciseCard.className = 'exercise-card';
    exerciseCard.id = `exercise-${exerciseId}`;
    exerciseCard.innerHTML = `
        <div class="exercise-header">
            <div class="exercise-info">
                <h4 class="exercise-name">${exerciseName}</h4>
                <p class="exercise-history" id="progression-info-${exerciseId}">
                    <span class="loading">
                        <span class="spinner"></span>
                        Loading history...
                    </span>
                </p>
            </div>
            <button class="remove-exercise-btn" data-exercise-id="${exerciseId}">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sets-container" id="sets-${exerciseId}">
            <button class="add-set-btn" data-exercise-id="${exerciseId}">
                <i class="fas fa-plus"></i> Add Set
            </button>
        </div>
    `;

    document.getElementById('exercises-container').appendChild(exerciseCard);

    // Fetch progression info
    fetch(`/gym/exercise/${exerciseId}/quick-progression`)
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById(`progression-info-${exerciseId}`);
            if (data.has_history) {
                let infoHtml = `Last: ${data.last_weight}kg √ó ${data.last_reps} reps`;
                if (data.ready_for_progression) {
                    infoHtml += ' <span class="progress-badge"><i class="fas fa-arrow-up"></i> Ready to progress!</span>';
                }
                infoDiv.innerHTML = infoHtml;
            } else {
                infoDiv.innerHTML = 'üÜï No previous history';
            }
        })
        .catch(error => {
            document.getElementById(`progression-info-${exerciseId}`).innerHTML = 'üìä History unavailable';
        });

    // Add event listeners
    exerciseCard.querySelector('.remove-exercise-btn').addEventListener('click', function() {
        removeExercise(exerciseId);
    });

    exerciseCard.querySelector('.add-set-btn').addEventListener('click', function() {
        addSetRow(exerciseId);
    });

    // Add first set automatically
    addSetRow(exerciseId);
    updateSummary();
}

function addSetRow(exerciseId) {
    const setNumber = exerciseData[exerciseId].sets.length + 1;
    const setId = `${exerciseId}-${setNumber}`;

    const setDiv = document.createElement('div');
    setDiv.className = 'set-row';
    setDiv.id = `set-${setId}`;
    setDiv.innerHTML = `
        <div class="set-header">
            <span class="set-number">Set ${setNumber}</span>
            <div class="set-progression-info" id="progression-${setId}">
                <span class="loading-progression">Loading suggestions...</span>
            </div>
            <div class="set-actions">
                <button class="set-btn btn-save" data-set-id="${setId}" data-exercise-id="${exerciseId}">
                    <i class="fas fa-check"></i>
                    <span class="d-none d-sm-inline">Save</span>
                </button>
                <button class="set-btn btn-edit d-none" data-set-id="${setId}">
                    <i class="fas fa-edit"></i>
                    <span class="d-none d-sm-inline">Edit</span>
                </button>
                <button class="set-btn btn-delete" data-set-id="${setId}" data-exercise-id="${exerciseId}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="set-inputs">
            <div class="input-group">
                <label class="input-label">Weight (kg)</label>
                <input type="number" class="set-input weight-input"
                       placeholder="0" step="0.5" min="0" id="weight-${setId}">
            </div>
            <div class="input-group">
                <label class="input-label">Reps</label>
                <input type="number" class="set-input reps-input"
                       placeholder="0" min="1" id="reps-${setId}">
            </div>
        </div>
    `;

    // Insert before the add set button
    const addSetBtn = document.querySelector(`#sets-${exerciseId} .add-set-btn`);
    addSetBtn.parentNode.insertBefore(setDiv, addSetBtn);

    // Fetch set-specific progression suggestions
    fetchSetProgression(exerciseId, setNumber, setId);

    // Add event listeners
    setDiv.querySelector('.btn-save').addEventListener('click', function() {
        saveSet(exerciseId, setId, setNumber);
    });

    setDiv.querySelector('.btn-edit').addEventListener('click', function() {
        editSet(setId);
    });

    setDiv.querySelector('.btn-delete').addEventListener('click', function() {
        deleteSetRow(exerciseId, setId);
    });

    // Focus on weight input
    setDiv.querySelector('.weight-input').focus();
}

function fetchSetProgression(exerciseId, setNumber, setId) {
    fetch(`/gym/exercise/${exerciseId}/set-specific-progression/${setNumber}`)
        .then(response => response.json())
        .then(data => {
            const progressionDiv = document.getElementById(`progression-${setId}`);
            const weightInput = document.getElementById(`weight-${setId}`);
            const repsInput = document.getElementById(`reps-${setId}`);

            if (data.has_history) {
                // Update input values with suggestions
                if (weightInput && data.current_weight) {
                    weightInput.value = data.current_weight;
                    if (data.suggested_weight && data.ready) {
                        weightInput.value = data.suggested_weight;
                    }
                }
                if (repsInput) {
                    if (data.suggested_reps) {
                        repsInput.value = data.suggested_reps;
                    } else if (data.target_reps) {
                        repsInput.value = data.target_reps;
                    }
                }

                // Create progression info display based on suggestion type
                let progressionHTML = '';
                let statusClass = '';
                let statusIcon = '';

                if (data.ready && data.suggestion === 'increase_weight') {
                    statusClass = 'progression-ready';
                    statusIcon = 'üî•';
                    progressionHTML = `
                        <div class="progression-status ${statusClass}">
                            <div class="progression-header">
                                ${statusIcon} Ready to progress!
                            </div>
                            <div class="progression-comparison">
                                <div class="last-performance">
                                    <small class="text-muted">Last time:</small>
                                    <span class="performance-value">${data.last_weight}kg √ó ${data.last_reps}</span>
                                </div>
                                <div class="progression-arrow">‚Üí</div>
                                <div class="suggested-performance">
                                    <small class="text-success">Try:</small>
                                    <span class="performance-value text-success">${data.suggested_weight}kg √ó ${data.suggested_reps}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (data.suggestion === 'build_strength') {
                    statusClass = 'progression-close';
                    statusIcon = 'üí™';
                    progressionHTML = `
                        <div class="progression-status ${statusClass}">
                            <div class="progression-header">
                                ${statusIcon} Keep building strength
                            </div>
                            <div class="progression-comparison">
                                <div class="last-performance">
                                    <small class="text-muted">Last time:</small>
                                    <span class="performance-value">${data.last_weight}kg √ó ${data.last_reps}</span>
                                </div>
                                <div class="progression-arrow">‚Üí</div>
                                <div class="suggested-performance">
                                    <small class="text-primary">Target:</small>
                                    <span class="performance-value text-primary">${data.current_weight}kg √ó ${data.suggested_reps || data.current_avg_reps}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (data.suggestion === 'almost_ready') {
                    statusClass = 'progression-close';
                    statusIcon = 'üìà';
                    progressionHTML = `
                        <div class="progression-status ${statusClass}">
                            <div class="progression-header">
                                ${statusIcon} Almost ready!
                            </div>
                            <div class="progression-comparison">
                                <div class="last-performance">
                                    <small class="text-muted">Last time:</small>
                                    <span class="performance-value">${data.last_weight}kg √ó ${data.last_reps}</span>
                                </div>
                                <div class="progression-arrow">‚Üí</div>
                                <div class="suggested-performance">
                                    <small class="text-warning">Need:</small>
                                    <span class="performance-value text-warning">${data.current_weight}kg √ó ${data.target_reps}</span>
                                    <small class="text-muted">(${data.reps_to_go} more reps)</small>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (data.suggestion === 'build_reps') {
                    statusClass = 'progression-maintain';
                    statusIcon = 'üí™';
                    progressionHTML = `
                        <div class="progression-status ${statusClass}">
                            <div class="progression-header">
                                ${statusIcon} Build up reps
                            </div>
                            <div class="progression-comparison">
                                <div class="last-performance">
                                    <small class="text-muted">Last time:</small>
                                    <span class="performance-value">${data.last_weight}kg √ó ${data.last_reps}</span>
                                </div>
                                <div class="progression-arrow">‚Üí</div>
                                <div class="suggested-performance">
                                    <small class="text-info">Target:</small>
                                    <span class="performance-value text-info">${data.current_weight}kg √ó ${data.target_reps}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusClass = 'progression-maintain';
                    statusIcon = 'üí™';
                    progressionHTML = `
                        <div class="progression-status ${statusClass}">
                            <div class="progression-header">
                                ${statusIcon} Keep going
                            </div>
                            <div class="progression-comparison">
                                <div class="last-performance">
                                    <small class="text-muted">Last time:</small>
                                    <span class="performance-value">${data.last_weight}kg √ó ${data.last_reps}</span>
                                </div>
                                <div class="progression-arrow">‚Üí</div>
                                <div class="suggested-performance">
                                    <small class="text-secondary">Try:</small>
                                    <span class="performance-value text-secondary">${data.suggested_weight}kg √ó ${data.suggested_reps}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                progressionDiv.innerHTML = progressionHTML;
            } else {
                // No history available
                progressionDiv.innerHTML = `
                    <div class="progression-status progression-new">
                        ‚ú® First time doing set ${setNumber}
                    </div>
                `;

                // Set default values
                if (weightInput && setNumber > 1) {
                    // For subsequent sets, try to get weight from previous set
                    const prevSetId = `${exerciseId}-${setNumber - 1}`;
                    const prevWeightInput = document.getElementById(`weight-${prevSetId}`);
                    if (prevWeightInput && prevWeightInput.value) {
                        weightInput.value = prevWeightInput.value;
                    }
                }
                if (repsInput) {
                    repsInput.value = 10; // Default reps
                }
            }
        })
        .catch(error => {
            console.error('Error fetching set progression data:', error);
            const progressionDiv = document.getElementById(`progression-${setId}`);
            progressionDiv.innerHTML = `
                <div class="progression-status progression-error">
                    ‚ö†Ô∏è Unable to load suggestions
                </div>
            `;
        });
}

function saveSet(exerciseId, setId, setNumber) {
    const weight = document.getElementById(`weight-${setId}`).value;
    const reps = document.getElementById(`reps-${setId}`).value;

    if (!weight || !reps) {
        showToast('Please enter both weight and reps', 'warning');
        return;
    }

    // Show loading state
    const saveBtn = document.querySelector(`[data-set-id="${setId}"].btn-save`);
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner"></span>';
    saveBtn.disabled = true;

    const existingSet = exerciseData[exerciseId].sets.find(s => s.localId === setId);
    const isUpdate = existingSet && existingSet.logged;

    if (isUpdate && existingSet.dbId) {
        // Update existing set
        fetch('/gym/workout/update-set', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                set_id: existingSet.dbId,
                weight: parseFloat(weight),
                reps: parseInt(reps)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                existingSet.weight = parseFloat(weight);
                existingSet.reps = parseInt(reps);
                lockSet(setId);
                updateSummary();
                showToast('Set updated!', 'success');
            } else {
                showToast('Error updating set: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .finally(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    } else {
        // Calculate set duration
        let setDuration = 0;
        if (isTimerRunning && lastSetTime) {
            const now = new Date();
            const timeSinceLastSet = Math.floor((now - lastSetTime) / 1000);

            if (isPaused && pauseStartTime) {
                const currentPauseDuration = Math.floor((now - pauseStartTime) / 1000);
                setDuration = Math.max(0, timeSinceLastSet - currentPauseDuration);
            } else {
                setDuration = timeSinceLastSet;
            }
        }

        // Log new set
        fetch('/gym/workout/log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                exercise_id: exerciseId,
                set_number: setNumber,
                weight: parseFloat(weight),
                reps: parseInt(reps),
                duration_seconds: setDuration
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sessionId = data.session_id;
                lastSetTime = new Date();

                if (!existingSet) {
                    exerciseData[exerciseId].sets.push({
                        localId: setId,
                        dbId: null,
                        weight: parseFloat(weight),
                        reps: parseInt(reps),
                        logged: true
                    });
                    totalSets++;
                } else {
                    existingSet.logged = true;
                    existingSet.weight = parseFloat(weight);
                    existingSet.reps = parseInt(reps);
                }

                lockSet(setId);
                updateSummary();
                document.getElementById('finish-workout').disabled = false;
                showToast(`üí™ Set logged: ${weight}kg √ó ${reps} reps`, 'success');
            } else {
                showToast('Error logging set: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .finally(() => {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }
}

function lockSet(setId) {
    const setDiv = document.getElementById(`set-${setId}`);
    setDiv.classList.add('logged');

    // Disable inputs
    setDiv.querySelector('.weight-input').disabled = true;
    setDiv.querySelector('.reps-input').disabled = true;

    // Toggle buttons
    setDiv.querySelector('.btn-save').classList.add('d-none');
    setDiv.querySelector('.btn-edit').classList.remove('d-none');
}

function editSet(setId) {
    const setDiv = document.getElementById(`set-${setId}`);
    setDiv.classList.remove('logged');

    // Enable inputs
    setDiv.querySelector('.weight-input').disabled = false;
    setDiv.querySelector('.reps-input').disabled = false;

    // Toggle buttons
    setDiv.querySelector('.btn-save').classList.remove('d-none');
    setDiv.querySelector('.btn-edit').classList.add('d-none');

    setDiv.querySelector('.weight-input').focus();
}

function deleteSetRow(exerciseId, setId) {
    if (confirm('Delete this set?')) {
        const set = exerciseData[exerciseId].sets.find(s => s.localId === setId);

        if (set && set.logged && set.dbId) {
            fetch('/gym/workout/delete-set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ set_id: set.dbId })
            });
        }

        exerciseData[exerciseId].sets = exerciseData[exerciseId].sets.filter(s => s.localId !== setId);
        if (set && set.logged) {
            totalSets--;
        }

        document.getElementById(`set-${setId}`).remove();
        renumberSets(exerciseId);
        updateSummary();
        showToast('Set deleted', 'info');
    }
}

function removeExercise(exerciseId) {
    if (confirm('Remove this exercise and all its sets?')) {
        totalSets -= exerciseData[exerciseId].sets.length;
        delete exerciseData[exerciseId];
        document.getElementById(`exercise-${exerciseId}`).remove();
        updateSummary();
        showToast('Exercise removed', 'info');
    }
}

function renumberSets(exerciseId) {
    const setDivs = document.querySelectorAll(`#sets-${exerciseId} .set-row`);
    setDivs.forEach((div, index) => {
        div.querySelector('.set-number').textContent = `Set ${index + 1}`;
    });
}

function updateSummary() {
    document.getElementById('exercise-count').textContent = Object.keys(exerciseData).length;
    document.getElementById('total-sets').textContent = totalSets;
}

// Timer functions
function startWorkoutTimer() {
    if (!sessionId) {
        fetch('/gym/workout/log', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: null,
                exercise_id: null,
                set_number: 0,
                weight: 0,
                reps: 0,
                create_session_only: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sessionId = data.session_id;
                startTimerWithSession();
            } else {
                showToast('Error creating workout session: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error creating session:', error);
            showToast('Error creating workout session', 'error');
        });
    } else {
        startTimerWithSession();
    }
}

function startTimerWithSession() {
    workoutStartTime = new Date();
    lastSetTime = new Date();
    isTimerRunning = true;
    isPaused = false;
    pausedTime = 0;

    const toggleBtn = document.getElementById('timer-toggle');
    toggleBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
    toggleBtn.className = 'timer-btn running';
    document.getElementById('timer-status').textContent = 'Workout in progress';

    document.getElementById('finish-workout').disabled = false;

    timerInterval = setInterval(updateTimerDisplay, 1000);
    updateTimerDisplay();

    fetch('/api/timer/workout/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: sessionId,
            notes: 'Timer started from workout log'
        })
    })
    .catch(error => {
        console.error('Error updating database with start time:', error);
    });
}

function pauseWorkoutTimer() {
    if (!isTimerRunning || isPaused) return;

    isPaused = true;
    pauseStartTime = new Date();

    const toggleBtn = document.getElementById('timer-toggle');
    toggleBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
    toggleBtn.className = 'timer-btn paused';
    document.getElementById('timer-status').textContent = 'Paused';
}

function resumeWorkoutTimer() {
    if (!isTimerRunning || !isPaused) return;

    const pauseDuration = Math.floor((new Date() - pauseStartTime) / 1000);
    pausedTime += pauseDuration;

    isPaused = false;

    const toggleBtn = document.getElementById('timer-toggle');
    toggleBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
    toggleBtn.className = 'timer-btn running';
    document.getElementById('timer-status').textContent = 'Workout in progress';
}

function stopWorkoutTimer() {
    if (!sessionId) return;

    isTimerRunning = false;
    isPaused = false;
    clearInterval(timerInterval);

    const toggleBtn = document.getElementById('timer-toggle');
    toggleBtn.innerHTML = '<i class="fas fa-check"></i> Completed';
    toggleBtn.className = 'timer-btn';
    toggleBtn.disabled = true;
    document.getElementById('timer-status').textContent = 'Completed';

    fetch('/api/timer/workout/complete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: sessionId
        })
    })
    .catch(error => {
        console.error('Error updating database with completion:', error);
    });
}

function updateTimerDisplay() {
    if (!workoutStartTime) return;

    let elapsed;
    if (isPaused) {
        elapsed = Math.max(0, Math.floor((pauseStartTime - workoutStartTime) / 1000) - pausedTime);
    } else {
        const now = new Date();
        elapsed = Math.max(0, Math.floor((now - workoutStartTime) / 1000) - pausedTime);
    }

    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;

    const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('workout-timer').textContent = timeString;
}

// Timer toggle event listener
document.getElementById('timer-toggle').addEventListener('click', function() {
    if (!isTimerRunning) {
        startWorkoutTimer();
    } else if (isPaused) {
        resumeWorkoutTimer();
    } else {
        pauseWorkoutTimer();
    }
});

// Finish workout
document.getElementById('finish-workout').addEventListener('click', function() {
    if (!sessionId) {
        showToast('No workout session to complete. Please start the timer or log at least one set.', 'warning');
        return;
    }

    if (confirm('Are you sure you want to finish this workout?')) {
        if (isTimerRunning) {
            stopWorkoutTimer();
        }

        const notes = document.getElementById('workout-notes').value.trim();

        if (notes) {
            fetch('/gym/workout/update-notes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    workout_id: sessionId,
                    notes: notes
                })
            }).then(() => {
                return fetch(`/gym/workout/${sessionId}/complete`, {
                    method: 'POST'
                });
            }).then(() => {
                showToast('üéâ Workout completed!', 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("gym.history") }}';
                }, 1500);
            });
        } else {
            fetch(`/gym/workout/${sessionId}/complete`, {
                method: 'POST'
            }).then(() => {
                showToast('üéâ Workout completed!', 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("gym.history") }}';
                }, 1500);
            });
        }
    }
});

// Toast notification system
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <span class="toast-message">${message}</span>
            <button class="toast-close">&times;</button>
        </div>
    `;

    // Add toast styles if not already added
    if (!document.getElementById('toast-styles')) {
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            .toast-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            }
            .toast-content {
                padding: 1rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.5rem;
            }
            .toast-message {
                flex: 1;
                font-size: 0.9rem;
                font-weight: 500;
            }
            .toast-close {
                background: none;
                border: none;
                font-size: 1.2rem;
                cursor: pointer;
                opacity: 0.7;
            }
            .toast-success { border-left: 4px solid var(--success-color); }
            .toast-error { border-left: 4px solid var(--danger-color); }
            .toast-warning { border-left: 4px solid var(--warning-color); }
            .toast-info { border-left: 4px solid var(--primary-color); }
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);

    // Manual close
    toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.remove();
    });
}
</script>
{% endblock %}
